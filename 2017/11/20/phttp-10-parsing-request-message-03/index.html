<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon_package_v0.16/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_package_v0.16/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_package_v0.16/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon_package_v0.16/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/favicon_package_v0.16/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"haah.kr","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="연재글 전체 보기  지난 시간에 우리는..이전 글에서 HTTP 메시지를 줄단위로 끊고 첫 요소에서 시작줄을 파싱하는 것까지 진행했다.  이제 슬슬 길어져 보기 힘드니까…여기서 확인 테스트 코드는 멀쩡한 코드인가?여기까지는 최소한으로 받아들일 수 있는 HTTP 메시지의 형식을 제한했다. 그런데 이게 테스트 케이스로써 어떤 가치가 있는지 생각해보게 됐다. 스스">
<meta property="og:type" content="blog">
<meta property="og:title" content="PHP로 HTTP 서버 구현하기 - 10 - 요청 메시지 파싱 3">
<meta property="og:url" content="https://haah.kr/2017/11/20/phttp-10-parsing-request-message-03/">
<meta property="og:site_name" content="ha-ah">
<meta property="og:description" content="연재글 전체 보기  지난 시간에 우리는..이전 글에서 HTTP 메시지를 줄단위로 끊고 첫 요소에서 시작줄을 파싱하는 것까지 진행했다.  이제 슬슬 길어져 보기 힘드니까…여기서 확인 테스트 코드는 멀쩡한 코드인가?여기까지는 최소한으로 받아들일 수 있는 HTTP 메시지의 형식을 제한했다. 그런데 이게 테스트 케이스로써 어떤 가치가 있는지 생각해보게 됐다. 스스">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-11-20T10:27:12.000Z">
<meta property="article:modified_time" content="2018-02-13T06:27:02.000Z">
<meta property="article:author" content="youngiggy">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="HTTP">
<meta property="article:tag" content="phttp">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://haah.kr/2017/11/20/phttp-10-parsing-request-message-03/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://haah.kr/2017/11/20/phttp-10-parsing-request-message-03/","path":"2017/11/20/phttp-10-parsing-request-message-03/","title":"PHP로 HTTP 서버 구현하기 - 10 - 요청 메시지 파싱 3"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>PHP로 HTTP 서버 구현하기 - 10 - 요청 메시지 파싱 3 | ha-ah</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=354302543"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":354302543,"only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="ha-ah" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ha-ah</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">로그, 게으른 로그</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%A7%80%EB%82%9C-%EC%8B%9C%EA%B0%84%EC%97%90-%EC%9A%B0%EB%A6%AC%EB%8A%94"><span class="nav-number">1.</span> <span class="nav-text">지난 시간에 우리는..</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C%EB%8A%94-%EB%A9%80%EC%A9%A1%ED%95%9C-%EC%BD%94%EB%93%9C%EC%9D%B8%EA%B0%80"><span class="nav-number">2.</span> <span class="nav-text">테스트 코드는 멀쩡한 코드인가?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Blacklist-vs-Whitelist"><span class="nav-number">3.</span> <span class="nav-text">Blacklist vs Whitelist</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#header-%EB%AA%A8%EC%9C%BC%EA%B8%B0"><span class="nav-number">4.</span> <span class="nav-text">header 모으기</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EB%8B%A4%EC%8B%9C-%EC%8B%A4%ED%8C%A8-%EC%84%B1%EA%B3%B5-%EB%A6%AC%ED%8C%A9%ED%86%A0%EB%A7%81%EC%9D%98-%EA%B6%A4%EB%8F%84-%EC%95%88%EC%9C%BC%EB%A1%9C"><span class="nav-number">5.</span> <span class="nav-text">다시 실패-성공-리팩토링의 궤도 안으로</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Message-Body"><span class="nav-number">6.</span> <span class="nav-text">Message Body</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EA%B2%B0%EB%A1%A0"><span class="nav-number">7.</span> <span class="nav-text">결론</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">youngiggy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:youngiggy@gmail.com" title="E-Mail → mailto:youngiggy@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/profile.php?id=100001259884599" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100001259884599" rel="noopener me" target="_blank"><i class="fab fa-facebook fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.instagram.com/jooyoungiggy" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;jooyoungiggy" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/11/20/phttp-10-parsing-request-message-03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="PHP로 HTTP 서버 구현하기 - 10 - 요청 메시지 파싱 3 | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PHP로 HTTP 서버 구현하기 - 10 - 요청 메시지 파싱 3
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-11-20 19:27:12" itemprop="dateCreated datePublished" datetime="2017-11-20T19:27:12+09:00">2017-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/11/20/phttp-10-parsing-request-message-03/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/11/20/phttp-10-parsing-request-message-03/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h2 id="지난-시간에-우리는"><a href="#지난-시간에-우리는" class="headerlink" title="지난 시간에 우리는.."></a>지난 시간에 우리는..</h2><p>이전 글에서 HTTP 메시지를 줄단위로 끊고 첫 요소에서 시작줄을 파싱하는 것까지 진행했다. </p>
<p>이제 슬슬 길어져 보기 힘드니까…<a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp/tree/936aca2b701b7827c638974e1c477cfaa405b641">여기</a>서 확인</p>
<h2 id="테스트-코드는-멀쩡한-코드인가"><a href="#테스트-코드는-멀쩡한-코드인가" class="headerlink" title="테스트 코드는 멀쩡한 코드인가?"></a>테스트 코드는 멀쩡한 코드인가?</h2><p>여기까지는 최소한으로 받아들일 수 있는 HTTP 메시지의 형식을 제한했다.</p>
<p>그런데 이게 테스트 케이스로써 어떤 가치가 있는지 생각해보게 됐다.</p>
<p>스스로에게 이번 프로젝트에 TDD를 도입한 이유를 물어본다면</p>
<ul>
<li>자동화된 테스트는 내가 방금 수정한 코드에 문제가 있는지 매우 빠르게 피드백을 준다 </li>
<li>테스트로부터 테스트 대상을 어떻게 사용할 수 있는지 알 수 있기 때문에 그 자체로 살아있는 기능 정의서가 된다</li>
</ul>
<p>크게 이정도 생각난다(사실 어디서 주워들었다). 더 있다면 누군가 댓글을 달아주겠지.</p>
<p>이외에도 단위테스트를 작성하면서 얻을 수 있는 효과는 많지만, 저 둘을 가장 근본적인 목적으로 꼽겠다, 나는.</p>
<p>자동화된 테스트가 즉각 피드백을 주는 것은 앞서 꾸준히 증명이 됐다고 본다.</p>
<p>그럼,</p>
<p>지금까지의 테스트 코드가 <code>HttpMessageParser</code>의 사용법을 올바르게 노출하고 있을까? </p>
<p><code>HttpMessageParser</code>를 사용하는 곳은 아직까지 2곳으로 예상된다. 이들은 <code>HttpMessageParser</code>의 서비스를 이용하는 클라이언트가 된다.  </p>
<p>일단 테스트 코드가 첫번째 손님이 됐고, 앞으로 테스트 코드가 충분히 cover하게 되면 <code>Request</code>도 곧 클라이언트가 된다. (기억이…나시는가?)</p>
<p>당신이 <code>Request</code>든 뭐든 HTTP 메시지를 파싱해서 지지고 볶는 기능을 만든다고 생각하고, 막 테스트 코드를 열었을 때 어떤 모양인지 살펴보자.</p>
<p><code>HttpMessageParser</code>는 <code>HttpMessageParserTest</code>의 테스트 코드로 미루어 보건대, 어떤 기능을 담고 있는가?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParserTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReturnValue</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$goodMsg</span> = <span class="string">&#x27;GET / HTTP/1.1&#x27;</span>;</span><br><span class="line">        <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$goodMsg</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="literal">true</span>, <span class="title function_ invoke__">is_array</span>(<span class="variable">$result</span>));</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$requiredFields</span> = [</span><br><span class="line">            <span class="string">&#x27;start_line&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uri&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;headers&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;body&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$requiredFields</span> <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="variable">$field</span>, <span class="variable">$result</span>, <span class="string">&#x27;key &quot;&#x27;</span> . <span class="variable">$field</span> . <span class="string">&#x27;&quot; does not exist&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">badMessages</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            [<span class="string">&#x27;&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;haha&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;GET 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;POST 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD / 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD /index 셋&#x27;</span>],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dataProvider</span> badMessages</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidMessageCausesException</span>(<span class="params"><span class="variable">$badMsg</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$badMsg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>‘GET &#x2F; HTTP&#x2F;1.1’라는 문자열을 전달한 후, <code>getResult()</code>를 호출하면</li>
</ol>
<ul>
<li>그 결과물은 반드시 배열이다</li>
<li>‘start_line’, ‘method’, ‘uri’, ‘version’, ‘headers’, ‘body’의 키가 반드시 존재한다</li>
</ul>
<ol>
<li>7개의 불량한 문자열을 넘기면 예외가 발생한다</li>
</ol>
<ul>
<li>‘’, ‘haha’, ‘GET 둘 셋’, ‘POST 둘 셋’, ‘HEAD 둘 셋’, ‘HEAD &#x2F; 셋’, ‘HEAD &#x2F;index 셋’</li>
</ul>
<p>1번 기능을 통해 우리가 원했던 대로 리턴이 되는 것을 확인할 수는 있지만, ‘GET &#x2F; HTTP&#x2F;1.1’이라는 문자열이 왜 통과하는 지는 알 수가 없다.</p>
<p>이게 통과하는 이유는 2번 테스트를 통해 유추가 가능한데, 7개의 패턴에 속하지 않기 때문이다.</p>
<p>테스트를 열심히 만들 때는 그 과정이 매우 자연스럽다고 생각했는데, 만들어 놓은 테스트를 보니 구멍이 많아 보인다. </p>
<p>누군가 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/ko/docs/Web/HTTP/Methods/OPTIONS">OPTIONS</a>라는 메소드를 허용하도록 <code>HttpMessageParser</code>를 변경했다고 치자.</p>
<p>이때 <code>$supportMethods</code>에 ‘OPTIONS’라고 추가하면 검증 기능은 잘 동작할 것이다. </p>
<p>그리고 테스트 코드를 수정하지 않아도 당연히 테스트는 통과한다.</p>
<p>하지만 나중에 ‘OPTIONS’에 관한 기능을 수정할 땐 테스트의 가호를 받을 수 없다.</p>
<p>이에 문제를 인식한 그 누군가는 ‘OPTIONS’를 <code>testReturnValue()</code>쪽에 넣어 테스트를 돌려볼 수도 있고, <code>badMessages()</code>쪽에 몇가지 케이스를 추가할 수도 있다.</p>
<p>역시 테스트 코드는 잘 돌아갈 것이다.</p>
<p>그리고 여전히 테스트 코드만 봐선 OPTIONS를 쓸 수 있는 지 한 눈에 보이지 않는다. 지원 가능한 옵션이 늘어날 수록 테스트코드는 복잡해지고 유지보수하기 어려워진다.</p>
<p>열심히만 살아온 것 같은데, 왜 이런 시련이 왔을까?</p>
<h2 id="Blacklist-vs-Whitelist"><a href="#Blacklist-vs-Whitelist" class="headerlink" title="Blacklist vs Whitelist"></a>Blacklist vs Whitelist</h2><p>우리(내가 작성해놓고 우리라니…)의 테스트에 어떤 문제가 있었는지 돌아보자.</p>
<p>우선 시작줄의 세 영역을 한번에 테스트하는 것이 마음에 걸린다.</p>
<p><code>badMessages()</code>라는 메소드엔 불량한 시작줄만 들어있으므로 적당한 메소드명도 아닌 것 같다. </p>
<p>그리고 테스트의 대부분이 blacklist에 기반한다.</p>
<p>즉, 어떤 패턴을 사용할 수 있는지보다는 어떤 걸 쓰면 문제가 생기는지 알 수 있다.</p>
<p>(아이를 키우다보면 하지말라는 말만 하게 되는데, 그 영향인가…)</p>
<p>이런 테스트로 지탱하는 시스템이라면 새로운 기능이 생겼을 때 하지 말아야 할 패턴을 만들어야 하는 난관에 봉착한다.</p>
<p>그래서 whitelist를 기반으로 <code>HttpMessageParser</code>에서 뭘 할 수 있는지 테스트를 바꿔보려 한다.</p>
<p>여전히 이해할 수 없는 구문이 들어오면 예외를 던지는 기능은 유지가 되어야 한다.</p>
<p>이제부터 해야할 일은,</p>
<ul>
<li><code>badMessages()</code>의 이름을 바꾼다</li>
<li>Whitelist 기반으로, <code>HttpMessageParser</code>를 어떻게 사용할 수 있는지 표현하자 <ul>
<li>시작줄의 세영역은 따로따로 테스트하자</li>
</ul>
</li>
</ul>
<p>아직 시작줄에 관한 정책만 테스트하고 있으므로 dataProvider의 이름은 <code>badStartLines</code>라고 바꾸고, 이에 맞춰 테스트명도 변경했다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dataProvider</span> badStartLines</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $badMsg</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidStartLineCausesException</span>(<span class="params"><span class="variable">$badMsg</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$badMsg</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이제 화이트리스트 기반의 테스트를 작성할텐데, 그 전에 또 하나의 고민이 생긴다.</p>
<blockquote>
<p><code>HttpMessageParser</code>가 서버에서 지원 가능한 메소드의 종류를 알아야 하는가?</p>
</blockquote>
<p><code>Request</code>는 <code>HttpMessageParser</code>에 어떤 역할을 해주기 기대할까?</p>
<p>나는 아직까지 <code>Request</code>가 필요로 하는 기능 이상으로는 생각하고 싶지 않다.</p>
<p><code>Request</code>는 <code>HttpMessageParser</code>에게 문자열을 던져주고 특정 구조에 맞춰 결과를 돌려주길 바랄 뿐이다.</p>
<p>해당 메소드를 지원하는지 안 하는지 여부는 꼭 파서가 보유할 지식일까?</p>
<p>최소한 <code>Request</code>는 메소드에 따른 분기처리를 위해 지원하는 메소드의 종류를 알아야 한다.</p>
<p>두 클래스에서 보유할 필요는 없으니, 이 지식이 (나중에야 어찌되든) 현재는 <code>Request</code> 쪽에서 보유하는 게 좋겠다고 생각이 든다.</p>
<p>그럼 <code>HttpMessageParser</code>에서는 정상적인 메소드가 넘어왔는지 테스트 안해도 되나?</p>
<p>(안해도 된다고 생각은 하지만) HTTP 표준에 존재하는 모든 메소드 정도는 파서에서 알고 있는 것도 의미가 있을 것 같다.</p>
<p>그럼 HTTP 스펙에서 정의하는 메소드는 무엇이 있을까?</p>
<p><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7231#section-4">RFC 7231, section 4: Request methods</a>에서 <code>GET, HEAD, POST, PUT, DELETE, CONNECT, OPTIONS, TRACE</code>를 정의하고 있고, <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc5789#section-2">RFC 5789, section 2: Patch method</a>에서 PATCH를 추가로 정의하고 있다. </p>
<p><code>HttpMessageParser</code>에서 허용 가능한 메소드를 수정해주자.</p>
<p><code>$HTTPMethods</code>라는 변수도 PHPStorm의 <code>Refactor &gt; Rename</code>을 이용해 변경해주자.</p>
<p>이 클래스만 독립적으로 보면 크게 잘못된 이름은 아니라고 보지만,</p>
<p>우리의 서버가 제공하는 메소드가 아닌 HTTP에 정의된 메소드라는 의미로 바꾸어보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//HttpMessageParser.php</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="variable">$HTTPMethods</span> = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;CONNECT&#x27;</span>, <span class="string">&#x27;OPTIONS&#x27;</span>, <span class="string">&#x27;TRACE&#x27;</span>,];</span><br></pre></td></tr></table></figure>

<p>(못난 테스트라도) 테스트는 잘 돌아간다.</p>
<p>이왕 고치는 김에 기존에 만들었던 <code>testReturnValue()</code> 메소드 명도 바꿔보자. 이름이 마음에 안든다.</p>
<p><code>testReturnValueHasRequiredFields()</code>라고 좀 더 하는 일을 정확하게 표현해주자.</p>
<p>드디어 (이 글의 본론인…) whitelist 기반의 테스트를 작성한다!</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMessageParsedAndPlacedIntoRequiredFields</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$goodMethod</span> = <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">    <span class="variable">$goodUri</span> = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="variable">$goodVersion</span> = <span class="string">&#x27;HTTP/1.1&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$goodMsg</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; &#x27;</span>, [<span class="variable">$goodMethod</span>, <span class="variable">$goodUri</span>, <span class="variable">$goodVersion</span>]);</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$goodMsg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//TODO $result의 형식은 올바른지 확인</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$goodMethod</span>, <span class="variable">$result</span>[<span class="string">&#x27;method&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>여기선 어떤 메소드를 쓸 수 있는지 확인할텐데, 사용할 메소드마다 또 loop를 돌거나 dataProvider를 사용하게 될 것 같다.</p>
<p>시작줄의 요소를 하나씩 테스트하기 위해선 시작줄의 나머지 요소는 확실히 문제없는 문자열을 넣어줘야 한다.</p>
<p>그래서 완벽한 시작줄을 정의하고 각 요소를 하나씩 교체해가면서 문제가 없는지 확인하려고 한다.</p>
<p>반복되는 구문은 별도의 메소드로 빼놓는 것도 잊지 말고.</p>
<p>변경 후의 코드를 보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParserTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">PERFECT_START_LINE</span> = <span class="string">&#x27;GET / HTTP/1.1&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReturnValueHasRequiredFields</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="literal">true</span>, <span class="title function_ invoke__">is_array</span>(<span class="variable">$result</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$requiredFields</span> = [</span><br><span class="line">            <span class="string">&#x27;start_line&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uri&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;headers&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;body&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$requiredFields</span> <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="variable">$field</span>, <span class="variable">$result</span>, <span class="string">&#x27;key &quot;&#x27;</span> . <span class="variable">$field</span> . <span class="string">&#x27;&quot; does not exist&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMessageParsedAndPlacedIntoRequiredFields</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$possibleHTTPMethod</span> = [</span><br><span class="line">            <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HEAD&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;PUT&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;DELETE&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;CONNECT&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;OPTIONS&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;TRACE&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$possibleHTTPMethod</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="variable">$method</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$uriStartsWithSlash</span> = [</span><br><span class="line">            <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/index&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/index.html&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$uriStartsWithSlash</span> <span class="keyword">as</span> <span class="variable">$uri</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="literal">null</span>, <span class="variable">$uri</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$possibleHTTPVersions</span> = [</span><br><span class="line">            <span class="string">&#x27;HTTP/0.9&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HTTP/1.0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HTTP/1000.9999&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$possibleHTTPVersions</span> <span class="keyword">as</span> <span class="variable">$version</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="variable">$version</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">assertValidStartLine</span>(<span class="params"><span class="variable">$method</span> = <span class="literal">null</span>, <span class="variable">$uri</span> = <span class="literal">null</span>, <span class="variable">$version</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$goodMethod</span>, <span class="variable">$goodUri</span>, <span class="variable">$goodVersion</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27; &#x27;</span>, <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$goodMsg</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; &#x27;</span>, [</span><br><span class="line">            <span class="variable">$method</span> ?? <span class="variable">$goodMethod</span>,</span><br><span class="line">            <span class="variable">$uri</span> ?? <span class="variable">$goodUri</span>,</span><br><span class="line">            <span class="variable">$version</span> ?? <span class="variable">$goodVersion</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$goodMsg</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$method</span>))  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$method</span>, <span class="variable">$result</span>[<span class="string">&#x27;method&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$uri</span>))     <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$uri</span>, <span class="variable">$result</span>[<span class="string">&#x27;uri&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$version</span>)) <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$version</span>, <span class="variable">$result</span>[<span class="string">&#x27;version&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">badStartLines</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            [<span class="string">&#x27;&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;haha&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;GET 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;POST 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD / 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD /index 셋&#x27;</span>],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dataProvider</span> badStartLines</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $badMsg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidStartLineCausesException</span>(<span class="params"><span class="variable">$badMsg</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$badMsg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>반드시 통과하는 완벽한 시작줄의 포맷을 ‘GET &#x2F; HTTP&#x2F;1.1’으로 정했는데,</p>
<p>이는 위의 테스트에서도 사용하기 때문에 중복이라 PERFECT_START_LINE라는 상수로 뺐다.</p>
<p><code>testMessageParsedAndPlacedIntoRequiredFields()</code>에는,</p>
<ul>
<li>현재 8개의 HTTP 메소드이면</li>
<li>슬래시(<code>/</code>)로 시작하는 문자열은</li>
<li><code>HTTP/정수.정수</code> 형태의 포맷이면</li>
</ul>
<p>통과한다.</p>
<p>이제 애초에 문제가 있다고 진단했던 <code>testInvalidStartLineCausesException()</code>을 손보자.</p>
<p>원하지 않는 포맷이 들어올 때 예외를 발생시키는 것도 엄연히 기능이므로 몇가지 주요 정책은 간단히 남겨두겠다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidMethodCausesException</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="string">&#x27;NotAMethod&#x27;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidURICausesException</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="literal">null</span>, <span class="string">&#x27;StartsWithChar&#x27;</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidHTTPVersionFormatCausesException</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="string">&#x27;HTTP/2&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="header-모으기"><a href="#header-모으기" class="headerlink" title="header 모으기"></a>header 모으기</h2><p>시작줄 다음에 등장하는 건 헤더 영역인데, 헤더의 끝이 어디냐 하면 공백이 나올 때다. </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">헤더1</span><br><span class="line">헤더2</span><br><span class="line">    </span><br><span class="line">메시지 본문</span><br></pre></td></tr></table></figure>

<p>잘린 메시지 본문에서 시작줄 이후 공백이 등장할 때까지 모두 헤더로 넣으면 된다.</p>
<p><code>HttpMessageParser</code>의 <code>parse()</code> 메소드에서 전체 메시지를 줄단위로 나누는 일을 한다.</p>
<p>그 뒤로 시작줄을 검증하는 메소드가 있는데…어…이상하다.</p>
<p>시작줄을 자르는 행위가 보여야 할 것 같은데?</p>
<p><code>parse()</code> 메소드의 흐름은</p>
<ol>
<li>줄단위로 자른다</li>
<li>시작줄을 공백으로 나눈다</li>
<li>헤더를 모은다</li>
<li>메시지 바디를 넣는다</li>
</ol>
<p>정도로 요약되어야 할 것 같은데 뜬금없이 시작줄을 검증하고 앉았다.</p>
<p><code>splitStartLineInto3Components()</code>를 <code>parse()</code> 안으로 옮기고, 검증 기능은 그 내부로 옮기자.</p>
<p><code>HttpMessageParser</code>를 재구성한 버전으로 새출발하자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$message</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$messageLines</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$result</span> = [</span><br><span class="line">        <span class="string">&#x27;start_line&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;headers&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$HTTPMethods</span> = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;CONNECT&#x27;</span>, <span class="string">&#x27;OPTIONS&#x27;</span>, <span class="string">&#x27;TRACE&#x27;</span>,];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;message = <span class="variable">$message</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parse</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">splitMessageIntoLines</span>();</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">splitStartLineInto3Components</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 메시지를 \r\n 혹은 \n으로 나누기</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">splitMessageIntoLines</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;messageLines = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/(\r\n|\n)/&#x27;</span>, <span class="variable">$this</span>-&gt;message);</span><br><span class="line">        <span class="comment">//각 줄의 양 끝 공백은 제거한다</span></span><br><span class="line">        <span class="title function_ invoke__">array_walk</span>(<span class="variable">$this</span>-&gt;messageLines, function (&amp;<span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="variable">$item</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$item</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">splitStartLineInto3Components</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//시작줄은 있어야 한다</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;messageLines) || <span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//시작줄을 whitespace로 나누기</span></span><br><span class="line">        <span class="variable">$startLine</span> = <span class="variable language_">$this</span>-&gt;messageLines[<span class="number">0</span>];</span><br><span class="line">        <span class="variable">$startLineSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/\s/&#x27;</span>, <span class="variable">$startLine</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$startLineSplit</span>) || <span class="title function_ invoke__">count</span>(<span class="variable">$startLineSplit</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLine</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">throwInvalidMessageFormat</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Invalid message format.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLine</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineMethod</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineURI</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineVersion</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineMethod</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>]) || !<span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>], <span class="variable">$this</span>-&gt;HTTPMethods)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineURI</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>]) || <span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>], <span class="string">&#x27;/&#x27;</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineVersion</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>]) || !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/HTTP\/\d+.\d+/&#x27;</span>, <span class="variable">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="다시-실패-성공-리팩토링의-궤도-안으로"><a href="#다시-실패-성공-리팩토링의-궤도-안으로" class="headerlink" title="다시 실패-성공-리팩토링의 궤도 안으로"></a>다시 실패-성공-리팩토링의 궤도 안으로</h2><p>여차저차 정리됐으니 진짜 헤더를 모으는 작업을 시작하자. 테스트부터.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testHeadersMayExistAfterStartLineAndBeforeEmptyLine</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span> . PHP_EOL;</span><br><span class="line">    <span class="variable">$oneHeader</span> = <span class="string">&#x27;IAmAHeader&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$msg</span> .= <span class="variable">$oneHeader</span>;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="number">1</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>[<span class="string">&#x27;headers&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 

<p>실패하려고 만든 테스트가 성공하고 말았다!</p>
<p>result에 headers가 빈 문자열로 들어가있었기 때문. result 내 headers의 기본값을 빈 배열로 넣어주자.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Failed asserting that 0 matches expected 1.</span><br></pre></td></tr></table></figure>

<p>Yes! 싪패했으니 테스트가 통과할 정도만 메소드를 만들어본다.</p>
<p><code>parse()</code>에 <code>parseHeaders()</code>라는 메소드 추가.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;headers&#x27;</span>][] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>모든 테스트가 성공하니 또 실패하는 테스트 작성. 이번엔 헤더 두개.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testHeadersMayExistAfterStartLineAndBeforeEmptyLine</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$msg</span> .= PHP_EOL . <span class="string">&#x27;firstHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="number">1</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>[<span class="string">&#x27;headers&#x27;</span>]));</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$msg</span> .= PHP_EOL . <span class="string">&#x27;secondHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="number">2</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>[<span class="string">&#x27;headers&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>또 통과하도록 메소드 수정.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;messageLines); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;headers&#x27;</span>][] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>헤더가 전혀 없을 수도 있겠지?</p>
<p>헤더가 없을 때 실패하는 구문 추가:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$msg</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span> . PHP_EOL . PHP_EOL . <span class="string">&#x27;endOfMessage&#x27;</span>;</span><br><span class="line"><span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>);</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="number">0</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>[<span class="string">&#x27;headers&#x27;</span>]));</span><br></pre></td></tr></table></figure>

<p>이를 통과하는 코드:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;messageLines); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>])) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;headers&#x27;</span>][] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>사실 여기서 각 헤더도 첫번째 콜론(<code>:</code>)을 기준으로 key, value를 나눠야 한다.</p>
<p>아직 그걸 어디다 쓸 지는 모르는 척을 하기 위해 이대로 두기로 한다.</p>
<ul>
<li>아마도 가장 먼저 쓰일 곳은 브라우저의 캐시를 지원할 때일 것이다. 이 속도라면 50회 정도는 되어야겠군…</li>
</ul>
<h2 id="Message-Body"><a href="#Message-Body" class="headerlink" title="Message Body"></a>Message Body</h2><p>메시지 본문은 가져오기 쉽다. 헤더까지 가져온 다음 빈줄하나가 존재하면 나머지는 모두 메시지 본문이다. </p>
<p>다만 줄단위로 나눴던 나머지 메시지를 다시 붙여서 넣어야 한다.</p>
<p>이때 문제가 발생하겠지만, 걱정은 나중에 하고 메시지 본문을 result에 채워보자.</p>
<p>실패하는 테스트를 만들기 전 기초를 만들어 두자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBodyMayExistAfterHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$msgBeforeBody</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span> . PHP_EOL . <span class="string">&#x27;firstHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$result</span> = (<span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msgBeforeBody</span>))-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEmpty</span>(<span class="variable">$result</span>[<span class="string">&#x27;body&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>메시지가 헤더 파싱까지만 존재하기 때문에 메시지 본문은 비어있는 게 당연하다. 테스트는 통과한다.</p>
<p>이제 본문이 존재할 때 실패하는 테스트 작성.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBodyMayExistAfterHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$msgBeforeBody</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span> . PHP_EOL . <span class="string">&#x27;firstHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$result</span> = (<span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msgBeforeBody</span>))-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEmpty</span>(<span class="variable">$result</span>[<span class="string">&#x27;body&#x27;</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$msgBeforeBody</span> .= PHP_EOL . <span class="string">&#x27;secondHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$msgBeforeBody</span> .= PHP_EOL;<span class="comment">//empty line</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$bodyText</span> = <span class="string">&#x27;somebody to love&#x27;</span>;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="variable">$msgBeforeBody</span> . PHP_EOL . <span class="variable">$bodyText</span>;</span><br><span class="line">    <span class="variable">$result</span> = (<span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>))-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$bodyText</span>, <span class="variable">$result</span>[<span class="string">&#x27;body&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>parse()</code> 메소드에 </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseBody</span>();</span><br></pre></td></tr></table></figure>

<p>한줄 추가하고 테스트를 통과시키는 코드 작성.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//시작줄 + 헤더</span></span><br><span class="line">    <span class="variable">$emptyLineIndex</span> = <span class="number">1</span> + <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;result[<span class="string">&#x27;headers&#x27;</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$emptyLineIndex</span>]) ||</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$emptyLineIndex</span>] !== <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$bodyIndex</span> = <span class="variable">$emptyLineIndex</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$bodyIndex</span>])) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="variable">$bodyIndex</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;messageLines); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;body&#x27;</span>] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>가운데 쯤 빈줄을 확인하는 코드는 사실 필요 없다. 빈줄이 없으면 다 헤더로 들어갔을테니까.</p>
<p>하지만 메시지 본문 앞에 공백이 있고 그래서 시작줄, 헤더 다음 1을 추가하는 코드(<code>$bodyIndex = $emptyLineIndex + 1;</code>)를 이해하기 쉽도록 남겨두기로 했다.</p>
<p>이제 다 끝인가 싶겠지만 몇가지 문제가 있다.</p>
<p>첫번째로, 본문에 개행이 들어가 있을 경우 제대로 동작하지 않는다. </p>
<p>테스트로 확인해보면,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$bodyText</span> .= PHP_EOL . <span class="string">&#x27;Help! I need somebody&#x27;</span>;</span><br><span class="line"><span class="variable">$bodyText</span> .= PHP_EOL . <span class="string">&#x27;Help! Not just anybody&#x27;</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="variable">$msgBeforeBody</span> . PHP_EOL . <span class="variable">$bodyText</span>;</span><br><span class="line"><span class="variable">$result</span> = (<span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>))-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$bodyText</span>, <span class="variable">$result</span>[<span class="string">&#x27;body&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>통과하기.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$bodyIndex</span> = <span class="variable">$emptyLineIndex</span> + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$bodyIndex</span>])) &#123;</span><br><span class="line">    <span class="variable">$partsOfBody</span> = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="variable">$bodyIndex</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;messageLines); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$partsOfBody</span>[] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;body&#x27;</span>] = <span class="title function_ invoke__">implode</span>(PHP_EOL, <span class="variable">$partsOfBody</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>또 하나의 문제는 애초에 메시지 본문을 <code>\r\n</code> 혹은 <code>\n</code>으로 줄단위로 나눴기 때문에</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;messageLines = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/(\r\n|\n)/&#x27;</span>, <span class="variable">$this</span>-&gt;message);</span><br></pre></td></tr></table></figure>

<p>이 놈을 다시 붙여줄 때는 <code>\r\n</code>으로 붙여야 할지 <code>\n</code>으로 붙여야 할지 모른다는 점이다.</p>
<p>이를 해결하려면 뭐로 나눴는지 기억하는 것도 방법이지만 메시지 본문 안에 <code>\r\n</code> 혹은 <code>\n</code>가 섞여 있다면 이 또한 문제다.</p>
<p>결국 전체 메시지에서 공백줄이 나타난 이후를 모두 잘라내는 쪽으로 코드를 수정해야 한다.</p>
<p>가독성 때문에 정규식을 쓰기 싫었지만, 쉽게 해결된다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;body&#x27;</span>] = <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(?:.+?)(?:\r\n|\n)&#123;2&#125;(.*)/s&#x27;</span>, <span class="variable">$this</span>-&gt;message, <span class="variable">$matches</span>) ? <span class="variable">$matches</span>[<span class="number">1</span>] : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/(?:.+?)(?:\r\n|\n)&#123;2&#125;(.*)/s</span><br></pre></td></tr></table></figure>

<p>이 정규식을 간단히</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/(아무 문자열)(개행)&#123;2개&#125;(나머지문자열)/개행을포함</span><br></pre></td></tr></table></figure>

<p>정도로 표현할 수 있겠다.</p>
<p>괄호 안의 <code>?:</code>는 캡쳐를 하지 않는다는 의미로, 만약 정규식을</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/(.+?)(\r\n|\n)&#123;2&#125;(.*)/s</span><br></pre></td></tr></table></figure>

<p>처럼 쓴다면 <code>$matches[1]</code>가 아니라 <code>$matches[3]</code>으로 변경해야 할 것이다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>어떻게든 돌아가는 코드를 만들어 놓기는 했지만 썩 마음에 들진 않는다.</p>
<p>무조건 전체 HTTP 메시지를 받아 한번에 파싱한 다음 결과를 리턴하는 구조인데,</p>
<p>나중에 스트리밍을 고려한다면 서버에 전송되는 메시지를 그때 그때 파서에 전달하고 파서에서는 받은 문자열을 버퍼에 쌓는 동시에 파싱을 진행해야할 것이다.</p>
<p>아직 해당 요구사항이 발견되지 않았다 치더라도,</p>
<p>분리하는 로직에서 개행문자로 한번에 나눠놓지 말고 개행이 나타나는 곳까지 읽은 후 적당한 위치에 넣어주기만 해도 훨씬 빠른 처리가 될 것이다.</p>
<p>하지만 난 그대로 둘 것이다.</p>
<p>다시 개발하기 싫으니까!</p>
<br>

<p>Season 1, 끝.</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>youngiggy
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://haah.kr/2017/11/20/phttp-10-parsing-request-message-03/" title="PHP로 HTTP 서버 구현하기 - 10 - 요청 메시지 파싱 3">https://haah.kr/2017/11/20/phttp-10-parsing-request-message-03/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/PHP/" rel="tag"># PHP</a>
              <a href="/tags/HTTP/" rel="tag"># HTTP</a>
              <a href="/tags/phttp/" rel="tag"># phttp</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2017/11/08/phttp-09-parsing-request-message-02/" rel="prev" title="PHP로 HTTP 서버 구현하기 - 09 - 요청 메시지 파싱 2">
                  <i class="fa fa-chevron-left"></i> PHP로 HTTP 서버 구현하기 - 09 - 요청 메시지 파싱 2
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2017/12/02/book-978-89-98139-76-6/" rel="next" title="독후감 - 객체지향의 사실과 오해">
                  독후감 - 객체지향의 사실과 오해 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">youngiggy</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  




  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"youngiggy-github-io","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
