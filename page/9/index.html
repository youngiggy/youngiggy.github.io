<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon_package_v0.16/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_package_v0.16/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_package_v0.16/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon_package_v0.16/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/favicon_package_v0.16/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"haah.kr","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="blog">
<meta property="og:title" content="ha-ah">
<meta property="og:url" content="https://haah.kr/page/9/">
<meta property="og:site_name" content="ha-ah">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="youngiggy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://haah.kr/page/9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ha-ah</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=354302543"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":354302543,"only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="ha-ah" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ha-ah</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">로그, 게으른 로그</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">youngiggy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:youngiggy@gmail.com" title="E-Mail → mailto:youngiggy@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/profile.php?id=100001259884599" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100001259884599" rel="noopener me" target="_blank"><i class="fab fa-facebook fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.instagram.com/jooyoungiggy" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;jooyoungiggy" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/12/10/book-9788965962090-%E1%84%8B%E1%85%A6%E1%84%80%E1%85%A9%E1%84%85%E1%85%A1%E1%84%82%E1%85%B3%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/12/10/book-9788965962090-%E1%84%8B%E1%85%A6%E1%84%80%E1%85%A9%E1%84%85%E1%85%A1%E1%84%82%E1%85%B3%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%A8/" class="post-title-link" itemprop="url">독후감 - 에고라는 적</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-12-10 23:12:53" itemprop="dateCreated datePublished" datetime="2017-12-10T23:12:53+09:00">2017-12-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/12/10/book-9788965962090-%E1%84%8B%E1%85%A6%E1%84%80%E1%85%A9%E1%84%85%E1%85%A1%E1%84%82%E1%85%B3%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%A8/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/12/10/book-9788965962090-에고라는적/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://image.kyobobook.co.kr/images/book/large/090/l9788965962090.jpg" alt="에고라는 적"></p>
<p>이 책도 역시 <a target="_blank" rel="noopener" href="http://jhrogue.blogspot.kr/2017/10/blog-post_6.html">컴퓨터 vs 책</a>에서 소개되어 알게 됐고,</p>
<p>서점에서 잠깐 보고 나서 ‘좋은 책인 것 같으나 나에겐 필요 없을 듯’과 같은 식으로 건방진 메모를 하고 있다가,</p>
<p>딱 이 시점에 읽기 좋은 책이라 생각하며 사서 3<del>4일 정도에 후다닥 읽어버렸다. (내 최고 기록은 2</del>3일 만에 읽은 ‘의뢰인’이었던 것 같다)</p>
<p>그렇다고 이게 엄청 재밌는 건 아닌데, 자신을 돌아보며 적극적으로 읽어나가야 공감이 많이 될 것이다. </p>
<p>맨 처음에 언급한 독후감에 좋은 문구와 동영상과 감상평을 많이 추려 놓으셨는데, 이 분의 결론에 격한 공감을 한다.</p>
<blockquote>
<p>결론: 에고 때문에 혼쭐이 나신 분이라면(과연 안 그런 분이 계실까?) 이 책을 읽으면서 여러 가지 감상에 젖을 것이다. 강력 추천!</p>
</blockquote>
<p>희대의 잔소리꾼 라이언 홀리데이(작가의 이름)는 위인전에서 위인들의 내면을 다루지 않고 그 사람들의 인생의 단면만을 나열한다고 불만인 것 같으나, 그가 에고가 튼실한 위인을 다루는 방식도 크게 다르지 않은 것 같다.</p>
<p>수많은 명언과 예시를 쏟아내며 잔소리에 잔소리를 거듭하지만 그가 옳다는 근거를 찾기는 힘들다.</p>
<p>그런데 그 잔소리가 꽤 설득력은 있어서 내 과거, 내 선택, 지금 내 생각을 하나하나 짚어가며 들여다보는 재미가 있기도 했다. </p>
<p>나는 <code>에고</code>가 뭔지 정확히 정의를 못 내리겠지만, 이 사람은 에고를 ‘모든 마음의 소리’ 정도로 해석하는 것 같다.</p>
<p>내가 해야 할 올바른 선택을 방해하는 모든 마음의 소리. </p>
<p>그 올바르다는 기준은 미래 시점에 알고 보니 옳았던 선택이 아니고, 합리적인 선택을 의미한다. 충분한 근거로. 더 큰 목표를 갖고. 자신을 객관적으로 바라보면서.</p>
<p>항상 명심하기 위해 작가처럼 ‘에고가 나쁜 놈이네’라고 문신을 새길 순 없지만, 허리를 펼 때면 ‘에고 허리야’ 소리라도 낼까.</p>
<p>아니면 가끔이라도 내 마음의 소리가 내 선택, 내 행동을 잘못 이끌고 있는지 돌아보는 용도로 이 책을 다시 읽으면 좋을 것 같다.</p>
<p>과한 자기 확신으로 책 한권을 채운 잔소리를 3일 내내 읽다보니, (책 뒤표지나 추천사에서) 왜 그토록 많은 뛰어난 인물들이 책을 추천하는 지 알 것 같았다.</p>
<p>읽고 추천한 사람들이 참 뛰어났기 때문이다.</p>
<p>이상한 결론이지만, 나도 이 책을 추천하면서 끝을 내기로…</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/12/02/book-978-89-98139-76-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/12/02/book-978-89-98139-76-6/" class="post-title-link" itemprop="url">독후감 - 객체지향의 사실과 오해</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-12-02 12:17:37" itemprop="dateCreated datePublished" datetime="2017-12-02T12:17:37+09:00">2017-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/12/02/book-978-89-98139-76-6/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/12/02/book-978-89-98139-76-6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="역할-책임-협력-관점에서-본-객체지향"><a href="#역할-책임-협력-관점에서-본-객체지향" class="headerlink" title="역할, 책임, 협력 관점에서 본 객체지향"></a>역할, 책임, 협력 관점에서 본 객체지향</h2><p><img src="http://image.kyobobook.co.kr/images/book/xlarge/766/x9788998139766.jpg" alt="객체지향의 사실과 오해"></p>
<p>그동안 객체지향을 오해한 기억이 별로 없어서 그런지 특별히 재밌고 감동적이고 그렇지는 않았다.<br>(난 오해한 적은 없고 이해한 적이 없었으니..)</p>
<p>비교적 얇은 <code>책</code>임에도 불구하고 설명이 꽤나 장황하다. </p>
<p>학교 다닐 때 과제 분량 맞추려고 문장을 늘려쓰곤 했던 사람이라면 의심의 눈초리를 거둘 수 없을텐데, </p>
<p>지루함을 견디고 끝까지 읽었을 때 비로소 이해가 갔다.</p>
<p>용어를 최대한 정확하게 표현하려 애쓴 흔적이 역력하다.</p>
<p>표현의 근거도 일일이 제시하고 내 수준에서는 특별히 틀렸다고 생각할 만한 지점이 없었다.</p>
<p>쉬운 이야기를 썼지만 저자의 내공이 매우 깊은가보다 생각이 든다.</p>
<p>하지만 이 책을 추천하는지 질문을 받는다면 뜻밖의 지점에서 고민하게 될 터인데,</p>
<p>좀…아재 감성이다.</p>
<p>그 감성을 풀어내는 방식도 좀 장황하기도 하고, 젠더 감수성을 운운할 정도까지인지는 모르겠으나 가끔 공대 개그 같은 묘한 냄새가 난다(smell).</p>
<p>내가 명확하게 정의 내려 입 밖에 내 본 적이 없는 수많은 개념과 용어를 한번 더 정리하는 기분으로 읽어냈고,</p>
<p>그 경험이 나쁘진 않았다.</p>
<p>조금 더 짧은 호흡으로 쓰였다면, 종종 뒤적거리며 개념 정리하기 좋았을 것 같다.</p>
<p>결론은,</p>
<p>추천하긴 하지만 선뜻 다시 손이 안 갈 것 같다.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/11/20/phttp-10-parsing-request-message-03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/20/phttp-10-parsing-request-message-03/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 10 - 요청 메시지 파싱 3</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-11-20 19:27:12" itemprop="dateCreated datePublished" datetime="2017-11-20T19:27:12+09:00">2017-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/11/20/phttp-10-parsing-request-message-03/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/11/20/phttp-10-parsing-request-message-03/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h2 id="지난-시간에-우리는"><a href="#지난-시간에-우리는" class="headerlink" title="지난 시간에 우리는.."></a>지난 시간에 우리는..</h2><p>이전 글에서 HTTP 메시지를 줄단위로 끊고 첫 요소에서 시작줄을 파싱하는 것까지 진행했다. </p>
<p>이제 슬슬 길어져 보기 힘드니까…<a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp/tree/936aca2b701b7827c638974e1c477cfaa405b641">여기</a>서 확인</p>
<h2 id="테스트-코드는-멀쩡한-코드인가"><a href="#테스트-코드는-멀쩡한-코드인가" class="headerlink" title="테스트 코드는 멀쩡한 코드인가?"></a>테스트 코드는 멀쩡한 코드인가?</h2><p>여기까지는 최소한으로 받아들일 수 있는 HTTP 메시지의 형식을 제한했다.</p>
<p>그런데 이게 테스트 케이스로써 어떤 가치가 있는지 생각해보게 됐다.</p>
<p>스스로에게 이번 프로젝트에 TDD를 도입한 이유를 물어본다면</p>
<ul>
<li>자동화된 테스트는 내가 방금 수정한 코드에 문제가 있는지 매우 빠르게 피드백을 준다 </li>
<li>테스트로부터 테스트 대상을 어떻게 사용할 수 있는지 알 수 있기 때문에 그 자체로 살아있는 기능 정의서가 된다</li>
</ul>
<p>크게 이정도 생각난다(사실 어디서 주워들었다). 더 있다면 누군가 댓글을 달아주겠지.</p>
<p>이외에도 단위테스트를 작성하면서 얻을 수 있는 효과는 많지만, 저 둘을 가장 근본적인 목적으로 꼽겠다, 나는.</p>
<p>자동화된 테스트가 즉각 피드백을 주는 것은 앞서 꾸준히 증명이 됐다고 본다.</p>
<p>그럼,</p>
<p>지금까지의 테스트 코드가 <code>HttpMessageParser</code>의 사용법을 올바르게 노출하고 있을까? </p>
<p><code>HttpMessageParser</code>를 사용하는 곳은 아직까지 2곳으로 예상된다. 이들은 <code>HttpMessageParser</code>의 서비스를 이용하는 클라이언트가 된다.  </p>
<p>일단 테스트 코드가 첫번째 손님이 됐고, 앞으로 테스트 코드가 충분히 cover하게 되면 <code>Request</code>도 곧 클라이언트가 된다. (기억이…나시는가?)</p>
<p>당신이 <code>Request</code>든 뭐든 HTTP 메시지를 파싱해서 지지고 볶는 기능을 만든다고 생각하고, 막 테스트 코드를 열었을 때 어떤 모양인지 살펴보자.</p>
<p><code>HttpMessageParser</code>는 <code>HttpMessageParserTest</code>의 테스트 코드로 미루어 보건대, 어떤 기능을 담고 있는가?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParserTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReturnValue</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$goodMsg</span> = <span class="string">&#x27;GET / HTTP/1.1&#x27;</span>;</span><br><span class="line">        <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$goodMsg</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="literal">true</span>, <span class="title function_ invoke__">is_array</span>(<span class="variable">$result</span>));</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$requiredFields</span> = [</span><br><span class="line">            <span class="string">&#x27;start_line&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uri&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;headers&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;body&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$requiredFields</span> <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="variable">$field</span>, <span class="variable">$result</span>, <span class="string">&#x27;key &quot;&#x27;</span> . <span class="variable">$field</span> . <span class="string">&#x27;&quot; does not exist&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">badMessages</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            [<span class="string">&#x27;&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;haha&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;GET 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;POST 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD / 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD /index 셋&#x27;</span>],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dataProvider</span> badMessages</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidMessageCausesException</span>(<span class="params"><span class="variable">$badMsg</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$badMsg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>‘GET &#x2F; HTTP&#x2F;1.1’라는 문자열을 전달한 후, <code>getResult()</code>를 호출하면</li>
</ol>
<ul>
<li>그 결과물은 반드시 배열이다</li>
<li>‘start_line’, ‘method’, ‘uri’, ‘version’, ‘headers’, ‘body’의 키가 반드시 존재한다</li>
</ul>
<ol>
<li>7개의 불량한 문자열을 넘기면 예외가 발생한다</li>
</ol>
<ul>
<li>‘’, ‘haha’, ‘GET 둘 셋’, ‘POST 둘 셋’, ‘HEAD 둘 셋’, ‘HEAD &#x2F; 셋’, ‘HEAD &#x2F;index 셋’</li>
</ul>
<p>1번 기능을 통해 우리가 원했던 대로 리턴이 되는 것을 확인할 수는 있지만, ‘GET &#x2F; HTTP&#x2F;1.1’이라는 문자열이 왜 통과하는 지는 알 수가 없다.</p>
<p>이게 통과하는 이유는 2번 테스트를 통해 유추가 가능한데, 7개의 패턴에 속하지 않기 때문이다.</p>
<p>테스트를 열심히 만들 때는 그 과정이 매우 자연스럽다고 생각했는데, 만들어 놓은 테스트를 보니 구멍이 많아 보인다. </p>
<p>누군가 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/ko/docs/Web/HTTP/Methods/OPTIONS">OPTIONS</a>라는 메소드를 허용하도록 <code>HttpMessageParser</code>를 변경했다고 치자.</p>
<p>이때 <code>$supportMethods</code>에 ‘OPTIONS’라고 추가하면 검증 기능은 잘 동작할 것이다. </p>
<p>그리고 테스트 코드를 수정하지 않아도 당연히 테스트는 통과한다.</p>
<p>하지만 나중에 ‘OPTIONS’에 관한 기능을 수정할 땐 테스트의 가호를 받을 수 없다.</p>
<p>이에 문제를 인식한 그 누군가는 ‘OPTIONS’를 <code>testReturnValue()</code>쪽에 넣어 테스트를 돌려볼 수도 있고, <code>badMessages()</code>쪽에 몇가지 케이스를 추가할 수도 있다.</p>
<p>역시 테스트 코드는 잘 돌아갈 것이다.</p>
<p>그리고 여전히 테스트 코드만 봐선 OPTIONS를 쓸 수 있는 지 한 눈에 보이지 않는다. 지원 가능한 옵션이 늘어날 수록 테스트코드는 복잡해지고 유지보수하기 어려워진다.</p>
<p>열심히만 살아온 것 같은데, 왜 이런 시련이 왔을까?</p>
<h2 id="Blacklist-vs-Whitelist"><a href="#Blacklist-vs-Whitelist" class="headerlink" title="Blacklist vs Whitelist"></a>Blacklist vs Whitelist</h2><p>우리(내가 작성해놓고 우리라니…)의 테스트에 어떤 문제가 있었는지 돌아보자.</p>
<p>우선 시작줄의 세 영역을 한번에 테스트하는 것이 마음에 걸린다.</p>
<p><code>badMessages()</code>라는 메소드엔 불량한 시작줄만 들어있으므로 적당한 메소드명도 아닌 것 같다. </p>
<p>그리고 테스트의 대부분이 blacklist에 기반한다.</p>
<p>즉, 어떤 패턴을 사용할 수 있는지보다는 어떤 걸 쓰면 문제가 생기는지 알 수 있다.</p>
<p>(아이를 키우다보면 하지말라는 말만 하게 되는데, 그 영향인가…)</p>
<p>이런 테스트로 지탱하는 시스템이라면 새로운 기능이 생겼을 때 하지 말아야 할 패턴을 만들어야 하는 난관에 봉착한다.</p>
<p>그래서 whitelist를 기반으로 <code>HttpMessageParser</code>에서 뭘 할 수 있는지 테스트를 바꿔보려 한다.</p>
<p>여전히 이해할 수 없는 구문이 들어오면 예외를 던지는 기능은 유지가 되어야 한다.</p>
<p>이제부터 해야할 일은,</p>
<ul>
<li><code>badMessages()</code>의 이름을 바꾼다</li>
<li>Whitelist 기반으로, <code>HttpMessageParser</code>를 어떻게 사용할 수 있는지 표현하자 <ul>
<li>시작줄의 세영역은 따로따로 테스트하자</li>
</ul>
</li>
</ul>
<p>아직 시작줄에 관한 정책만 테스트하고 있으므로 dataProvider의 이름은 <code>badStartLines</code>라고 바꾸고, 이에 맞춰 테스트명도 변경했다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dataProvider</span> badStartLines</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $badMsg</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidStartLineCausesException</span>(<span class="params"><span class="variable">$badMsg</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$badMsg</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이제 화이트리스트 기반의 테스트를 작성할텐데, 그 전에 또 하나의 고민이 생긴다.</p>
<blockquote>
<p><code>HttpMessageParser</code>가 서버에서 지원 가능한 메소드의 종류를 알아야 하는가?</p>
</blockquote>
<p><code>Request</code>는 <code>HttpMessageParser</code>에 어떤 역할을 해주기 기대할까?</p>
<p>나는 아직까지 <code>Request</code>가 필요로 하는 기능 이상으로는 생각하고 싶지 않다.</p>
<p><code>Request</code>는 <code>HttpMessageParser</code>에게 문자열을 던져주고 특정 구조에 맞춰 결과를 돌려주길 바랄 뿐이다.</p>
<p>해당 메소드를 지원하는지 안 하는지 여부는 꼭 파서가 보유할 지식일까?</p>
<p>최소한 <code>Request</code>는 메소드에 따른 분기처리를 위해 지원하는 메소드의 종류를 알아야 한다.</p>
<p>두 클래스에서 보유할 필요는 없으니, 이 지식이 (나중에야 어찌되든) 현재는 <code>Request</code> 쪽에서 보유하는 게 좋겠다고 생각이 든다.</p>
<p>그럼 <code>HttpMessageParser</code>에서는 정상적인 메소드가 넘어왔는지 테스트 안해도 되나?</p>
<p>(안해도 된다고 생각은 하지만) HTTP 표준에 존재하는 모든 메소드 정도는 파서에서 알고 있는 것도 의미가 있을 것 같다.</p>
<p>그럼 HTTP 스펙에서 정의하는 메소드는 무엇이 있을까?</p>
<p><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7231#section-4">RFC 7231, section 4: Request methods</a>에서 <code>GET, HEAD, POST, PUT, DELETE, CONNECT, OPTIONS, TRACE</code>를 정의하고 있고, <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc5789#section-2">RFC 5789, section 2: Patch method</a>에서 PATCH를 추가로 정의하고 있다. </p>
<p><code>HttpMessageParser</code>에서 허용 가능한 메소드를 수정해주자.</p>
<p><code>$HTTPMethods</code>라는 변수도 PHPStorm의 <code>Refactor &gt; Rename</code>을 이용해 변경해주자.</p>
<p>이 클래스만 독립적으로 보면 크게 잘못된 이름은 아니라고 보지만,</p>
<p>우리의 서버가 제공하는 메소드가 아닌 HTTP에 정의된 메소드라는 의미로 바꾸어보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//HttpMessageParser.php</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="variable">$HTTPMethods</span> = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;CONNECT&#x27;</span>, <span class="string">&#x27;OPTIONS&#x27;</span>, <span class="string">&#x27;TRACE&#x27;</span>,];</span><br></pre></td></tr></table></figure>

<p>(못난 테스트라도) 테스트는 잘 돌아간다.</p>
<p>이왕 고치는 김에 기존에 만들었던 <code>testReturnValue()</code> 메소드 명도 바꿔보자. 이름이 마음에 안든다.</p>
<p><code>testReturnValueHasRequiredFields()</code>라고 좀 더 하는 일을 정확하게 표현해주자.</p>
<p>드디어 (이 글의 본론인…) whitelist 기반의 테스트를 작성한다!</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMessageParsedAndPlacedIntoRequiredFields</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$goodMethod</span> = <span class="string">&#x27;GET&#x27;</span>;</span><br><span class="line">    <span class="variable">$goodUri</span> = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="variable">$goodVersion</span> = <span class="string">&#x27;HTTP/1.1&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$goodMsg</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; &#x27;</span>, [<span class="variable">$goodMethod</span>, <span class="variable">$goodUri</span>, <span class="variable">$goodVersion</span>]);</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$goodMsg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//TODO $result의 형식은 올바른지 확인</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$goodMethod</span>, <span class="variable">$result</span>[<span class="string">&#x27;method&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>여기선 어떤 메소드를 쓸 수 있는지 확인할텐데, 사용할 메소드마다 또 loop를 돌거나 dataProvider를 사용하게 될 것 같다.</p>
<p>시작줄의 요소를 하나씩 테스트하기 위해선 시작줄의 나머지 요소는 확실히 문제없는 문자열을 넣어줘야 한다.</p>
<p>그래서 완벽한 시작줄을 정의하고 각 요소를 하나씩 교체해가면서 문제가 없는지 확인하려고 한다.</p>
<p>반복되는 구문은 별도의 메소드로 빼놓는 것도 잊지 말고.</p>
<p>변경 후의 코드를 보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParserTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">PERFECT_START_LINE</span> = <span class="string">&#x27;GET / HTTP/1.1&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReturnValueHasRequiredFields</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="literal">true</span>, <span class="title function_ invoke__">is_array</span>(<span class="variable">$result</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$requiredFields</span> = [</span><br><span class="line">            <span class="string">&#x27;start_line&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uri&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;headers&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;body&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$requiredFields</span> <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="variable">$field</span>, <span class="variable">$result</span>, <span class="string">&#x27;key &quot;&#x27;</span> . <span class="variable">$field</span> . <span class="string">&#x27;&quot; does not exist&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMessageParsedAndPlacedIntoRequiredFields</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$possibleHTTPMethod</span> = [</span><br><span class="line">            <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HEAD&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;PUT&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;DELETE&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;CONNECT&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;OPTIONS&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;TRACE&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$possibleHTTPMethod</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="variable">$method</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$uriStartsWithSlash</span> = [</span><br><span class="line">            <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/index&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;/index.html&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$uriStartsWithSlash</span> <span class="keyword">as</span> <span class="variable">$uri</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="literal">null</span>, <span class="variable">$uri</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$possibleHTTPVersions</span> = [</span><br><span class="line">            <span class="string">&#x27;HTTP/0.9&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HTTP/1.0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HTTP/1000.9999&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$possibleHTTPVersions</span> <span class="keyword">as</span> <span class="variable">$version</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="variable">$version</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">assertValidStartLine</span>(<span class="params"><span class="variable">$method</span> = <span class="literal">null</span>, <span class="variable">$uri</span> = <span class="literal">null</span>, <span class="variable">$version</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$goodMethod</span>, <span class="variable">$goodUri</span>, <span class="variable">$goodVersion</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27; &#x27;</span>, <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$goodMsg</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; &#x27;</span>, [</span><br><span class="line">            <span class="variable">$method</span> ?? <span class="variable">$goodMethod</span>,</span><br><span class="line">            <span class="variable">$uri</span> ?? <span class="variable">$goodUri</span>,</span><br><span class="line">            <span class="variable">$version</span> ?? <span class="variable">$goodVersion</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$goodMsg</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$method</span>))  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$method</span>, <span class="variable">$result</span>[<span class="string">&#x27;method&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$uri</span>))     <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$uri</span>, <span class="variable">$result</span>[<span class="string">&#x27;uri&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$version</span>)) <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$version</span>, <span class="variable">$result</span>[<span class="string">&#x27;version&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">badStartLines</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            [<span class="string">&#x27;&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;haha&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;GET 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;POST 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD 둘 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD / 셋&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;HEAD /index 셋&#x27;</span>],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dataProvider</span> badStartLines</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $badMsg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidStartLineCausesException</span>(<span class="params"><span class="variable">$badMsg</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$badMsg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>반드시 통과하는 완벽한 시작줄의 포맷을 ‘GET &#x2F; HTTP&#x2F;1.1’으로 정했는데,</p>
<p>이는 위의 테스트에서도 사용하기 때문에 중복이라 PERFECT_START_LINE라는 상수로 뺐다.</p>
<p><code>testMessageParsedAndPlacedIntoRequiredFields()</code>에는,</p>
<ul>
<li>현재 8개의 HTTP 메소드이면</li>
<li>슬래시(<code>/</code>)로 시작하는 문자열은</li>
<li><code>HTTP/정수.정수</code> 형태의 포맷이면</li>
</ul>
<p>통과한다.</p>
<p>이제 애초에 문제가 있다고 진단했던 <code>testInvalidStartLineCausesException()</code>을 손보자.</p>
<p>원하지 않는 포맷이 들어올 때 예외를 발생시키는 것도 엄연히 기능이므로 몇가지 주요 정책은 간단히 남겨두겠다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidMethodCausesException</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="string">&#x27;NotAMethod&#x27;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidURICausesException</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="literal">null</span>, <span class="string">&#x27;StartsWithChar&#x27;</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidHTTPVersionFormatCausesException</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertValidStartLine</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="string">&#x27;HTTP/2&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="header-모으기"><a href="#header-모으기" class="headerlink" title="header 모으기"></a>header 모으기</h2><p>시작줄 다음에 등장하는 건 헤더 영역인데, 헤더의 끝이 어디냐 하면 공백이 나올 때다. </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">헤더1</span><br><span class="line">헤더2</span><br><span class="line">    </span><br><span class="line">메시지 본문</span><br></pre></td></tr></table></figure>

<p>잘린 메시지 본문에서 시작줄 이후 공백이 등장할 때까지 모두 헤더로 넣으면 된다.</p>
<p><code>HttpMessageParser</code>의 <code>parse()</code> 메소드에서 전체 메시지를 줄단위로 나누는 일을 한다.</p>
<p>그 뒤로 시작줄을 검증하는 메소드가 있는데…어…이상하다.</p>
<p>시작줄을 자르는 행위가 보여야 할 것 같은데?</p>
<p><code>parse()</code> 메소드의 흐름은</p>
<ol>
<li>줄단위로 자른다</li>
<li>시작줄을 공백으로 나눈다</li>
<li>헤더를 모은다</li>
<li>메시지 바디를 넣는다</li>
</ol>
<p>정도로 요약되어야 할 것 같은데 뜬금없이 시작줄을 검증하고 앉았다.</p>
<p><code>splitStartLineInto3Components()</code>를 <code>parse()</code> 안으로 옮기고, 검증 기능은 그 내부로 옮기자.</p>
<p><code>HttpMessageParser</code>를 재구성한 버전으로 새출발하자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$message</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$messageLines</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$result</span> = [</span><br><span class="line">        <span class="string">&#x27;start_line&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;headers&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$HTTPMethods</span> = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;CONNECT&#x27;</span>, <span class="string">&#x27;OPTIONS&#x27;</span>, <span class="string">&#x27;TRACE&#x27;</span>,];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;message = <span class="variable">$message</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parse</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">splitMessageIntoLines</span>();</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">splitStartLineInto3Components</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 메시지를 \r\n 혹은 \n으로 나누기</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">splitMessageIntoLines</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;messageLines = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/(\r\n|\n)/&#x27;</span>, <span class="variable">$this</span>-&gt;message);</span><br><span class="line">        <span class="comment">//각 줄의 양 끝 공백은 제거한다</span></span><br><span class="line">        <span class="title function_ invoke__">array_walk</span>(<span class="variable">$this</span>-&gt;messageLines, function (&amp;<span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="variable">$item</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$item</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">splitStartLineInto3Components</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//시작줄은 있어야 한다</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;messageLines) || <span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//시작줄을 whitespace로 나누기</span></span><br><span class="line">        <span class="variable">$startLine</span> = <span class="variable language_">$this</span>-&gt;messageLines[<span class="number">0</span>];</span><br><span class="line">        <span class="variable">$startLineSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/\s/&#x27;</span>, <span class="variable">$startLine</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$startLineSplit</span>) || <span class="title function_ invoke__">count</span>(<span class="variable">$startLineSplit</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLine</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">throwInvalidMessageFormat</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Invalid message format.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLine</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineMethod</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineURI</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineVersion</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineMethod</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>]) || !<span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>], <span class="variable">$this</span>-&gt;HTTPMethods)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineURI</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>]) || <span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>], <span class="string">&#x27;/&#x27;</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineVersion</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>]) || !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/HTTP\/\d+.\d+/&#x27;</span>, <span class="variable">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="다시-실패-성공-리팩토링의-궤도-안으로"><a href="#다시-실패-성공-리팩토링의-궤도-안으로" class="headerlink" title="다시 실패-성공-리팩토링의 궤도 안으로"></a>다시 실패-성공-리팩토링의 궤도 안으로</h2><p>여차저차 정리됐으니 진짜 헤더를 모으는 작업을 시작하자. 테스트부터.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testHeadersMayExistAfterStartLineAndBeforeEmptyLine</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span> . PHP_EOL;</span><br><span class="line">    <span class="variable">$oneHeader</span> = <span class="string">&#x27;IAmAHeader&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$msg</span> .= <span class="variable">$oneHeader</span>;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="number">1</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>[<span class="string">&#x27;headers&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 

<p>실패하려고 만든 테스트가 성공하고 말았다!</p>
<p>result에 headers가 빈 문자열로 들어가있었기 때문. result 내 headers의 기본값을 빈 배열로 넣어주자.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Failed asserting that 0 matches expected 1.</span><br></pre></td></tr></table></figure>

<p>Yes! 싪패했으니 테스트가 통과할 정도만 메소드를 만들어본다.</p>
<p><code>parse()</code>에 <code>parseHeaders()</code>라는 메소드 추가.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;headers&#x27;</span>][] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>모든 테스트가 성공하니 또 실패하는 테스트 작성. 이번엔 헤더 두개.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testHeadersMayExistAfterStartLineAndBeforeEmptyLine</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$msg</span> .= PHP_EOL . <span class="string">&#x27;firstHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="number">1</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>[<span class="string">&#x27;headers&#x27;</span>]));</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$msg</span> .= PHP_EOL . <span class="string">&#x27;secondHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="number">2</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>[<span class="string">&#x27;headers&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>또 통과하도록 메소드 수정.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;messageLines); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;headers&#x27;</span>][] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>헤더가 전혀 없을 수도 있겠지?</p>
<p>헤더가 없을 때 실패하는 구문 추가:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$msg</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span> . PHP_EOL . PHP_EOL . <span class="string">&#x27;endOfMessage&#x27;</span>;</span><br><span class="line"><span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>);</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="number">0</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>[<span class="string">&#x27;headers&#x27;</span>]));</span><br></pre></td></tr></table></figure>

<p>이를 통과하는 코드:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;messageLines); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>])) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;headers&#x27;</span>][] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>사실 여기서 각 헤더도 첫번째 콜론(<code>:</code>)을 기준으로 key, value를 나눠야 한다.</p>
<p>아직 그걸 어디다 쓸 지는 모르는 척을 하기 위해 이대로 두기로 한다.</p>
<ul>
<li>아마도 가장 먼저 쓰일 곳은 브라우저의 캐시를 지원할 때일 것이다. 이 속도라면 50회 정도는 되어야겠군…</li>
</ul>
<h2 id="Message-Body"><a href="#Message-Body" class="headerlink" title="Message Body"></a>Message Body</h2><p>메시지 본문은 가져오기 쉽다. 헤더까지 가져온 다음 빈줄하나가 존재하면 나머지는 모두 메시지 본문이다. </p>
<p>다만 줄단위로 나눴던 나머지 메시지를 다시 붙여서 넣어야 한다.</p>
<p>이때 문제가 발생하겠지만, 걱정은 나중에 하고 메시지 본문을 result에 채워보자.</p>
<p>실패하는 테스트를 만들기 전 기초를 만들어 두자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBodyMayExistAfterHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$msgBeforeBody</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span> . PHP_EOL . <span class="string">&#x27;firstHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$result</span> = (<span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msgBeforeBody</span>))-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEmpty</span>(<span class="variable">$result</span>[<span class="string">&#x27;body&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>메시지가 헤더 파싱까지만 존재하기 때문에 메시지 본문은 비어있는 게 당연하다. 테스트는 통과한다.</p>
<p>이제 본문이 존재할 때 실패하는 테스트 작성.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBodyMayExistAfterHeaders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$msgBeforeBody</span> = <span class="built_in">self</span>::<span class="variable constant_">PERFECT_START_LINE</span> . PHP_EOL . <span class="string">&#x27;firstHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$result</span> = (<span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msgBeforeBody</span>))-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEmpty</span>(<span class="variable">$result</span>[<span class="string">&#x27;body&#x27;</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$msgBeforeBody</span> .= PHP_EOL . <span class="string">&#x27;secondHeader&#x27;</span>;</span><br><span class="line">    <span class="variable">$msgBeforeBody</span> .= PHP_EOL;<span class="comment">//empty line</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$bodyText</span> = <span class="string">&#x27;somebody to love&#x27;</span>;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="variable">$msgBeforeBody</span> . PHP_EOL . <span class="variable">$bodyText</span>;</span><br><span class="line">    <span class="variable">$result</span> = (<span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>))-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$bodyText</span>, <span class="variable">$result</span>[<span class="string">&#x27;body&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>parse()</code> 메소드에 </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseBody</span>();</span><br></pre></td></tr></table></figure>

<p>한줄 추가하고 테스트를 통과시키는 코드 작성.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//시작줄 + 헤더</span></span><br><span class="line">    <span class="variable">$emptyLineIndex</span> = <span class="number">1</span> + <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;result[<span class="string">&#x27;headers&#x27;</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$emptyLineIndex</span>]) ||</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$emptyLineIndex</span>] !== <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$bodyIndex</span> = <span class="variable">$emptyLineIndex</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$bodyIndex</span>])) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="variable">$bodyIndex</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;messageLines); <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;body&#x27;</span>] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>가운데 쯤 빈줄을 확인하는 코드는 사실 필요 없다. 빈줄이 없으면 다 헤더로 들어갔을테니까.</p>
<p>하지만 메시지 본문 앞에 공백이 있고 그래서 시작줄, 헤더 다음 1을 추가하는 코드(<code>$bodyIndex = $emptyLineIndex + 1;</code>)를 이해하기 쉽도록 남겨두기로 했다.</p>
<p>이제 다 끝인가 싶겠지만 몇가지 문제가 있다.</p>
<p>첫번째로, 본문에 개행이 들어가 있을 경우 제대로 동작하지 않는다. </p>
<p>테스트로 확인해보면,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$bodyText</span> .= PHP_EOL . <span class="string">&#x27;Help! I need somebody&#x27;</span>;</span><br><span class="line"><span class="variable">$bodyText</span> .= PHP_EOL . <span class="string">&#x27;Help! Not just anybody&#x27;</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="variable">$msgBeforeBody</span> . PHP_EOL . <span class="variable">$bodyText</span>;</span><br><span class="line"><span class="variable">$result</span> = (<span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$msg</span>))-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="variable">$bodyText</span>, <span class="variable">$result</span>[<span class="string">&#x27;body&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>통과하기.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$bodyIndex</span> = <span class="variable">$emptyLineIndex</span> + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$bodyIndex</span>])) &#123;</span><br><span class="line">    <span class="variable">$partsOfBody</span> = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="variable">$bodyIndex</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;messageLines); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$partsOfBody</span>[] = <span class="variable language_">$this</span>-&gt;messageLines[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;body&#x27;</span>] = <span class="title function_ invoke__">implode</span>(PHP_EOL, <span class="variable">$partsOfBody</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>또 하나의 문제는 애초에 메시지 본문을 <code>\r\n</code> 혹은 <code>\n</code>으로 줄단위로 나눴기 때문에</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;messageLines = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/(\r\n|\n)/&#x27;</span>, <span class="variable">$this</span>-&gt;message);</span><br></pre></td></tr></table></figure>

<p>이 놈을 다시 붙여줄 때는 <code>\r\n</code>으로 붙여야 할지 <code>\n</code>으로 붙여야 할지 모른다는 점이다.</p>
<p>이를 해결하려면 뭐로 나눴는지 기억하는 것도 방법이지만 메시지 본문 안에 <code>\r\n</code> 혹은 <code>\n</code>가 섞여 있다면 이 또한 문제다.</p>
<p>결국 전체 메시지에서 공백줄이 나타난 이후를 모두 잘라내는 쪽으로 코드를 수정해야 한다.</p>
<p>가독성 때문에 정규식을 쓰기 싫었지만, 쉽게 해결된다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;body&#x27;</span>] = <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(?:.+?)(?:\r\n|\n)&#123;2&#125;(.*)/s&#x27;</span>, <span class="variable">$this</span>-&gt;message, <span class="variable">$matches</span>) ? <span class="variable">$matches</span>[<span class="number">1</span>] : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/(?:.+?)(?:\r\n|\n)&#123;2&#125;(.*)/s</span><br></pre></td></tr></table></figure>

<p>이 정규식을 간단히</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/(아무 문자열)(개행)&#123;2개&#125;(나머지문자열)/개행을포함</span><br></pre></td></tr></table></figure>

<p>정도로 표현할 수 있겠다.</p>
<p>괄호 안의 <code>?:</code>는 캡쳐를 하지 않는다는 의미로, 만약 정규식을</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/(.+?)(\r\n|\n)&#123;2&#125;(.*)/s</span><br></pre></td></tr></table></figure>

<p>처럼 쓴다면 <code>$matches[1]</code>가 아니라 <code>$matches[3]</code>으로 변경해야 할 것이다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>어떻게든 돌아가는 코드를 만들어 놓기는 했지만 썩 마음에 들진 않는다.</p>
<p>무조건 전체 HTTP 메시지를 받아 한번에 파싱한 다음 결과를 리턴하는 구조인데,</p>
<p>나중에 스트리밍을 고려한다면 서버에 전송되는 메시지를 그때 그때 파서에 전달하고 파서에서는 받은 문자열을 버퍼에 쌓는 동시에 파싱을 진행해야할 것이다.</p>
<p>아직 해당 요구사항이 발견되지 않았다 치더라도,</p>
<p>분리하는 로직에서 개행문자로 한번에 나눠놓지 말고 개행이 나타나는 곳까지 읽은 후 적당한 위치에 넣어주기만 해도 훨씬 빠른 처리가 될 것이다.</p>
<p>하지만 난 그대로 둘 것이다.</p>
<p>다시 개발하기 싫으니까!</p>
<br>

<p>Season 1, 끝.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/11/08/phttp-09-parsing-request-message-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/08/phttp-09-parsing-request-message-02/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 09 - 요청 메시지 파싱 2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-11-08 19:22:06" itemprop="dateCreated datePublished" datetime="2017-11-08T19:22:06+09:00">2017-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/11/08/phttp-09-parsing-request-message-02/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/11/08/phttp-09-parsing-request-message-02/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h2 id="지난-시간에-우리는"><a href="#지난-시간에-우리는" class="headerlink" title="지난 시간에 우리는.."></a>지난 시간에 우리는..</h2><p>HTTP 메시지를 파싱하는 용도로 <code>HttpMessageParser</code>라는 역할을 분리하고 테스트를 만들기 시작했다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Server &lt;-&gt; Request &lt;-&gt; HttpMessageParser</span><br></pre></td></tr></table></figure>

<p><code>HttpMessageParser</code>는 <code>Request</code>가 필요로하는 최소한의 데이터 구조로 리턴을 하게 되어있고, 각각의 키가 반드시 존재(set)할 것을 테스트로 보장한다.</p>
<ul>
<li>소스가 약간 바뀌었으나 동일하게 동작한다</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReturnValue</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="literal">true</span>, <span class="title function_ invoke__">is_array</span>(<span class="variable">$result</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$requiredFields</span> = [</span><br><span class="line">        <span class="string">&#x27;start_line&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uri&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;headers&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$requiredFields</span> <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="variable">$field</span>, <span class="variable">$result</span>, <span class="string">&#x27;key &quot;&#x27;</span> . <span class="variable">$field</span> . <span class="string">&#x27;&quot; does not exist&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$message</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HttpMessageParser constructor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;message = <span class="variable">$message</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>) : <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;start_line&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;headers&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;body&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="예외-발생"><a href="#예외-발생" class="headerlink" title="예외 발생"></a>예외 발생</h2><p>(이 시리즈 초반에 테스트 용으로 만든 것과 같은) 엉망진창인 클라이언트가 존재하는 것을 감안하여 비정상 요청부터 감지하고자 한다.</p>
<p>어떤 요청 메시지가 비정상인가?</p>
<p>다시 한번 <code>HttpMessageParser</code>의 역할을 상기시키는 겸, 이 녀석이 분석해야할 정상 메시지의 구조는 아래와 같다.</p>
<ul>
<li>start_line : 시작줄<ul>
<li>method : 메소드</li>
<li>uri : URI</li>
<li>version : HTTP 버전</li>
</ul>
</li>
<li>headers : 헤더는 배열로(0개 이상)</li>
<li>body : 본문(없어도 OK)</li>
</ul>
<p>여기서 다시 HTTP 스펙으로 돌아가야 한다. </p>
<p>사실상 필수 요소라면 시작줄 뿐이지만, CRLF가 두개는 나와야 정상 메시지라고 볼 수 있다.</p>
<p>하지만 우리의 HTTP 프로토콜은 개떡같이 말해도 찰떡같이 이해하는 게 일상인 관대한 생태계가 받들고 있다.</p>
<p>나도 또한 관대하므로 시작줄만 3요소로 멀쩡히 들어온다면 문법 자체는 문제없는 요청이라 생각할 것이다. </p>
<p>하지만 이 조차도 지키지 못한다면 클라이언트에게 <code>400 Bad Request</code>라는 응답을 줄 것이다.</p>
<p>그럼 테스트부터 시작하자.</p>
<ol>
<li>예외가 발생했는지 확인하는 테스트를 만들고</li>
<li>예외를 발생시킨다</li>
</ol>
<p>기존 만들었던 테스트는 성공하는 케이스로, 새로 만드는 테스트는 실패하는 케이스로 바꿔준다:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReturnValue</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$goodMsg</span> = <span class="string">&#x27;GET / HTTP/1.1&#x27;</span>;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$goodMsg</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="literal">true</span>, <span class="title function_ invoke__">is_array</span>(<span class="variable">$result</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$requiredFields</span> = [</span><br><span class="line">        <span class="string">&#x27;start_line&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uri&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;headers&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$requiredFields</span> <span class="keyword">as</span> <span class="variable">$field</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="variable">$field</span>, <span class="variable">$result</span>, <span class="string">&#x27;key &quot;&#x27;</span> . <span class="variable">$field</span> . <span class="string">&#x27;&quot; does not exist&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidMessageCausesException</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$badMsg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$badMsg</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>결과 배열은 멤버 변수로 옮기고, parse() 메소드를 추가하고, 공백이 넘어오면 Exception 발생:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$message</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$result</span> = [</span><br><span class="line">        <span class="string">&#x27;start_line&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;headers&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;message = <span class="variable">$message</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parse</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;message == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Invalid message format.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>테스트를 그지같이 짜 놨더니 불안하다. 어서 비정상 메시지를 구분하는 코드를 더 넣어보자.</p>
<ol>
<li>CRLF 단위로 문자열을 잘라내고 첫번째 요소만 신경쓴다</li>
<li>공백으로 나누면 3개 이상의 요소가 되는지</li>
<li>이해할 수 있는 METHOD인지</li>
<li>URL은 &#x2F;로 시작하는지</li>
<li>프로토콜이 HTTP&#x2F;정수.정수 형식인지</li>
<li>…and?</li>
</ol>
<p>잠깐. 그럼 통과 못하는 문자열 여러개를 준비하고 이것들이 통과하는 테스트를 만들어야 하는데,</p>
<p>Exception 발생을 확인하는 메소드는 그 안의 여러개의 Exception이 발생한다 하더라도 첫번째 Exception 이후 동작하지 않는다.</p>
<p>그럼 비정상 문자열이 생각날 때마다 새로운 메소드를 만들어야 하는가?</p>
<p>꼼수가 있다.</p>
<h2 id="Data-Providers"><a href="#Data-Providers" class="headerlink" title="Data Providers"></a>Data Providers</h2><p><a target="_blank" rel="noopener" href="https://phpunit.de/manual/current/en/writing-tests-for-phpunit.html#writing-tests-for-phpunit.data-providers">Data Providers</a>는 테스트 메소드의 인자로 다량의 데이터를 밀어넣어줄 수 있는 annotation이다.</p>
<p>자세한 건 매뉴얼을 확인하도록 하고, 우선 Data Providers를 사용하도록 리팩토링, 그리고 실패하는 테스트를 하나 만든다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">badMessages</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        [<span class="string">&#x27;&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;haha&#x27;</span>],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dataProvider</span> badMessages</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@expectedException</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testInvalidMessageCausesException</span>(<span class="params"><span class="variable">$badMsg</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="variable">$badMsg</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>동작하는 테스트가 갖춰졌으니, 이제 <code>HttpMessageParser</code> 클래스의 <code>parse()</code> 메소드에서 놀면 된다.</p>
<h2 id="parse"><a href="#parse" class="headerlink" title="parse()"></a>parse()</h2><p>사실 실패하는 테스트를 만들기 전에 CRLF로 나누는 리팩토링 먼저 됐으면 좋았겠지만…</p>
<p>이왕 이렇게 된 거 시작줄이 3개의 요소로 되어 있는지를 확인하는 구문까지 진도를 쫙 빼본다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//메시지를 \r\n 혹은 \n으로 나누기</span></span><br><span class="line">    <span class="variable">$messageSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/(\r\n|\n)/&#x27;</span>, <span class="variable">$this</span>-&gt;message);</span><br><span class="line">    <span class="comment">//각 줄의 양 끝 공백은 제거한다</span></span><br><span class="line">    <span class="title function_ invoke__">array_walk</span>(<span class="variable">$messageSplit</span>, function(&amp;<span class="variable">$item</span>)&#123;</span><br><span class="line">        <span class="variable">$item</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$item</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//시작줄은 있어야 한다</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$messageSplit</span>) || <span class="keyword">empty</span>(<span class="variable">$messageSplit</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Invalid message format.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//시작줄을 whitespace로 나누기</span></span><br><span class="line">    <span class="variable">$startLine</span> = <span class="variable">$messageSplit</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$startLineSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/\s/&#x27;</span>, <span class="variable">$startLine</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$startLineSplit</span>) || <span class="title function_ invoke__">count</span>(<span class="variable">$startLineSplit</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Invalid message format.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TDD의 기본을 되새김해보면</p>
<ul>
<li>Red : 실패하는 테스트를 작성하고, 실패하는 것을 확인</li>
<li>Green : 이를 통과하는 최소한의 코드를 작성하고</li>
<li>Refactor : 리팩토링하는 과정</li>
</ul>
<p>지금은 Refactoring 타임.</p>
<p>테스트가 통과하는 코드를 만들었지만 벌써 중복이 발생했다.</p>
<p>Custom Exception을 만들어야 할 것만 같은 충동에 휩싸였지만 이내 정신을 차리고 메소드로 분리하는 전략을 선택했다.</p>
<p>만약, 이건 만약인데,</p>
<p>당신이 PHPStorm을 쓴다면..</p>
<p>Refactor 기능으로 중복 코드를 발라낼 수 있다.</p>
<p>추출할 영역을 선택 &gt; 우클릭 &gt; Refactor &gt; Extract &gt; Method…<br><img src="/images/phttp-09/refactor01.png" alt="add_unittest_1"></p>
<p>Parameter가 필요하다면 이를 설정할 수도 있지만 이건 단순한 메소드니까.<br><img src="/images/phttp-09/refactor02.png" alt="add_unittest_2"></p>
<p>동일한 코드가 발견되면 같이 발라낼 것인지 물어보기도 한다.<br><img src="/images/phttp-09/refactor03.png" alt="add_unittest_3"></p>
<p>짜잔!</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//메시지를 \r\n 혹은 \n으로 나누기</span></span><br><span class="line">    <span class="variable">$messageSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/(\r\n|\n)/&#x27;</span>, <span class="variable">$this</span>-&gt;message);</span><br><span class="line">    <span class="comment">//각 줄의 양 끝 공백은 제거한다</span></span><br><span class="line">    <span class="title function_ invoke__">array_walk</span>(<span class="variable">$messageSplit</span>, function(&amp;<span class="variable">$item</span>)&#123;</span><br><span class="line">        <span class="variable">$item</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$item</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//시작줄은 있어야 한다</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$messageSplit</span>) || <span class="keyword">empty</span>(<span class="variable">$messageSplit</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//시작줄을 whitespace로 나누기</span></span><br><span class="line">    <span class="variable">$startLine</span> = <span class="variable">$messageSplit</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$startLineSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/\s/&#x27;</span>, <span class="variable">$startLine</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$startLineSplit</span>) || <span class="title function_ invoke__">count</span>(<span class="variable">$startLineSplit</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">throwInvalidMessageFormat</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Invalid message format.&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>쉽다.</p>
<ul>
<li>당신이 PHPStorm을 쓴다면..</li>
</ul>
<p>또다시 실패하는 테스트 케이스 추가.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">badMessages</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        [<span class="string">&#x27;&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;haha&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;하나 둘 셋&#x27;</span>],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(어떤 바보가 ‘시 작 줄’과 같이 요청하겠냐마는) 이 테스트는 실패한다.</p>
<p>왜냐면 지금까지 구현한 기능은 이를 완벽한 요청 시작줄로 인식하고 Exception을 뱉지 않기 때문이다.</p>
<p>그럼 공백으로 나눈 시작줄 요소가 각각 다음을 만족하는 지 확인하는 코드를 짜야 한다. </p>
<ul>
<li>method : 메소드</li>
<li>uri : URI</li>
<li>version : HTTP 버전</li>
</ul>
<p>또다시 실패하는 테스트 케이스 추가.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">badMessages</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        [<span class="string">&#x27;&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;haha&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;GET 둘 셋&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;POST 둘 셋&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;HEAD 둘 셋&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;HEAD / 셋&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;HEAD /index 셋&#x27;</span>],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>성공하는 코드 추가.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//메시지를 \r\n 혹은 \n으로 나누기</span></span><br><span class="line">    <span class="variable">$messageSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/(\r\n|\n)/&#x27;</span>, <span class="variable">$this</span>-&gt;message);</span><br><span class="line">    <span class="comment">//각 줄의 양 끝 공백은 제거한다</span></span><br><span class="line">    <span class="title function_ invoke__">array_walk</span>(<span class="variable">$messageSplit</span>, function(&amp;<span class="variable">$item</span>)&#123;</span><br><span class="line">        <span class="variable">$item</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$item</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//시작줄은 있어야 한다</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$messageSplit</span>) || <span class="keyword">empty</span>(<span class="variable">$messageSplit</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//시작줄을 whitespace로 나누기</span></span><br><span class="line">    <span class="variable">$startLine</span> = <span class="variable">$messageSplit</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$startLineSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/\s/&#x27;</span>, <span class="variable">$startLine</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$startLineSplit</span>) || <span class="title function_ invoke__">count</span>(<span class="variable">$startLineSplit</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$method</span> = <span class="variable">$startLineSplit</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$uri</span> = <span class="variable">$startLineSplit</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$version</span> = <span class="variable">$startLineSplit</span>[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//check Method</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$method</span>) || !<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;supportMethods)) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//check URI</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$uri</span>) || <span class="title function_ invoke__">strpos</span>(<span class="variable">$uri</span>, <span class="string">&#x27;/&#x27;</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//check version</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$version</span>) || !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/HTTP\/\d+.\d+/&#x27;</span>, <span class="variable">$version</span>)) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>테스트 케이스는 충분한 것 같은데(그렇다고 하자) 마지막에 추가한 버전 체크가 잘 동작하는 게 맞는지 불안할 수 있다.</p>
<p>나는 badMessages쪽에 살짝 넣어보고 안심하긴 했지만, 정상적인 시작줄은 whitelist에서 다뤄야 할 것 같다.</p>
<p>그 전에 리팩토링할 것이 있나 찾아보자.</p>
<h2 id="또-refactoring"><a href="#또-refactoring" class="headerlink" title="또 refactoring"></a>또 refactoring</h2><p>클래스가 바뀌어야 하는 이유는 단 한가지여야 한다는 단일 책임의 원칙을 메소드까지 확장해서 생각해보자.</p>
<p><code>parse()</code> 메소드가 바뀌는 상황을 상상해보면</p>
<ul>
<li>우리는 시작줄을 대충 whitespace(<code>\s</code>)로 나누었지만 <code>\s</code>엔 <code>\n</code>도 포함이라서 이를 좀 더 정교하게 만들 수도 있다</li>
<li>지원하는 HTTP 메소드 혹은 표준에서 정의하는 메소드 종류는 계속 늘어날 수 있다</li>
<li>URI 규칙을 좀 더 구체적으로 정의한다면? <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Directory_traversal_attack">Directory traversal attack</a>은?</li>
<li>지원하는 HTTP 버전에 따른 응답을 처리하게될 지도 모른다</li>
</ul>
<p>아직 생기지도 않은 요구 사항을 미리 구현하는 건 반대지만, 대비하는 것은 필요하다.</p>
<p>게다가 이미 <code>parse()</code> 메소는 그 안에 다루고 있는 지식이 꽤나 많고, 13인치 맥북에선 한 화면에 볼 수 없을 만큼 길어지고 있다.</p>
<p>따라서 누군가(혹은 6개월 후의 당신이) 유지보수를 위해 <code>server.php</code>에서부터 관련 클래스를 타고타고 들어와 <code>parse()</code>까지 도달했을 때는 이 안에서 어떤 일을 하고 있는지 한눈에 볼 수 없다.</p>
<p><code>parse()</code> 메소드에서 하는 일을 말로 풀어보자.</p>
<ol>
<li>메시지를 줄 단위로 나눈다</li>
<li>시작줄을 검사한다<ol>
<li>시작줄을 공백으로 나눈다</li>
<li>메소드를 확인한다</li>
<li>URI를 확인한다</li>
<li>버전을 확인한다</li>
</ol>
</li>
</ol>
<p>이 걸 그대로 private 메소드로 분리해본다. 당연히 하나하나 분리할 때마다 테스트가 동작하는지는 확인해야 한다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$message</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$messageLines</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$result</span> = [</span><br><span class="line">        <span class="string">&#x27;start_line&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;headers&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$supportMethods</span> = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>,];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;message = <span class="variable">$message</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parse</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">splitMessageIntoLines</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLine</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">throwInvalidMessageFormat</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Invalid message format.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 메시지를 \r\n 혹은 \n으로 나누기</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">splitMessageIntoLines</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;messageLines = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/(\r\n|\n)/&#x27;</span>, <span class="variable">$this</span>-&gt;message);</span><br><span class="line">        <span class="comment">//각 줄의 양 끝 공백은 제거한다</span></span><br><span class="line">        <span class="title function_ invoke__">array_walk</span>(<span class="variable">$this</span>-&gt;messageLines, function (&amp;<span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="variable">$item</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$item</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLine</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">splitStartLineInto3Components</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineMethod</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineURI</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">verifyStartLineVersion</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">splitStartLineInto3Components</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//시작줄은 있어야 한다</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;messageLines) || <span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;messageLines[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//시작줄을 whitespace로 나누기</span></span><br><span class="line">        <span class="variable">$startLine</span> = <span class="variable language_">$this</span>-&gt;messageLines[<span class="number">0</span>];</span><br><span class="line">        <span class="variable">$startLineSplit</span> = <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/\s/&#x27;</span>, <span class="variable">$startLine</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$startLineSplit</span>) || <span class="title function_ invoke__">count</span>(<span class="variable">$startLineSplit</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>] = <span class="variable">$startLineSplit</span>[<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineMethod</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>]) || !<span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;result[<span class="string">&#x27;method&#x27;</span>], <span class="variable">$this</span>-&gt;supportMethods)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineURI</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>]) || <span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;result[<span class="string">&#x27;uri&#x27;</span>], <span class="string">&#x27;/&#x27;</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyStartLineVersion</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>]) || !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/HTTP\/\d+.\d+/&#x27;</span>, <span class="variable">$this</span>-&gt;result[<span class="string">&#x27;version&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">throwInvalidMessageFormat</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>이제 겨우 최소한으로 허용하는 메시지에 대한 규칙이 정의됐다.</p>
<p>다음 글에서는 나머지 항목을 채우는 과정이 진행될 것 같다.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/11/02/phttp-08-parsing-request-message-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/02/phttp-08-parsing-request-message-01/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 08 - 요청 메시지 파싱 1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-11-02 18:58:31" itemprop="dateCreated datePublished" datetime="2017-11-02T18:58:31+09:00">2017-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/11/02/phttp-08-parsing-request-message-01/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/11/02/phttp-08-parsing-request-message-01/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<p>이제 요청 들어온 메시지를 적당히 분리하는 작업을 하려고 한다.</p>
<h2 id="지난-시간에-우리는"><a href="#지난-시간에-우리는" class="headerlink" title="지난 시간에 우리는.."></a>지난 시간에 우리는..</h2><p>마지막으로 커밋된 소스는 <a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp/commit/398f18ee98f0e6f9c00fe7bb262d82f9c5282f68">여기</a>에서 볼 수 있다.</p>
<p>요청 분석 클래스인 Request.php만 보자면</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$requestMessage</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$requestMessage</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//하지만 아직 쓰진 않지</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;requestMessage = <span class="variable">$requestMessage</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourcePath</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;/index.html&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>테스트 코드는</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//RequestTest.php</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...생략...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetResourcePath</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$request</span> = <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="string">&#x27;/index.html&#x27;</span>, <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getResourcePath</span>());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>고백하자면 Request 클래스의 생성자에 string 형식만 올 수 있게 조금 고쳐놨다.</p>
<h2 id="요구-사항-정리"><a href="#요구-사항-정리" class="headerlink" title="요구 사항 정리"></a>요구 사항 정리</h2><p>이제 생성자에 다양한 패턴의 문자열을 던지고 이를 적당한(?) 구조에 넣어줄 것이다.</p>
<p>개발을 시작하기 전에 요구 사항(HTTP의 문법)부터 면밀히 살펴보자.</p>
<p>(그런데 사실 이미 HTTP 메시지 파서는 널리고 널려서 굳이 직접 구현할 필요는 없다. 공부나 하자는 것이지..)</p>
<p>HTTP 메시지에 관한 표준은 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7230">RFC 7230, HTTP&#x2F;1.1: Message Syntax and Routing</a>에 정의되어 있다. </p>
<ul>
<li>아직도 RFC2616으로 설명하는 글이 많은데, 바뀐지 3년 지났다</li>
</ul>
<p>귀찮다면 뭐…이전에 정리한 <a href="/2017/08/23/http-the-definitive-guide-chapter-3/">3장 정리 자료</a>를 봐도 된다.</p>
<p>기본적인 HTTP 메시지의 문법을 다시 한번 살펴보자.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP-message   = start-line</span><br><span class="line">                 *( header-field CRLF )</span><br><span class="line">                 CRLF</span><br><span class="line">                 [ message-body ]</span><br></pre></td></tr></table></figure>

<p>HTTP 메시지</p>
<ul>
<li>시작줄</li>
<li>0개 이상의 헤더</li>
<li>(헤더의 끝을 인식하기 위해) 아무 것도 없는 빈 줄</li>
<li>(생략 가능한) 본문</li>
</ul>
<p>각 항목은 CRLF로 구분하도록 정의되어 있다. </p>
<ul>
<li>하지만 받는 쪽에서는 CR은 무시하고 LF만 인식할 수도 있다.</li>
<li>CRLF를 제외하고 앞뒤로 붙는 공백은 제거한다</li>
</ul>
<p>시작줄에는 공백(8bit 문자)으로 구분되는 세가지 정보가 들어간다.</p>
<ul>
<li>요청 시 : HTTP 메소드, URI, HTTP 버전</li>
<li>응답 시 : HTTP 버전, 상태 코드, 상태 메시지</li>
</ul>
<p>요청 메시지에서, HTTP는 URI(Uniform Resource Identifier)를 표현하는데 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3986">RFC3986</a>​​표준을 사용한다.</p>
<ul>
<li>그런데 이 표준을 보고 올바른 URI인지 판별할 생각은 없으므로 상식으로만 알아두자</li>
</ul>
<p>이정도를 기본 문법으로 정의하고, 이외의 문법으로 요청이 들어오면 서버가 이해하지 못한다는 의미로 <code>400 Bad Request</code>로 응답한다. </p>
<p>이를 기초로 기능을 간단히 정리해보면</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CRLF로 문자열을 나눈다</span><br><span class="line">- 첫 요소를 시작줄로</span><br><span class="line">- 이후 빈 문자열이 들어올 때까지 헤더로</span><br><span class="line">- 그 다음 요소가 존재하면 본문으로 인식한다</span><br><span class="line">- 각 요소를 저장할 땐 trim</span><br><span class="line">시작줄은 공백으로 3파트로 나뉘어야 한다</span><br><span class="line">- 메소드</span><br><span class="line">- URI</span><br><span class="line">- HTTP 버전</span><br><span class="line">이 파싱 기준을 조금이라도 벗어나면 가차없이 400!!</span><br></pre></td></tr></table></figure>

<h2 id="parseMessage-메소드-추가"><a href="#parseMessage-메소드-추가" class="headerlink" title="parseMessage() 메소드 추가"></a>parseMessage() 메소드 추가</h2><p>파싱을 시작하라고 요청하는 메소드는 <code>parseMessage()</code>라는 이름이 적당할 것 같고, 이제 테스트를 만들어 나갈 타이밍인데 바로 고민이 생긴다.</p>
<p>생성자에 문자열을 넣는 동시에 파싱을 할 것인가?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$requestMessage</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;requestMessage = <span class="variable">$requestMessage</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseMessage</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>아니면 <code>getResourcePath()</code>를 실행할 때 파싱을 실행할 것인가?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourcePath</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseMessage</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;resourcePath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>아니면 <code>parseMessage()</code> 메소드를 public으로 만들어 외부에서 명시적으로 호출하고, 이어 <code>getResourcePath()</code>로 리소스 경로를 얻어와야 하나?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//server.php</span></span><br><span class="line"><span class="variable">$request</span> = <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="variable">$clientSentData</span>);</span><br><span class="line"><span class="variable">$request</span>-&gt;<span class="title function_ invoke__">parseMessage</span>();</span><br><span class="line"><span class="variable">$response</span> = (<span class="keyword">new</span> <span class="title class_">Response</span>())-&gt;<span class="title function_ invoke__">getResponse</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getResourcePath</span>());</span><br></pre></td></tr></table></figure>

<p>아직 <code>server.php</code> 이외에 이 <code>Request</code> 클래스를 사용하는 곳이 없으므로 파싱 기능을 굳이 외부에 노출 시킬 필요가 없기 때문에, 우선은 <code>parseMessage()</code> 메소드를 private으로 묶어두기로 했다.</p>
<p>외부에 노출할 경우, 이 분석 클래스를 바라보는 클라이언트가 늘어갈수록 수정하는데 눈치가 보인다. 공개 API가 덕지덕지 버전을 붙여가는 이유랄까.</p>
<p>외부 노출은 최소한으로 줄이고, 내부 구현을 마음껏 리팩토링하자.</p>
<p><code>getResourcePath()</code> 안에서 <code>parseMessage()</code> 메소드를 호출하도록 바꿔보자.</p>
<p><code>server.php</code> 입장에선 <code>Request</code> 클래스를 사용하는 방법이 바뀐 게 아니므로 추가 테스트는 작성 안한다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Request.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourcePath</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseMessage</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;resourcePath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>테스트는 바로 실패하고</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Call to undefined method Request::parseMessage()</span><br></pre></td></tr></table></figure>

<p>테스트를 통과하도록 수정한다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Request.php</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$requestMessage</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$resourcePath</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$requestMessage</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//하지만 아직 쓰진 않지</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;requestMessage = <span class="variable">$requestMessage</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourcePath</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseMessage</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;resourcePath;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">parseMessage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;resourcePath = <span class="string">&#x27;/index.html&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>테스트는 성공한다.</p>
<h2 id="중간-점검"><a href="#중간-점검" class="headerlink" title="중간 점검"></a>중간 점검</h2><p>앞으로는 뭘 해야할까?</p>
<p><code>parseMessage()</code> 안에서 <code>resourcePath</code>를 CRLF로 잘라 분리해놓고,</p>
<p><code>/</code>라는 URI로 요청이 왔으면 <code>/index.html</code>을 리턴하는 로직도 들어가야 하고,</p>
<p>이해 안되는 구문이면 외부에 알려야 한다.</p>
<ul>
<li>“이건 Bad Bad Request야”</li>
</ul>
<p>그런데 그 과정에서 몇개의 private 메소드가 더 생길 것이고(메소드 하나에는 하나의 기능을 담는 것이 좋으니)</p>
<p>모두 완료될 때까지 외부(<code>server.php</code>)에 노출되는 건 계속 <code>parseMessage()</code> 뿐일 것이다.</p>
<p><a href="/2017/10/30/phttp-07/">바로 이전 글</a>에서 <a target="_blank" rel="noopener" href="https://justhackem.wordpress.com/2017/09/29/should-private-methods-be-tested/">비공개(private) 메소드 테스트</a>에 관한 글을 링크했었다.</p>
<blockquote>
<p>비공개 메서드의 모든 코드를 비공개 메서드에 독립적인 방법으로 테스트 하라</p>
</blockquote>
<p>어떻게든 다양한 문자열을 던져주면서 <code>parseMessage()</code>의 모든 코드를 거쳐갈 수 있게 테스트를 만들면 될 것이다.</p>
<p>그런데 또 다른 관점으로도 생각해보자.</p>
<h2 id="단일-책임-원칙"><a href="#단일-책임-원칙" class="headerlink" title="단일 책임 원칙"></a>단일 책임 원칙</h2><p><a target="_blank" rel="noopener" href="https://ko.wikipedia.org/wiki/%EB%8B%A8%EC%9D%BC_%EC%B1%85%EC%9E%84_%EC%9B%90%EC%B9%99">단일 책임 원칙</a>은 한 클래스에서 하나의 책임을 갖는다는 것(…정도로 얼버무리고).</p>
<p><code>Request</code> 클래스를 구현해나가다 보니,</p>
<ul>
<li>앞서 언급한 룰에 따라 HTTP 메시지의 각 요소로 나누는 역할이 하나.</li>
<li>그 나뉜 요소를 읽고 어떤 판단을 하는 로직(예를 들어 <code>/</code>는 <code>/index.html</code>)이 하나.</li>
<li>아직 어떻게 구현할지는 생각 안했지만 외부에 비정상 요청임을 알리는 기능 하나.</li>
</ul>
<p>이쯤되면 <code>Request</code> 클래스의 역할을 분명히 하고, 하나의 독립된 책임으로 캡슐화할 수 있는 건 별도의 클래스로 빼는 걸 고려할 법 하다.</p>
<p>우리는 파싱을 다루고 있었으니</p>
<p>Server &lt;-&gt; Request &lt;-&gt; HttpMessageParser</p>
<p>정도로 우선 분리해본다.</p>
<p>서버는 클라이언트로부터 HTTP 메시지를 수신한 후,</p>
<p>이 문자열을 <code>Request</code>에 전달하면 그 내부에서 뭘 어쩌는 지 서버는 관심없고 단지 그 분석 결과(정상 여부, 리소스 경로 등)을 받아온다.</p>
<p>(나중에 어찌 변할 지 몰라도) 서버 입장에서 <code>Request</code> 클래스의 역할은 <code>문자열을 받아 분석 결과를 리턴한다</code>로 정하겠다.</p>
<p><code>Request</code> 클래스는 HttpMessageParser에게 HTTP 메시지의 각 요소로 나눠달라고 요청한다.</p>
<p>그럼 HttpMessageParser를 분리하기 위해 테스트부터.</p>
<h2 id="HttpMessageParser-클래스"><a href="#HttpMessageParser-클래스" class="headerlink" title="HttpMessageParser 클래스"></a>HttpMessageParser 클래스</h2><p><code>HttpMessageParser</code> 클래스는 두 군데서 사용하게 된다. <code>Request</code> 클래스와 단위 테스트.</p>
<p>이 클래스의 역할은 문자열을 받아, 특정 구조로 데이터를 리턴하는 것이다. 우선 연관 배열을 리턴하는 것부터 시작해볼까?</p>
<p>첫 단위 테스트에서는 리턴된 배열에서 각 항목이 set되어 있는지만 확인한다.</p>
<p>PHPStorm을 사용한다면 손쉽게 테스트 파일을 추가할 수 있다.</p>
<p><code>libs</code> 디렉토리에 <code>HttpMessageParser.php</code>를 생성하고, </p>
<p>우클릭 &gt; New &gt; PHPUnit &gt; HttpMessageParserTest 선택</p>
<p><img src="/images/phttp-08/add_unittest_1.png" alt="add_unittest_1"></p>
<p>테스트 대상 클래스, 테스트 파일명과 위치할 디렉토리를 써주면</p>
<p><img src="/images/phttp-08/add_unittest_2.png" alt="add_unittest_2"></p>
<p>테스트가 생성된다.</p>
<p><img src="/images/phttp-08/add_unittest_3.png" alt="add_unittest_3"></p>
<p>리턴되는 값에는 기본적으로 아래와 같은 항목이 필요할 것 같다.</p>
<ul>
<li>start_line : 시작줄 전체</li>
<li>method : 메소드</li>
<li>uri : URI</li>
<li>version : HTTP 버전</li>
<li>headers : 헤더는 배열로</li>
<li>body : 본문</li>
</ul>
<p>테스트를 만들자.</p>
<p>테스트 클래스(<code>tests/HttpMessageParserTest.php</code>) 안에서도 (PHPStorm을 쓴다면!) <code>Generate</code>라는 기능을 메소드를 빨리 추가할 수 있다. 약간의 타이핑을 줄여주는 수준이지만 이런 게 생산성을 높여주는 법이다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpMessageParserTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testReturnValue</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$parser</span> = <span class="keyword">new</span> <span class="title class_">HttpMessageParser</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$parser</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="literal">true</span>, <span class="title function_ invoke__">is_array</span>(<span class="variable">$result</span>));</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="string">&#x27;start_line&#x27;</span>, <span class="variable">$result</span>, <span class="string">&#x27;key start_line not exists&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="string">&#x27;method&#x27;</span>, <span class="variable">$result</span>, <span class="string">&#x27;key method not exists&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="string">&#x27;uri&#x27;</span>, <span class="variable">$result</span>, <span class="string">&#x27;key uri not exists&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="string">&#x27;version&#x27;</span>, <span class="variable">$result</span>, <span class="string">&#x27;key version not exists&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="string">&#x27;headers&#x27;</span>, <span class="variable">$result</span>, <span class="string">&#x27;key headers not exists&#x27;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertArrayHasKey</span>(<span class="string">&#x27;body&#x27;</span>, <span class="variable">$result</span>, <span class="string">&#x27;key body not exists&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp">Github</a>에서 커밋 로그를 보면 알겠지만, 하나하나 테스트부터 만들고 이를 통과하는 기능을 구현했다.</p>
<p><img src="/images/phttp-08/getResultTest.png" alt="add_unittest_3"></p>
<ul>
<li>당신이 PHPStorm을 쓴다면..</li>
</ul>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>다음 글에서는 <code>Request</code> 클래스에서 <code>HttpMessageParser</code>를 가져다 쓰기 전에, 기본 파싱에 필요한 기능을 테스트와 함께 작성하려고 한다.</p>
<p>결론은 당신이 PHPStorm을 쓴다면 좀 더 편하게 할 수 있다.<br>(이제 그만 말할까…)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/11/01/baking-00/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/01/baking-00/" class="post-title-link" itemprop="url">베이킹 - 준비 완료</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-11-01 22:51:24" itemprop="dateCreated datePublished" datetime="2017-11-01T22:51:24+09:00">2017-11-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/11/01/baking-00/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/11/01/baking-00/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>여기가 개발 블로그인 줄 아시는 분은 당황스러우시겠지만…</p>
<h2 id="베이킹의-세계로"><a href="#베이킹의-세계로" class="headerlink" title="베이킹의 세계로"></a>베이킹의 세계로</h2><p><img src="/images/baking-00/iAmReady.jpg" alt="베이킹 준비 완료 이미지"></p>
<p>토비 이일민 님이 추천하신 책 <code>밀가루 물 소금 이스트</code>라는 책을 읽고 진짜로 한번 해봐야겠다는 생각이 들어 장비를 구입하기 시작.</p>
<p>책이 정말 정말 좋다. 처음에 너무 몰라서 ‘클린 소프트웨어’처럼 느껴지던 책이, (아직 기본빵까지 읽었지만) 두번 세번 읽으니 잘 이해가 된다. 이러다보니 내가 어렵다고 생각했던 책도 두 세번 읽으면 이해가 잘 되었을텐데 왜 그렇게 지쳤었나 모르겠다. 스터디라서 (어쩔 수 없이) 이해하려고 몇번이나 읽었던 책은 확실히 이해도가 높았는데…좋은 책 몇 권 골라서 다시 읽어야 할 듯.</p>
<p>자, 이제 주물 냄비 시즈닝도 마치고, 금요일 첫 베이킹을 앞두고 머릿속으로 쉐도우 복싱 중이다. 유럽식 빵과 우유 식빵 두가지 도전하기로…</p>
<p>유럽식 빵은 <code>밀가루 물 소금 이스트</code>의 레시피를 보고 만들 생각이고<br><img src="http://image.kyobobook.co.kr/images/book/large/883/l9788971905883.jpg" alt="밀가루 물 소금 이스트 이미지"></p>
<p>식빵은 <code>후암동 식빵</code>의 레시피를 참고할 것이다.<br><img src="http://image.kyobobook.co.kr/images/book/large/142/l9791187320142.jpg" alt="후암동 식빵 이미지"></p>
<p>둘 다 사전 발표를 충분히 해서 만드는 게 공통점이나, 역시 설명은 <code>밀가루 물 소금 이스트</code>만 한 게 없다.</p>
<p>이제 우리 집은 주말엔 빵이 주식이다! (단호)</p>
<h2 id="₩163-500"><a href="#₩163-500" class="headerlink" title="₩163,500"></a>₩163,500</h2><p>재료 소개를 하자면, 일부는 방산 시장에서 건져오고, 인터넷으로 산 건 오늘의 로켓 배송으로 모두 도착했다. 진짜 최소한으로 필요한 것만 샀다.</p>
<p>라바 주물 냄비(24cm)는 쿠팡에 87,000원에 뜬 걸 보고 얼른 구매했고, 요리용 온도계와 저울은 드레텍 사의 것으로 각각 12,000원, 21,000원. 오븐용 온도계 8,000원. 1&#x2F;8까지 있는 계량스푼 4,400원. 실리콘패드 11,250원. 사프인스턴트 드라이이스트 125g 1,900원. 큐원 강력 밀가루 1kg 1,550원 3개, 프랑스 밀가루 T55, T65 각각 1kg 2,500원, 2,900원 2개씩.</p>
<p>총 163,500원. 선방했다. 밀가루 하나는 덧가루용으로 쓰고, 저 6kg 안에서 제대로 하나라도 맛있게 구우면 성공이라고 생각.</p>
<br>

<p>(애드센스로 돈 벌 생각 하느니 주위에 빵을 만들어 파는 게 더 빠르겠다)</p>
<h2 id="₩204-600"><a href="#₩204-600" class="headerlink" title="₩204,600"></a>₩204,600</h2><p>글을 올리자 마자 혹시나 하고 찾아본 <code>Cambro RFSCW12</code> 모델. 책에서 추천해준 바로 그 반죽통을 <a target="_blank" rel="noopener" href="https://www.amazon.com/Cambro-Capacity-Polycarbonate-Container-Separately/dp/B004NEWCDC">아마존</a>보다 싸게 파는 곳이 있는 게 아닌가!</p>
<p>이건 정말 필수라고 볼 수는 없는데, 큰 반죽통이 필요하긴 해서…</p>
<p>많이 고민해봤는데 저만한 스댕 반죽통도 2만원은 하기 때문에…</p>
<p>그래서 꼭 필요하진 않아도 꽤 필요한데…</p>
<p>여보… </p>
<p>여보… </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/30/phttp-07/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/30/phttp-07/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 07 - 첫 테스트, Response 분리</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-30 19:39:10" itemprop="dateCreated datePublished" datetime="2017-10-30T19:39:10+09:00">2017-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/30/phttp-07/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/30/phttp-07/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h1 id="테스트-주도로-시작하기"><a href="#테스트-주도로-시작하기" class="headerlink" title="테스트 주도로 시작하기"></a>테스트 주도로 시작하기</h1><p>지금까지의 Request 분석 클래스는 아래와 같다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$requestMessage</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$requestMessage</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//하지만 아직 쓰진 않지</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;requestMessage = <span class="variable">$requestMessage</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResponse</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = PROJECT_ROOT . <span class="string">&#x27;/public/index.html&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;HTTP/1.0 404 파일 없음&#x27;</span> . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$responseBody</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>));</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;Content-Type: text/html&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="variable">$responseBody</span> . PHP_EOL;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="첫-테스트"><a href="#첫-테스트" class="headerlink" title="첫 테스트"></a>첫 테스트</h2><p>의미 없는 코드지만 테스트가 존재하면 성공하는지나 살펴보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testCanBeCreated</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertInstanceOf</span>(</span><br><span class="line">            <span class="title class_">Request</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Request</span>([])</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>결과는,</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Testing started at PM 7:57 ...</span><br><span class="line">PHPUnit 6.4.3 by Sebastian Bergmann and contributors.</span><br><span class="line">    </span><br><span class="line">Time: 59 ms, Memory: 4.00MB</span><br><span class="line">    </span><br><span class="line">OK (1 test, 1 assertion)</span><br></pre></td></tr></table></figure>

<p>이건 너무 당연한 테스트 코드라서 낭비다. 지워버리고 의미있는 테스트를 만들어보자.</p>
<h2 id="다시-첫-테스트"><a href="#다시-첫-테스트" class="headerlink" title="다시 첫 테스트"></a>다시 첫 테스트</h2><p><code>server.php</code>에서 <code>Request.php</code>으로 기능을 가져왔으니 뭔가 테스트할 거리가 있을 것 같다.</p>
<p>우선 <code>__construct</code>.</p>
<p>하는 일이라곤 생성자로 전달된 값을 private 변수에 담는 것 뿐인데, 이걸 테스트로 만들 필요가 있을까?</p>
<p>물론 테스트는 만들 수 있다.</p>
<p>굳이 굳이 <code>Request</code> 클래스에 private 변수를 꺼내올 수 있는 public method를 만들 수도 있고.</p>
<p>Request.php :</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRequestMessage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;requestMessage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RequestTest.php :</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testConstructByGetter</span>(<span class="params"></span>) : <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$requestMessage</span> = [<span class="string">&#x27;testKey&#x27;</span> =&gt; <span class="string">&#x27;testVal&#x27;</span>];</span><br><span class="line">    <span class="variable">$request</span> = <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="variable">$requestMessage</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$valueByGetter</span> = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getRequestMessage</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(</span><br><span class="line">        <span class="title function_ invoke__">serialize</span>(<span class="variable">$requestMessage</span>), </span><br><span class="line">        <span class="title function_ invoke__">serialize</span>(<span class="variable">$valueByGetter</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(하긴 막 짜려면 gettter도 필요없이 <code>requestMessage</code> 변수를 public으로 만들고 <code>$request-&gt;requestMessage;</code>처럼 막 갖다 써도..)</p>
<p>또한, 굳이 굳이 Reflection으로 private 변수를 들여다 볼 수 도 있다.</p>
<p>RequestTest.php :</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testConstructByReflection</span>(<span class="params"></span>) : <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$requestMessage</span> = [<span class="string">&#x27;testKey&#x27;</span> =&gt; <span class="string">&#x27;testVal&#x27;</span>];</span><br><span class="line">    <span class="variable">$request</span> = <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="variable">$requestMessage</span>);</span><br><span class="line">    <span class="variable">$reflectionClass</span> = <span class="keyword">new</span> <span class="title class_">\ReflectionClass</span>(<span class="variable">$request</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$reflectionProperty</span> = <span class="variable">$reflectionClass</span>-&gt;<span class="title function_ invoke__">getProperty</span>(<span class="string">&#x27;requestMessage&#x27;</span>);</span><br><span class="line">    <span class="variable">$reflectionProperty</span>-&gt;<span class="title function_ invoke__">setAccessible</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$privateVal</span> = <span class="variable">$reflectionProperty</span>-&gt;<span class="title function_ invoke__">getValue</span>(<span class="variable">$request</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(</span><br><span class="line">        <span class="title function_ invoke__">serialize</span>(<span class="variable">$requestMessage</span>),</span><br><span class="line">        <span class="title function_ invoke__">serialize</span>(<span class="variable">$privateVal</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>다시 질문. <code>이걸 테스트로 만들 필요가 있을까?</code></p>
<p>생성자에 받은 녀석을 그대로 멤버 변수에 넣었는데 이게 잘 들어갔는지 확인할 필요는 없어보인다. 그 과정에서 이에 간섭하는 코드가 없기 때문이다.</p>
<p>그리고 private 변수의 접근 제한 수준을 억지로 공개해서 은닉성을 포기할 만큼 가치있는 일인가?</p>
<p>비슷한 관점으로 (그러나 명확하게 설명된) 이 글을 참고해도 좋겠다.</p>
<p><a target="_blank" rel="noopener" href="https://justhackem.wordpress.com/2017/09/29/should-private-methods-be-tested/">비공개 메서드를 테스트 해야 하는가?</a></p>
<blockquote>
<p>테스트 케이스는 클라이언트 코드다</p>
</blockquote>
<p>억지로 만든 테스트는 다 지워버리자.</p>
<h2 id="역할-나누기"><a href="#역할-나누기" class="headerlink" title="역할 나누기"></a>역할 나누기</h2><p>계속된 첫 테스트 작성 실패에 주눅들 것 없이 찬찬히 코드를 돌아보자.</p>
<p>진짜 진짜 첫 테스트를 작성 하려고 보니, <code>Request</code> 클래스 안에 <code>getResponse()</code> 메소드만 덩그러니 있는 것이 마음에 걸린다.</p>
<p><code>server.php</code>에서 기능을 분리한 것은 좋았지만, 클래스 명이 <code>Request</code>인데 여기서 응답 문자열을 만들어주는 모양이 어색하다.</p>
<p>자연스럽게(서로 짝이 맞게) <code>Response</code>라는 클래스를 만들어야겠다는 생각이 든다. </p>
<p>어떤 기준으로 나눠야 할지 현재의 <code>Request</code> 클래스의 코드를 기준으로 각각의 임무를 적어보자.</p>
<p>Request</p>
<ul>
<li>요청된 문자열을 파싱해서 시작줄, 헤더(여러줄), 본문 등 필요한 포맷으로 정리한다</li>
<li>해석할 수 없는 요청이라면 예외를 발생시킨다</li>
<li>분석 결과, 클라이언트가 요청한 리소스 위치를 리턴한다 </li>
<li>‘&#x2F;‘라는 요청이 오면 ‘index.html’이라는 파일을 읽어야 하는 것을 알고 있다</li>
</ul>
<p>Response</p>
<ul>
<li>도큐먼트 root의 절대 경로를 알고 있다</li>
<li>파일이 존재하는지 확인하고 없으면 예외를 발생한다</li>
<li>파일을 읽는다</li>
<li>처리 결과를 정리한다 </li>
<li>클라이언트에 전달할 HTTP 응답 메시지를 리턴한다</li>
</ul>
<p>나중에 여기서 더 더 분리가 되겠지만, 현재 코드에서 예상할 수 있는 기능을 크게 둘로 나오면 이 정도라고 생각한다.</p>
<p>그럼 이런 흐름이 될 것이다.</p>
<ol>
<li><code>server.php</code>에선 클라이언트가 보낸 raw 메시지를 <code>Request</code> 클래스에 전달하고,</li>
<li><code>Request</code> 클래스는 이를 파싱해서 내부에 저장하고,</li>
<li><code>Response</code> 클래스는 여기서 리소스 경로를 받아 읽고 <code>server.php</code>에 최종 결과물을 리턴한다.</li>
</ol>
<p>이제 <code>Request</code> 클래스는 raw 메시지를 받아 특정 경로를 반환하도록 고치고</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$requestMessage</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$requestMessage</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//하지만 아직 쓰진 않지</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;requestMessage = <span class="variable">$requestMessage</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResourcePath</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;/index.html&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>서버는 이걸 받아 <code>Response</code>에게 던지고</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ... 생략 ...</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="variable">$clientSentData</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="number">1024</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$resourcePath</span> = (<span class="keyword">new</span> <span class="title class_">Request</span>(<span class="variable">$clientSentData</span>))-&gt;<span class="title function_ invoke__">getResourcePath</span>();</span><br><span class="line">        <span class="variable">$response</span> = (<span class="keyword">new</span> <span class="title class_">Response</span>())-&gt;<span class="title function_ invoke__">getResponse</span>(<span class="variable">$resourcePath</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Response</code>는 클라이언트에 보낼 메시지를 조합한다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$docRoot</span> = PROJECT_ROOT . <span class="string">&#x27;/public&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResponse</span>(<span class="params"><span class="variable">$resourcePath</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;docRoot . <span class="variable">$resourcePath</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;HTTP/1.0 404 파일 없음&#x27;</span> . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$responseBody</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;Content-Type: text/html&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="variable">$responseBody</span> . PHP_EOL;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이제 브라우저에서 <code>http://127.0.0.1:1337/</code>에 접근해보고 문제없이 동작하는 것을 확인한다.</p>
<p>드디어 진짜 진짜 첫 테스트를 작성할 차례다.</p>
<h2 id="진짜-진짜-첫-테스트"><a href="#진짜-진짜-첫-테스트" class="headerlink" title="진짜 진짜 첫 테스트"></a>진짜 진짜 첫 테스트</h2><p>진짜 진짜 첫 테스트의 대상은 <code>Request</code>의 <code>getResourcePath()</code> 메소드로 정했다.</p>
<p>사실 TDD의 정석대로 하자면, 메소드를 추가하기 전에 </p>
<ul>
<li>Red : 실패하는 테스트를 작성하고, 실패하는 것을 확인</li>
<li>Green : 이를 통과하는 최소한의 코드를 작성하고</li>
<li>Refactor : 리팩토링하는 과정</li>
</ul>
<p>을 겪어야 했지만, 이미 잘 돌아가는 코드가 존재했고 Request-Response로 분리하는 과정에서 믿을 수 있는 건 수동 테스트 밖에 없었기 때문에,</p>
<p>수동 테스트가 성공하는 범위 안에서 최소한의 변경으로 코드로 분리하고자 했다.</p>
<p>좀 늦긴 했지만 <code>getResourcePath()</code> 메소드에 대한 테스트를 작성해보자.</p>
<p>tests&#x2F;RequestTest.php :</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">TestCase</span>;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetResourcePath</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$request</span> = <span class="keyword">new</span> <span class="title class_">Request</span>([]);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assertEquals</span>(<span class="string">&#x27;/index.html&#x27;</span>, <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getResourcePath</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OK (1 test, 1 assertion)</span><br></pre></td></tr></table></figure>

<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>7화 만에 진짜 진짜 첫 테스트를 만들다니…</p>
<p>다음 시간에는 Request를 파싱해서 실제 동작하는(잊지 않았겠지! 클라이언트는 html과 image와 favicon을 요청할 것이다) HTTP 요청 메시지 파서를 만들 것이다. 당연히 최소한으로 동작하는..</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/25/phttp-06/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/25/phttp-06/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 06 - Request 분리, autoload, PHPUnit</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-25 07:27:32" itemprop="dateCreated datePublished" datetime="2017-10-25T07:27:32+09:00">2017-10-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/25/phttp-06/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/25/phttp-06/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h1 id="Request-분리"><a href="#Request-분리" class="headerlink" title="Request 분리"></a>Request 분리</h1><h2 id="autoload"><a href="#autoload" class="headerlink" title="autoload"></a>autoload</h2><p>우선 클라이언트로부터 받은 request 메시를 분석하는 클래스부터 만들기로 했다.</p>
<p>Project root에 <code>libs</code> 디렉토리를 만들어 놓고, 여기에 <code>Request</code>라는 클래스를 하나 만들어야겠다.</p>
<p>그럼 autoload도 적용해야 하니 composer를 이용해야겠다.</p>
<p>대충 <code>composer init</code>해서 파일을 만들고, <code>libs</code> 디렉토리를 psr-4 기반으로 autoload 하도록 설정해주자. </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;youngiggy/phttp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;project&quot;</span>,</span><br><span class="line">    <span class="string">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;authors&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;youngiggy&quot;</span>,</span><br><span class="line">            <span class="string">&quot;email&quot;</span>: <span class="string">&quot;youngiggy@gmail.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;require&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">&quot;autoload&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;psr-4&quot;</span>: &#123; <span class="string">&quot;&quot;</span>: <span class="string">&quot;libs/&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이제 <code>libs</code> 디렉토리 아래 <code>Request</code> 클래스를 하나 만들고</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/phttp-06/01_composer_init.png" alt="after composer init"></p>
<p><code>server.php</code> 상단에 autoload용 코드를 심고, Request를 로드해보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//todo 지울 것 s</span></span><br><span class="line"><span class="variable">$req</span> = <span class="keyword">new</span> <span class="title class_">Request</span>();</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$req</span> <span class="keyword">instanceof</span> Request);</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line"><span class="comment">//todo 지울 것 e</span></span><br><span class="line">  </span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// ...생략...</span></span><br></pre></td></tr></table></figure>

<p>일단 autoload는 잘 동작한다. OK.</p>
<h2 id="server-php"><a href="#server-php" class="headerlink" title="server.php"></a>server.php</h2><p>테스트용으로 넣었던 쓸데 없는 코드는 이제 지우고,</p>
<p><code>Request</code> 클래스에 사용자 입력을 분석하고 응답을 만들어내는 역할을 맡기려고 한다.</p>
<p>서버 소스는 아래와 같이 바뀌었다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line">    </span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;PROJECT_ROOT&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;PROJECT_ROOT&#x27;</span>, <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span>);</span><br><span class="line">    </span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="variable">$clientSentData</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="number">1024</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$response</span> = (<span class="keyword">new</span> <span class="title class_">Request</span>(<span class="variable">$clientSentData</span>))-&gt;<span class="title function_ invoke__">getResponse</span>();</span><br><span class="line">    </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이전 소스에서 <code>index.html</code>을 읽기 위해 아래와 같이 상대 위치로 하드코딩해서 썼었다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...생략...</span></span><br><span class="line"><span class="variable">$filename</span> = <span class="string">&#x27;../public/index.html&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (!(<span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>))) &#123;</span><br><span class="line"><span class="comment">//...생략...</span></span><br></pre></td></tr></table></figure>

<p>처리 로직이 서버 소스를 떠나면 <code>index.html</code> 파일을 여는 fopen을 어디서 처리할 지 아직 확신이 없다. 계속 바뀔지 모른다.</p>
<p>그래서 프로젝트의 최상위 경로를 <code>PROJECT_ROOT</code>라는 상수로 지정했다.</p>
<p>그리고 주요 처리 로직을 들어내고 <code>Request</code> 클래스에 클라이언트가 보낸 문자열을 전달하고,</p>
<p><code>getResponse()</code> 메소드로 받은 문자열을 그대로 클라이언트에 전달한다.</p>
<p>이제 당분간 이쪽 소스를 건드릴 일은 없어 보인다.</p>
<h2 id="Request-php"><a href="#Request-php" class="headerlink" title="Request.php"></a>Request.php</h2><p>이 클래스를 사용하는 곳(server.php)을 보면 <code>Request</code> 클래스의 역할은 크게 두가지다.</p>
<ol>
<li>클라이언트가 보낸 문자열을 생성자로 받는 것</li>
<li><code>getResponse()</code> 메소드로 처리 결과를 리턴하는 것</li>
</ol>
<p><code>server.php</code>의 소스를 가능한 건드리지 않고 조심히 들고와보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$requestMessage</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$requestMessage</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//하지만 아직 쓰진 않지</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;requestMessage = <span class="variable">$requestMessage</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResponse</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = PROJECT_ROOT . <span class="string">&#x27;/public/index.html&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;HTTP/1.0 404 파일 없음&#x27;</span> . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$responseBody</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>));</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;Content-Type: text/html&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="variable">$responseBody</span> . PHP_EOL;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>거의 동일하다.</p>
<p>어려울 게 없으니 서버 실행!</p>
<h2 id="테스트"><a href="#테스트" class="headerlink" title="테스트"></a>테스트</h2><p>이전의 파일 하나짜리 서버와 동일하게 동작한다.</p>
<p>잘 돌아는 가는데 어쩐지 마음이 헛헛하다.<br>(가을인가)</p>
<p>계속 이렇게 테스트를 해야하나?</p>
<p>매번 뭔가 수정하고 <code>php ./app/server.php</code>를 다시 실행해야 하나?</p>
<p>이제 개발 시작할 분석 로직은 그냥 스트링을 던져주고 결과만 잘 나오면 되는데.</p>
<p>소파에 반쯤 누워 맥주 한잔 들이키며 이 막장 드라마를 구경하는 중급 개발자라면 ‘유닛 테스트를 걸라고, 멍청아’라고 소리칠 것만 같다.</p>
<p>넣어주지 뭐.</p>
<h2 id="PHPUnit"><a href="#PHPUnit" class="headerlink" title="PHPUnit"></a>PHPUnit</h2><p>PHPUnit을 가져와야 할텐데, <code>composer.json</code>에 추가하기 보다는 <code>composer require</code>을 사용하기로 한다.</p>
<p>콘솔을 열고 </p>
<p><code>composer require --dev phpunit/phpunit ^6.4</code></p>
<ul>
<li>“개발에서 쓰려고 하는데 대충 6.4 정도면 될 것 같아요”</li>
</ul>
<p>최신 버전이 6.4라서 명시했고, 7.0 전까지는 써도 별 탈 없을 것이다.  </p>
<p>업데이트가 완료되면 PHPStorm에 실행 환경을 설정한다.</p>
<p>테스트 범위 설정이나 그룹화를 위해 XML로 설정하기로 한다.</p>
<p>프로젝트 root에 <code>phpunit.xml</code> 파일을 만들고 아래와 같이 입력.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">phpunit</span> <span class="attr">bootstrap</span>=<span class="string">&quot;vendor/autoload.php&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testsuites</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">testsuite</span> <span class="attr">name</span>=<span class="string">&quot;Request&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>tests<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">testsuite</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">testsuites</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">phpunit</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>테스트를 돌리기 전 특별히 bootstrap할 게 없으므로 <code>vendor/autoload.php</code>를 bootstrap에 명시했고,</p>
<p>testsuite 명은 나중에 바뀌겠지만 일단 대충 넣고,</p>
<p><code>tests</code>라는 디렉토리에 있는 Test.php로 끝나는 파일(예: parseTest.php)을 모두 검사하도록 했다.</p>
<h2 id="PHPUnit-with-PHPStorm"><a href="#PHPUnit-with-PHPStorm" class="headerlink" title="PHPUnit with PHPStorm"></a>PHPUnit with PHPStorm</h2><p>다른 에디터를 쓰는 분들은 다른 각자 알아서 찾아보면 될 것이고, 여기서는 간단히 PHPStorm에서 설정하는 법만 적어본다.</p>
<p><code>Run | Edit Configurations</code> 메뉴에서 <code>+</code> 버튼을 눌러 <code>PHPUnit</code> 선택.</p>
<p><img src="/images/phttp-06/run_edit_phpunit.png" alt="Run &gt; Edit Configurations"></p>
<p><code>Test Runner &gt; Test Scope</code>을 &#96;Definded in the configuration file’을 선택한다.</p>
<p>바로 아랫줄 제일 오른쪽에 보이는 설정 버튼을 누르면 <code>Test Frameworks</code> 설정 창이 나온다.<br>(만약 처음 설정&#x2F;실행한다면 창 아래쪽에서 configuration file에 문제가 있으니 수정하라고 <code>Fix</code> 버튼이 보일 수도 있다. 이걸 눌러도 같은 창이 나온다.)</p>
<p><img src="/images/phttp-06/run_edit_phpunit_tf.png" alt="Run &gt; Edit Configurations &gt; Test Frameworks"></p>
<p><code>+</code> 버튼을 눌러 Configuration type을 PHPUnit Local로 추가한 후,</p>
<p>PHPUnit library &gt; Use Composer autoloader 선택하고 Path to script는 <code>…</code> 버튼을 눌러 자신의 <code>vendor/autoload.php</code>을 선택하면 된다.</p>
<p>그 아래 Test Runner 옵션에서는 <code>Default configuration file</code>을 체크하고 앞서 만든 <code>phpunit.xml</code>을 선택한다.</p>
<p>그리고 실행!</p>
<p>테스트를 작성하지 않았으므로 <code>No tests executed!</code> 같은 메시지가 보이면 정상이다.</p>
<p>실행창에서 Toggle auto-test를 눌러 놓으면 뭔가 수정이 될 때마다 테스트가 실행된다.</p>
<p>하지만 개발하다보면, 주석을 넣는다거나 공백을 삽입하는데도 test가 실행되므로 종종 눈엣가시가 된다.</p>
<p>이럴 때는 AutoTest Delay값을 늘려주면 좀 낫다.</p>
<p><img src="/images/phttp-06/set_autotest_delay.png" alt="Run &gt; Set AutoTest Delay"></p>
<p>나중에 테스트가 엄청 많아지면 현재 개발하는 모듈 이외의 클래스도 단위테스트가 돌게 될텐데, 이 때는 <code>phpunit.xml</code>에서 테스트 단위를 나누면 된다. 하지만 예상컨대 이 프로젝트에선 그렇게까지 테스트가 많아질 것 같지 않다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>이제부터는 뭔가 추가&#x2F;수정할 때마다 미리 테스트를 만들고 실패하는 것을 확인하고 이를 만족하는 기능을 개발하게 될 것이다.</p>
<p>현재 추가&#x2F;수정하는 코드가 시스템을 망가뜨리지 않는다는 최소한의 보장을 받을 수 있다.</p>
<p>하지만 서버 코드의 많은 부분이 file이나 directory를 읽어야 하는데, 이런 부분은 unit test 만으로 해결 안될 수 있다.</p>
<p>뭐가 어려운지는 <a target="_blank" rel="noopener" href="http://jwchung.github.io/testing-oh-my">이런</a> 글을 보고 예습을 하는 것도 좋다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><p><a target="_blank" rel="noopener" href="http://www.php-fig.org/psr/psr-4/">http://www.php-fig.org/psr/psr-4/</a><br><a target="_blank" rel="noopener" href="https://getcomposer.org/doc/01-basic-usage.md">https://getcomposer.org/doc/01-basic-usage.md</a><br><a target="_blank" rel="noopener" href="http://xpressengine.github.io/Composer-korean-docs/">http://xpressengine.github.io/Composer-korean-docs/</a><br><a target="_blank" rel="noopener" href="https://getcomposer.org/doc/articles/versions.md#caret-version-range-">https://getcomposer.org/doc/articles/versions.md#caret-version-range-</a><br><a target="_blank" rel="noopener" href="https://phpunit.de/index.html">https://phpunit.de/index.html</a><br><a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/phpstorm/testing-with-phpunit.html">https://www.jetbrains.com/help/phpstorm/testing-with-phpunit.html</a><br><a target="_blank" rel="noopener" href="http://jwchung.github.io/testing-oh-my">http://jwchung.github.io/testing-oh-my</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/21/phttp-05/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/21/phttp-05/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 05 - 아주 간단한 HTTP 서버로 첫 요청과 응답</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-21 10:34:46" itemprop="dateCreated datePublished" datetime="2017-10-21T10:34:46+09:00">2017-10-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/21/phttp-05/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/21/phttp-05/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h2 id="과연-스트리밍이-필요한가"><a href="#과연-스트리밍이-필요한가" class="headerlink" title="과연 스트리밍이 필요한가?"></a>과연 스트리밍이 필요한가?</h2><p>스트리밍 처리를 위해 이리저리 알아보다가 괜찮은 글이 있어 소개한다.</p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/CMCDragonkai/6bfade6431e9ffb7fe88">https://gist.github.com/CMCDragonkai/6bfade6431e9ffb7fe88</a></p>
<ul>
<li>스트리밍을 구현할 때 chunk 데이터를 어떻게 보내고, 이를 어떻게 처리해야 하는지</li>
<li>HTTP 트랜잭션 안의 각 요소(component) 간 buffer는 어떻게 처리되는지</li>
<li>등등</li>
</ul>
<p>잘 나와있다.</p>
<p>예전에 댓글로 <a target="_blank" rel="noopener" href="https://www.sitepoint.com/php-streaming-output-buffering-explained/">아웃 버퍼링에 관한 글</a>도 소개했었는데,</p>
<p>같은 맥락으로 읽어보면 좋다.</p>
<p>내가 만들 서버는 아주 가벼운 HTML 파일과 이미지 정도를 보내주기 때문에 굳이 (chunk로 나눠 보내주는) 스트리밍은 필요없다.</p>
<p>마찬가지로 클라이언트에서도 multi-part chunk 데이터가 들어올 것을 고려할 필요가 없다.</p>
<p>그럼 이제 HTTP 요청을 받아서 HTTP 응답을 반환해주는 최소한의 구성으로 서버를 하나 만들어보겠다.</p>
<h2 id="아주-간단한-HTTP-서버"><a href="#아주-간단한-HTTP-서버" class="headerlink" title="아주 간단한 HTTP 서버"></a>아주 간단한 HTTP 서버</h2><p>이전 시간에 만들었던 서버 소스를 조금 수정해서, 클라이언트가 보낸 내용을 읽고 HTTP 응답 메시지로 리턴한다.</p>
<p>아래는 전체 소스다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="variable">$request</span>= <span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="number">1024</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;Content-Type: text/html&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;you sent :&#x27;</span> . PHP_EOL . <span class="variable">$request</span> . PHP_EOL;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>클라이언트와 연결되면 해당 스트림에서 1024 바이트만큼 읽어온다.</p>
<p>더 많이 보낼 수 있지 않냐고? 물론이다. 그 문제는 그 때 생각하자.</p>
<p>그 다음 HTTP 메시지를 만들어 준다.</p>
<ul>
<li>말했지만, HTTP 메시지는 시작줄, 헤더, 공백, 본문(message body)으로 이뤄졌다.</li>
</ul>
<p>요청할 때는 시작줄에 <code>GET / HTTP/1.1</code>와 같이 메소드, URL, HTTP 버전 순으로 보냈지만 </p>
<p>응답할 때의 시작줄에는 <code>HTTP/1.0 200 OK</code>와 같이 HTTP 버전과 상태 코드 그리고 상태 텍스트를 넣어준다.</p>
<p>여기에 헤더를 추가해줘야 하니 Content-Type을 text&#x2F;html으로 우선 하나 넣어주고</p>
<p>메시지 본문과의 구분을 위해 CRLF를 두 개 추가한다. </p>
<h2 id="첫-HTTP-요청과-응답"><a href="#첫-HTTP-요청과-응답" class="headerlink" title="첫 HTTP 요청과 응답"></a>첫 HTTP 요청과 응답</h2><p>테스트 용으로 만들었던 클라이언트 코드는 이제 버리고,</p>
<p>진짜 HTTP 클라이언트를 사용해보자.</p>
<p>브라우저에서 접속해도 괜찮지만 아직은 HTML 파일을 내려보낼 것이 아니므로</p>
<p><a target="_blank" rel="noopener" href="https://www.getpostman.com/">Postman</a>같은 클라이언트가 테스트하기 편할 것이다.</p>
<p><code>GET</code> 메소드로 <code>127.0.0.1:1337</code>에 접근해보자.</p>
<p><img src="/images/phttp-05/postman01.png" alt="Postman으로 실행한 화면"></p>
<p>(만약 서버에서 적절한 시작줄을 안 보내주면 Postman은 <code>Could not get any response</code>라며 응답이 오지 않은 것으로 간주한다.) </p>
<p>Postman에서 받은 응답 메시지 본문은 아래와 같다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">you sent :</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:1337</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</span><br><span class="line">Postman-Token: df3ef030-2b6f-76c3-30d9-304ebb426a41</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: ko-KR,ko;q=0.8,en-US;q=0.6,en;q=0.4</span><br></pre></td></tr></table></figure>

<p>서버에서 응답 본문 앞에 붙여둔 <code>you sent :</code> 한 주를 제외하면 나머지는 HTTP 클라이언트(여기서는 Postman)가 요청 시 붙여 보낸 것이다.</p>
<p>크롬에서 보내면?</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">you sent :</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:1337</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: ko-KR,ko;q=0.8,en-US;q=0.6,en;q=0.4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>다시 서버 소스를 돌아보자.</p>
<p>지금은 무조건 <code>HTTP/1.0 200 OK</code>라고 응답하게 되어있다.</p>
<p>클라이언트는 HTTP&#x2F;1.1을 지원하기 때문에 이 프로토콜 버전을 기준으로 헤더를 붙여 요청했지만</p>
<p>우리 서버는 ‘난 HTTP&#x2F;1.0까지만 지원하는 서버라서 1.0 기준의 헤더를 보낼 거야’라는 의미로 응답에 <code>HTTP/1.0 200 OK</code>를 리턴한다.</p>
<h2 id="브라우저에서-index-html-확인하기"><a href="#브라우저에서-index-html-확인하기" class="headerlink" title="브라우저에서 index.html 확인하기"></a>브라우저에서 index.html 확인하기</h2><p>저기 저 아주 간단한 서버 소스에선 메시지 본문을 클라이언트가 보낸 데이터를 그대로 돌려줬는데,</p>
<p><code>$response .= &#39;you sent :&#39; . PHP_EOL . $request . PHP_EOL;</code></p>
<p>이제 예시로 만들어 두었던 index.html 파일을 읽어 클라이언트로 보내기로 한다.</p>
<p>드디어 브라우저에서 확인해볼 차례다.</p>
<p>Request를 그대로 돌려주는 서버에서 무조건 index.html을 떨궈주는 서버로 진화해보자. </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 생략</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="comment">//todo 요청(request) 처리 모듈로 분리하기</span></span><br><span class="line">        <span class="variable">$request</span>= <span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="number">1024</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&#x27;../public/index.html&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>))) &#123;</span><br><span class="line">            <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 404 파일 없음&#x27;</span> . PHP_EOL;</span><br><span class="line">            <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">            <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$responseBody</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>));</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//todo 응답(response) 처리 모듈로 분리하기</span></span><br><span class="line">        <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;Content-Type: text/html&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="variable">$responseBody</span> . PHP_EOL;</span><br><span class="line">    </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>todo가 먼저 눈에 띌 것 같은데,</p>
<p>우리의 아주 간단한 서버가 조금씩 복잡해지기 시작했다(냄새가 난다, 냄새가).</p>
<p>크게 보면 응답을 받아서 뭔가 하는 역할과 응답을 만들어주는 역할이다.</p>
<p>리팩토링은 나중에 하기로 하고, 맥주를 한잔 따르고, 성공을 축하하자.</p>
<p>크롬으로 접속!</p>
<p><img src="/images/phttp-05/index_html.png" alt="index.html 성공"></p>
<p>만약 없는 경로의 파일을 찾으려고 하면 404로 응답해주면 된다.</p>
<p>그 유명한 <code>404 not found</code>다.</p>
<p>그런데 소스를 보면 <code>HTTP/1.0 404 파일 없음</code>이라고 되어있는데 잘못 쓴 게 아니다.</p>
<p>클라이언트에게는 404라는 응답코드가 중요하지 메시지는 중요하지 않다.</p>
<p><code>200 OK</code>나 <code>200 NOT OK</code>나 모두 성공을 의미한다.</p>
<p>(물론 서비스 운영 시에는 이런 짓은 하지 않는다)</p>
<p><img src="/images/phttp-05/index_html_404.png" alt="404 not found"></p>
<p>404 처리도 완벽하게(!?) 됐다.</p>
<h2 id="이미지-서빙"><a href="#이미지-서빙" class="headerlink" title="이미지 서빙"></a>이미지 서빙</h2><p>첫 요청으로 index.html을 서빙하는 것 까지는 성공했는데, 중간에 이미지가 빠져있는 게 보일 것이다.</p>
<p>이미지를 노출하려면 몇 가지 더 수정을 해야한다.</p>
<h3 id="첫째-두-가지의-요청을-처리할-수-있어야-한다"><a href="#첫째-두-가지의-요청을-처리할-수-있어야-한다" class="headerlink" title="첫째, 두 가지의 요청을 처리할 수 있어야 한다."></a>첫째, 두 가지의 요청을 처리할 수 있어야 한다.</h3><p>즉, HTML을 요청하는 것과 이미지를 요청하는 것.</p>
<p>첫 요청으로 브라우저는 index.html이라는 HTML을 얻었다.</p>
<p>이 HTML 문서를 파싱하다가 img 태그를 만났고 src가 beer_server.jpg라는 상대 링크이기 때문에 우리의 서버에 다시 요청을 보낸다.</p>
<p>첫 요청이 <code>GET / HTTP/1.1</code>라면 이어서 <code>GET /beer_server.jpg HTTP/1.1</code>라는 요청이 이어질 것이다.</p>
<p><code>개발자 도구 &gt; 네트워크</code>를 열어 확인해보자.</p>
<p><img src="/images/phttp-05/index_html_network.png" alt="index.html의 네트워크"></p>
<p>(contents_min.css 저 놈은 크롬 확장 프로그램 때문에 날아간 것이니 신경 쓰지 말자 😭)</p>
<p>favicon.ico는 브라우저 탭에 표시해주는 작은 이미지인데, 최신 브라우저에서는 favicon이 등록되어 있지 않은 사이트일 경우 서버에 &#x2F;favicon.ico가 있는지 한번 찔러본다.<br>(사실 계속 찔러보기는 하는데..)</p>
<p>따라서 예상치 못하게 이미지 하나를 더 서비스 해야할 상황이다.</p>
<ul>
<li>index.html</li>
<li>beer_server.png </li>
<li>favicon.ico</li>
</ul>
<p>이제 클라이언트가 보낸 요청을 분석해서 뭘 원하는 지 알아내야 할 판이다.</p>
<h3 id="둘째-이미지를-읽고-써야한다"><a href="#둘째-이미지를-읽고-써야한다" class="headerlink" title="둘째, 이미지를 읽고 써야한다."></a>둘째, 이미지를 읽고 써야한다.</h3><p>위 소스에서 index.html을 어떻게 찾았는지 살펴보자.</p>
<p>server.php가 실행된 위치에서 <code>..</code>로 상위 디렉토리로 올리가 <code>public</code>이라는 디렉토리에 있는 파일을 서빙했다.</p>
<p>이러다 서버 프로그램 위치가 이동한달지 webroot를 변경하면 서버 코드를 수정할 판이다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>냄새가 난다, 냄새가.</p>
<p>index.html 하나 서비스했을 뿐인데 많은 구조적인 문제가 폭발했다.</p>
<p>클라이언트 요청(request)를 분석하고 html을 줄지 이미지를 줄지 결정해야하고,</p>
<p>DOCUMENT_ROOT, WEB_ROOT 등 config 설정도 해야할 것 같다.</p>
<p>200과 404 응답을 만들어주는 코드 모두에 fwrite&#x2F;fclose 로직이 중복되어 있기도 하다.</p>
<p>이 모든 걸 담기에는 이미 서버 프로그램이 너무 복잡하다.</p>
<p>다음 시간부터 이를 하나씩 분리해서 HTTP 완벽가이드 5장에 소개된 ‘진짜 웹 서버가 하는 일’을 구현해볼 생각이다.</p>
<ol>
<li>커넥션을 맺는다</li>
<li>요청을 받는다</li>
<li>요청을 처리한다</li>
<li>리소스에 접근한다</li>
<li>응답을 만든다</li>
<li>응답을 보낸다</li>
<li>트랜잭션을 로그로 남긴다</li>
</ol>
<p>(1번, 2번 정도는 PHP 함수로 대충 때웠으니 했다고 치자) </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/16/phttp-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/16/phttp-04/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 04 - 가장 간단한 서버</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-16 21:37:43" itemprop="dateCreated datePublished" datetime="2017-10-16T21:37:43+09:00">2017-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/16/phttp-04/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/16/phttp-04/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h3 id="Updated-2017-10-18"><a href="#Updated-2017-10-18" class="headerlink" title="Updated (2017.10.18)"></a>Updated (2017.10.18)</h3><p>이번 글과 관련된 내용이라 조금 더 추가해봤습니다.</p>
<p>하단 <a href="#Updated">Updated</a> 참고.</p>
<h2 id="가장-간단한-서버"><a href="#가장-간단한-서버" class="headerlink" title="가장 간단한 서버"></a>가장 간단한 서버</h2><p>이제부터 하나씩 기능을 붙여가며 commit &amp; push를 할 예정이다.</p>
<p>PHP7.1&#x2F;mac 환경에서 공부한 결과를 적는 거라서, 윈도 머신에선 안 통하는 설명도 있으리라.</p>
<p>소스 위치는 <a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp">https://github.com/youngiggy/phttp</a></p>
<p><a href="/2017/10/06/phttp-02">PHP로 HTTP 서버 구현하기 - 01</a>에서 언급한 가장 간단한 서버부터 시작해볼까?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">stream_copy_to_stream</span>(<span class="variable">$client</span>, <span class="variable">$client</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>딱 봐도 어려울 것 없는 코드다.</p>
<p>127.0.0.1이란 IP에 1337 포트를 열었다. </p>
<p>왜 하필 1337이냐고? 그냥! 저 블로그 쓴 사람이 그렇게 써서 따라했다. </p>
<p>사용하는 프로그램에 따라 이미 포트가 선점되었을 수도 있다.</p>
<ul>
<li>기본으로 이 포트를 쓰는 프로그램이 있는지 <a target="_blank" rel="noopener" href="https://www.speedguide.net/port.php?port=1337">이런 곳</a>에서 찾아봐도 좋고</li>
<li>쉘에서 <code>lsof -PiTCP -sTCP:LISTEN</code> 포트가 열려있는지 확인해봐도 좋다</li>
</ul>
<p>그 다음 while 루프로 뱅글뱅글 돌면서 연결이 들어오는 지 확인한다.</p>
<p><code>stream_socket_accept</code> 함수가 말을 못하게 @로 입을 막자.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=u5CVsCnxyXg">&amp;#9834;</a> No alarms and no surprises </li>
<li>하지만 안 막는다고 뭐 대단한 걸 볼 일은 없을 것이다</li>
</ul>
<p>연결이 된 클라이언트가 있다면, <code>stream_copy_to_stream</code>를 통해 클라이언트가 보낸 스트림을 고스란히 돌려주자.</p>
<p>고스란히…</p>
<p><img src="https://media.tenor.com/images/5746acedc3829ed1e2e569c8d525c6f9/tenor.gif" alt="주고 받기"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tenor.com/view/kdrama-korean-slap-anger-angry-gif-9330050">https://tenor.com/view/kdrama-korean-slap-anger-angry-gif-9330050</a></li>
</ul>
<h2 id="가장-간단한-클라이언트"><a href="#가장-간단한-클라이언트" class="headerlink" title="가장 간단한 클라이언트"></a>가장 간단한 클라이언트</h2><p>가장 간단한 서버가 완성됐으니 터미널을 열어 <code>php ./app/server.php</code>로 일을 시키고 돌아오자.</p>
<p>새로운 터미널을 열어 <code>echo &quot;hello hello&quot; | nc 127.0.0.1 1337</code>를 입력하면 <code>hello hello</code>라고 반갑게 인사하는 것이 보일 것이다.</p>
<p>너무 시시하니까 가장 간단한 클라이언트를 만들어 잘 돌아가는 지 구경해보자.</p>
<p>아직 브라우저에서 HTTP 프로토콜로 붙을 상황은 아니므로 간단한 TCP 연결 클라이언트로 테스트 한다.</p>
<p>역시 <a target="_blank" rel="noopener" href="https://www.christophh.net/2012/07/24/php-socket-programming/">PHP Socket Programming, done the Right Way</a>에서 예시로 보여준 것을 기본으로 시작한다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$client</span> = <span class="title function_ invoke__">stream_socket_client</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$client</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Failed to connect: <span class="subst">$errno</span> - <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * generate a message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$startLine</span> = <span class="string">&#x27;GET / HTTP/1.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$headers</span> = [</span><br><span class="line">    <span class="string">&#x27;Host: localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept: */*&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"><span class="variable">$header</span> = <span class="title function_ invoke__">implode</span>(PHP_EOL, <span class="variable">$headers</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$emptyLine</span> = PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="variable">$body</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * request</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$message</span> = <span class="title function_ invoke__">implode</span>(PHP_EOL, [</span><br><span class="line">    <span class="variable">$startLine</span>,</span><br><span class="line">    <span class="variable">$header</span>,</span><br><span class="line">    <span class="variable">$emptyLine</span>,</span><br><span class="line">    <span class="variable">$body</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$message</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * bye bye</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br></pre></td></tr></table></figure>

<p>역시 별 거 없는 코드다.</p>
<p><code>stream_socket_client</code>으로 연결을 시도하고,</p>
<p>HTTP 메시지를 만들어 준다.</p>
<ul>
<li>HTTP 메시지는 시작줄, 헤더, 공백, 바디로 이뤄졌다. <a href="/2017/08/23/http-the-definitive-guide-chapter-3">참고</a></li>
</ul>
<p>이 메시지를 fwrite를 통해 스트림에 써 준다.</p>
<p><a href="/2017/10/06/phttp-02">02편</a>에서 얘기한 것처럼, <code>stream_socket_client</code>이 리턴하는 stream resource에는 fopen, fread같은 filesystem 함수를 사용할 수 있다.</p>
<h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p>터미널을 하나 열고 <code>php ./app/client.php</code>로 클라이언트를 실행해보자.</p>
<p>아무 반응이 없을 것이다.</p>
<p>하지만 조금만 더 기다려보면, 1분 후 timeout으로 client가 종료되고 자신이 서버에 전송한 값이 화면에 찍한다.</p>
<p>왜 그럴까?</p>
<p>다르게 재현해보자.</p>
<p>서버를 다시 실행하고 클라이언트를 다시 실행한 후, 이번엔 서버를 죽여보자.</p>
<p>이때도 클라이언트와 연결이 바로 끊어지고 서버에 전송한 값이 되돌아와 화면에 찍힌다.</p>
<p>우선 timeout 1분은 환경마다 다를 수 있는데, php.ini에 default_socket_timeout에 정의되어 있다.</p>
<p>client 소스의 response 부분을 아래와 같이 바꿔보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">4</span>))) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span> . <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그럼 아래와 같이 나오던 것이</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET / HTTP/1.0</span><br><span class="line">Host: localhost</span><br><span class="line">Accept: *</span><br></pre></td></tr></table></figure>

<p>아래와 같이 바로 찍힌다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET |/ HT|TP/1|.0</span><br><span class="line">H|ost:| loc|alho|st</span><br><span class="line">A|ccep|t: *|/*</span><br></pre></td></tr></table></figure>

<p><code>stream_get_contents</code>의 두번째 인자는 maxlength라서 지정한 만큼만 스트림에서 읽어온다.</p>
<p>그래서 읽어온 만큼 바로바로 화면에 echo 하는 것이다. </p>
<ul>
<li>보기 좋으라고(?)뒤에 |를 붙여봤다.</li>
</ul>
<p>하지만 이렇게 해도 클라이언트는 종료되지 않는다.</p>
<p><code>stream_get_contents</code>가 계속 스트림에 뭔가 들어오는지 지켜보고 있어서 while loop가 끝나지 않는다.</p>
<p>이 악순환의 고리를 끊으려면 서버에서 연결을 끊어버리면 간단한데, 우리 코드에선 클라이언트로 들어오는 스트림을 바로 돌려주기 때문에 쉽지 않다.</p>
<p>클라이언트에서 loop를 종료하려면 어디가 끝인지를 확인해야만 한다.</p>
<p>서버가 Content-Length를 돌려주게끔 해주면 좋겠지만 우리 서버는 아직 바보니까 클라이언트가 좀 더 고생을 하자. </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$messageLenth</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$message</span>);</span><br><span class="line"><span class="variable">$totalLenth</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$totalLenth</span> += <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$messageLenth</span> &lt;= <span class="variable">$totalLenth</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Updated"><a href="#Updated" class="headerlink" title="Updated"></a>Updated</h2><p>이 글 이후로 좀 더 진행해보다가 meta 정보를 이용하는 방법까지는 여기에 묻어두는 것이 좋을 것 같아서 내용을 추가한다.</p>
<p><code>stream_get_contents</code>으로 데이터를 가져온 다음 현재 스트림의 상태를 보려면 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-get-meta-data.php">stream_get_meta_data</a>를 통해 확인할 수 있다.</p>
<p>여기에는 다음과 같은 정보가 리턴된다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [timed_out] =&gt; </span><br><span class="line">    [blocked] =&gt; 1</span><br><span class="line">    [eof] =&gt; </span><br><span class="line">    [stream_type] =&gt; tcp_socket/ssl</span><br><span class="line">    [mode] =&gt; r+</span><br><span class="line">    [unread_bytes] =&gt; 1</span><br><span class="line">    [seekable] =&gt; </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>어쩐지 eof나 unread_bytes를 쓰면 될 것 같다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$client</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$info</span>[<span class="string">&#x27;eof&#x27;</span>] || <span class="variable">$info</span>[<span class="string">&#x27;unread_bytes&#x27;</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>이렇게 하니 소중한 고객님의 연결이 끊겼습니다.</p>
<p>그러나,</p>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-get-meta-data.php">문서</a>를 보면 unread_bytes가 의미하는 것은,</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">unread_bytes (int) - the number of bytes currently contained in the PHP&#x27;s own internal buffer.</span><br></pre></td></tr></table></figure>

<p>즉, PHP 자체의 내부 버퍼의 내용을 보여주는 것이라서 스크립트에서 활용하지 않을 것을 추천하고 있다. </p>
<blockquote>
<p>Note: You shouldn’t use this value in a script.</p>
</blockquote>
<p>그럼 포기하고 다른 방법을 찾아보자.</p>
<p>우선 client 쪽 소스에서 unread_bytes를 검사하는 부분만 제거한 다음,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$client</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$info</span>[<span class="string">&#x27;eof&#x27;</span>] || <span class="variable">$info</span>[<span class="string">&#x27;unread_bytes&#x27;</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>연결이 안 끊어지는 것을 반드시 확인하자.</p>
<p>그 다음,</p>
<p>서버쪽 소스에서 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-set-blocking.php">stream_set_blocking</a>으로 non-blocking 모드로 바꿔보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$client</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>즉, 서버의 전체 소스는 아래와 같이 변할 것이다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$client</span>, <span class="literal">false</span>);<span class="comment">// &lt;-- 여기요 여기</span></span><br><span class="line">        <span class="title function_ invoke__">stream_copy_to_stream</span>(<span class="variable">$client</span>, <span class="variable">$client</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>클라이언트를 실행하면 바로 연결이 끊긴다.</p>
<p><code>stream_set_blocking</code> 함수의 두번째 인자 mode가 false로 들어가면 non-blocking 모드로 진입하며,</p>
<p>클라이언트 쪽에서는 스트림으로 더이상의 데이터가 들어오는 것을 기다리지 않는다.</p>
<p>이렇게 하면 굳이 스트림을 쓸 이유가 없기 때문에 이 역시도 좋은 방법은 아닐 것이다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>아주 간단한 서버와 아주 간단한 클라이언트를 아주 간단히 살펴봤다.</p>
<p>도저히 못 써먹겠으니 다음 글에서는 이를 좀 더 개선해보자.<br>(뭘 어떻게 바꿀 지는 아직 계획없음)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">youngiggy</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  




  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"youngiggy-github-io","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
