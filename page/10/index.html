<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon_package_v0.16/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_package_v0.16/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_package_v0.16/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon_package_v0.16/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/favicon_package_v0.16/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"haah.kr","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="blog">
<meta property="og:title" content="ha-ah">
<meta property="og:url" content="https://haah.kr/page/10/">
<meta property="og:site_name" content="ha-ah">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="youngiggy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://haah.kr/page/10/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/10/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ha-ah</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=354302543"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":354302543,"only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="ha-ah" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ha-ah</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">로그, 게으른 로그</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">youngiggy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">117</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:youngiggy@gmail.com" title="E-Mail → mailto:youngiggy@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/profile.php?id=100001259884599" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100001259884599" rel="noopener me" target="_blank"><i class="fab fa-facebook fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.instagram.com/jooyoungiggy" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;jooyoungiggy" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/16/phttp-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/16/phttp-04/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 04 - 가장 간단한 서버</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-16 21:37:43" itemprop="dateCreated datePublished" datetime="2017-10-16T21:37:43+09:00">2017-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/16/phttp-04/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/16/phttp-04/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h3 id="Updated-2017-10-18"><a href="#Updated-2017-10-18" class="headerlink" title="Updated (2017.10.18)"></a>Updated (2017.10.18)</h3><p>이번 글과 관련된 내용이라 조금 더 추가해봤습니다.</p>
<p>하단 <a href="#Updated">Updated</a> 참고.</p>
<h2 id="가장-간단한-서버"><a href="#가장-간단한-서버" class="headerlink" title="가장 간단한 서버"></a>가장 간단한 서버</h2><p>이제부터 하나씩 기능을 붙여가며 commit &amp; push를 할 예정이다.</p>
<p>PHP7.1&#x2F;mac 환경에서 공부한 결과를 적는 거라서, 윈도 머신에선 안 통하는 설명도 있으리라.</p>
<p>소스 위치는 <a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp">https://github.com/youngiggy/phttp</a></p>
<p><a href="/2017/10/06/phttp-02">PHP로 HTTP 서버 구현하기 - 01</a>에서 언급한 가장 간단한 서버부터 시작해볼까?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">stream_copy_to_stream</span>(<span class="variable">$client</span>, <span class="variable">$client</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>딱 봐도 어려울 것 없는 코드다.</p>
<p>127.0.0.1이란 IP에 1337 포트를 열었다. </p>
<p>왜 하필 1337이냐고? 그냥! 저 블로그 쓴 사람이 그렇게 써서 따라했다. </p>
<p>사용하는 프로그램에 따라 이미 포트가 선점되었을 수도 있다.</p>
<ul>
<li>기본으로 이 포트를 쓰는 프로그램이 있는지 <a target="_blank" rel="noopener" href="https://www.speedguide.net/port.php?port=1337">이런 곳</a>에서 찾아봐도 좋고</li>
<li>쉘에서 <code>lsof -PiTCP -sTCP:LISTEN</code> 포트가 열려있는지 확인해봐도 좋다</li>
</ul>
<p>그 다음 while 루프로 뱅글뱅글 돌면서 연결이 들어오는 지 확인한다.</p>
<p><code>stream_socket_accept</code> 함수가 말을 못하게 @로 입을 막자.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=u5CVsCnxyXg">&amp;#9834;</a> No alarms and no surprises </li>
<li>하지만 안 막는다고 뭐 대단한 걸 볼 일은 없을 것이다</li>
</ul>
<p>연결이 된 클라이언트가 있다면, <code>stream_copy_to_stream</code>를 통해 클라이언트가 보낸 스트림을 고스란히 돌려주자.</p>
<p>고스란히…</p>
<p><img src="https://media.tenor.com/images/5746acedc3829ed1e2e569c8d525c6f9/tenor.gif" alt="주고 받기"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tenor.com/view/kdrama-korean-slap-anger-angry-gif-9330050">https://tenor.com/view/kdrama-korean-slap-anger-angry-gif-9330050</a></li>
</ul>
<h2 id="가장-간단한-클라이언트"><a href="#가장-간단한-클라이언트" class="headerlink" title="가장 간단한 클라이언트"></a>가장 간단한 클라이언트</h2><p>가장 간단한 서버가 완성됐으니 터미널을 열어 <code>php ./app/server.php</code>로 일을 시키고 돌아오자.</p>
<p>새로운 터미널을 열어 <code>echo &quot;hello hello&quot; | nc 127.0.0.1 1337</code>를 입력하면 <code>hello hello</code>라고 반갑게 인사하는 것이 보일 것이다.</p>
<p>너무 시시하니까 가장 간단한 클라이언트를 만들어 잘 돌아가는 지 구경해보자.</p>
<p>아직 브라우저에서 HTTP 프로토콜로 붙을 상황은 아니므로 간단한 TCP 연결 클라이언트로 테스트 한다.</p>
<p>역시 <a target="_blank" rel="noopener" href="https://www.christophh.net/2012/07/24/php-socket-programming/">PHP Socket Programming, done the Right Way</a>에서 예시로 보여준 것을 기본으로 시작한다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$client</span> = <span class="title function_ invoke__">stream_socket_client</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$client</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Failed to connect: <span class="subst">$errno</span> - <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * generate a message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$startLine</span> = <span class="string">&#x27;GET / HTTP/1.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$headers</span> = [</span><br><span class="line">    <span class="string">&#x27;Host: localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept: */*&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"><span class="variable">$header</span> = <span class="title function_ invoke__">implode</span>(PHP_EOL, <span class="variable">$headers</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$emptyLine</span> = PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="variable">$body</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * request</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$message</span> = <span class="title function_ invoke__">implode</span>(PHP_EOL, [</span><br><span class="line">    <span class="variable">$startLine</span>,</span><br><span class="line">    <span class="variable">$header</span>,</span><br><span class="line">    <span class="variable">$emptyLine</span>,</span><br><span class="line">    <span class="variable">$body</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$message</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * bye bye</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br></pre></td></tr></table></figure>

<p>역시 별 거 없는 코드다.</p>
<p><code>stream_socket_client</code>으로 연결을 시도하고,</p>
<p>HTTP 메시지를 만들어 준다.</p>
<ul>
<li>HTTP 메시지는 시작줄, 헤더, 공백, 바디로 이뤄졌다. <a href="/2017/08/23/http-the-definitive-guide-chapter-3">참고</a></li>
</ul>
<p>이 메시지를 fwrite를 통해 스트림에 써 준다.</p>
<p><a href="/2017/10/06/phttp-02">02편</a>에서 얘기한 것처럼, <code>stream_socket_client</code>이 리턴하는 stream resource에는 fopen, fread같은 filesystem 함수를 사용할 수 있다.</p>
<h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p>터미널을 하나 열고 <code>php ./app/client.php</code>로 클라이언트를 실행해보자.</p>
<p>아무 반응이 없을 것이다.</p>
<p>하지만 조금만 더 기다려보면, 1분 후 timeout으로 client가 종료되고 자신이 서버에 전송한 값이 화면에 찍한다.</p>
<p>왜 그럴까?</p>
<p>다르게 재현해보자.</p>
<p>서버를 다시 실행하고 클라이언트를 다시 실행한 후, 이번엔 서버를 죽여보자.</p>
<p>이때도 클라이언트와 연결이 바로 끊어지고 서버에 전송한 값이 되돌아와 화면에 찍힌다.</p>
<p>우선 timeout 1분은 환경마다 다를 수 있는데, php.ini에 default_socket_timeout에 정의되어 있다.</p>
<p>client 소스의 response 부분을 아래와 같이 바꿔보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">4</span>))) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span> . <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그럼 아래와 같이 나오던 것이</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET / HTTP/1.0</span><br><span class="line">Host: localhost</span><br><span class="line">Accept: *</span><br></pre></td></tr></table></figure>

<p>아래와 같이 바로 찍힌다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET |/ HT|TP/1|.0</span><br><span class="line">H|ost:| loc|alho|st</span><br><span class="line">A|ccep|t: *|/*</span><br></pre></td></tr></table></figure>

<p><code>stream_get_contents</code>의 두번째 인자는 maxlength라서 지정한 만큼만 스트림에서 읽어온다.</p>
<p>그래서 읽어온 만큼 바로바로 화면에 echo 하는 것이다. </p>
<ul>
<li>보기 좋으라고(?)뒤에 |를 붙여봤다.</li>
</ul>
<p>하지만 이렇게 해도 클라이언트는 종료되지 않는다.</p>
<p><code>stream_get_contents</code>가 계속 스트림에 뭔가 들어오는지 지켜보고 있어서 while loop가 끝나지 않는다.</p>
<p>이 악순환의 고리를 끊으려면 서버에서 연결을 끊어버리면 간단한데, 우리 코드에선 클라이언트로 들어오는 스트림을 바로 돌려주기 때문에 쉽지 않다.</p>
<p>클라이언트에서 loop를 종료하려면 어디가 끝인지를 확인해야만 한다.</p>
<p>서버가 Content-Length를 돌려주게끔 해주면 좋겠지만 우리 서버는 아직 바보니까 클라이언트가 좀 더 고생을 하자. </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$messageLenth</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$message</span>);</span><br><span class="line"><span class="variable">$totalLenth</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$totalLenth</span> += <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$messageLenth</span> &lt;= <span class="variable">$totalLenth</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Updated"><a href="#Updated" class="headerlink" title="Updated"></a>Updated</h2><p>이 글 이후로 좀 더 진행해보다가 meta 정보를 이용하는 방법까지는 여기에 묻어두는 것이 좋을 것 같아서 내용을 추가한다.</p>
<p><code>stream_get_contents</code>으로 데이터를 가져온 다음 현재 스트림의 상태를 보려면 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-get-meta-data.php">stream_get_meta_data</a>를 통해 확인할 수 있다.</p>
<p>여기에는 다음과 같은 정보가 리턴된다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [timed_out] =&gt; </span><br><span class="line">    [blocked] =&gt; 1</span><br><span class="line">    [eof] =&gt; </span><br><span class="line">    [stream_type] =&gt; tcp_socket/ssl</span><br><span class="line">    [mode] =&gt; r+</span><br><span class="line">    [unread_bytes] =&gt; 1</span><br><span class="line">    [seekable] =&gt; </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>어쩐지 eof나 unread_bytes를 쓰면 될 것 같다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$client</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$info</span>[<span class="string">&#x27;eof&#x27;</span>] || <span class="variable">$info</span>[<span class="string">&#x27;unread_bytes&#x27;</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>이렇게 하니 소중한 고객님의 연결이 끊겼습니다.</p>
<p>그러나,</p>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-get-meta-data.php">문서</a>를 보면 unread_bytes가 의미하는 것은,</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">unread_bytes (int) - the number of bytes currently contained in the PHP&#x27;s own internal buffer.</span><br></pre></td></tr></table></figure>

<p>즉, PHP 자체의 내부 버퍼의 내용을 보여주는 것이라서 스크립트에서 활용하지 않을 것을 추천하고 있다. </p>
<blockquote>
<p>Note: You shouldn’t use this value in a script.</p>
</blockquote>
<p>그럼 포기하고 다른 방법을 찾아보자.</p>
<p>우선 client 쪽 소스에서 unread_bytes를 검사하는 부분만 제거한 다음,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$client</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$info</span>[<span class="string">&#x27;eof&#x27;</span>] || <span class="variable">$info</span>[<span class="string">&#x27;unread_bytes&#x27;</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>연결이 안 끊어지는 것을 반드시 확인하자.</p>
<p>그 다음,</p>
<p>서버쪽 소스에서 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-set-blocking.php">stream_set_blocking</a>으로 non-blocking 모드로 바꿔보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$client</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>즉, 서버의 전체 소스는 아래와 같이 변할 것이다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$client</span>, <span class="literal">false</span>);<span class="comment">// &lt;-- 여기요 여기</span></span><br><span class="line">        <span class="title function_ invoke__">stream_copy_to_stream</span>(<span class="variable">$client</span>, <span class="variable">$client</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>클라이언트를 실행하면 바로 연결이 끊긴다.</p>
<p><code>stream_set_blocking</code> 함수의 두번째 인자 mode가 false로 들어가면 non-blocking 모드로 진입하며,</p>
<p>클라이언트 쪽에서는 스트림으로 더이상의 데이터가 들어오는 것을 기다리지 않는다.</p>
<p>이렇게 하면 굳이 스트림을 쓸 이유가 없기 때문에 이 역시도 좋은 방법은 아닐 것이다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>아주 간단한 서버와 아주 간단한 클라이언트를 아주 간단히 살펴봤다.</p>
<p>도저히 못 써먹겠으니 다음 글에서는 이를 좀 더 개선해보자.<br>(뭘 어떻게 바꿀 지는 아직 계획없음)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/14/book-979-11-85152-65-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/14/book-979-11-85152-65-3/" class="post-title-link" itemprop="url">독후감 - 내 문장이 그렇게 이상한가요?</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-14 11:09:26" itemprop="dateCreated datePublished" datetime="2017-10-14T11:09:26+09:00">2017-10-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/14/book-979-11-85152-65-3/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/14/book-979-11-85152-65-3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://image.kyobobook.co.kr/images/book/large/431/l9791185152431.jpg" alt="내 문장이 그렇게 이상한가요?"></p>
<p>개발자들 사이에서 꽤 화제가 된 책이라 한번 가볍게 읽어봤다.</p>
<p>가볍게 읽을 수 있고 책 무게도 매우 가벼우나, 내용은 가볍지만은 않다.</p>
<p>읽고 난 후에는 계속 내 글을 돌아보게 하기도 하고,</p>
<p>남이 쓴 글이 거슬리기도 하고.</p>
<p>우리가 평소에 많이 쓰는 표현이 왜 이상한지에 집중한 책이다.</p>
<p>왜 이상한지 들었지만 계속 그대로 쓸 것 같은 문장도 있긴 하다. 직장 생활에서는 어울리는 그런 말.</p>
<p>이 책은 얼마 전에 읽은 ‘<a target="_blank" rel="noopener" href="http://www.kyobobook.co.kr/product/detailViewKor.laf?barcode=9788998791643">이와 손톱</a>‘처럼 두 개의 이야기를 교차해 보여준다.</p>
<p>이상한 문장 표현을 건조하게 알려주는 하나의 트랙이 있고, 교정에 관한 감성적인 소설이 또 하나의 트랙을 맡고 있다.</p>
<p>이 책을 선뜻 마초 성향의 뭇 남성들에게 추천하기 어려운 이유기도 하다.</p>
<p>문장 다듬는 것에만 관심이 있는 자라면 필요한 부분만 훑어봐도 좋을 것이다.</p>
<p>여러분도 하나 장만하시라.</p>
<p>종종 돌아보고 잊지 않기 위해 (나만 알 수 있게) 요약해둔다.</p>
<h2 id="요약"><a href="#요약" class="headerlink" title="요약"></a>요약</h2><p>적·의를 보이는 것·들</p>
<p>굳이 있다고 쓰지 않아도 어차피 있는</p>
<ul>
<li>있는</li>
<li>ㅡ관계에 있는</li>
<li>ㅡ에게 있어</li>
<li>ㅡ하는 데 있어</li>
<li>ㅡ함에 있어</li>
<li>ㅡ있음에 틀림없다</li>
</ul>
<p>지적으로 게을러 보이게 만드는 표현</p>
<ul>
<li>ㅡ에 대한</li>
<li>ㅡ들 중 하나&#x2F;한 사람&#x2F;무엇</li>
<li>ㅡ같은 경우</li>
<li>ㅡ에 의한, ㅡ으로 인한</li>
</ul>
<p>ㅡ에 vs ㅡ에는</p>
<p>내 문장은 대체 어디에서 와서 어디로 가는 걸까</p>
<ul>
<li>ㅡ에 vs ㅡ으로</li>
<li>ㅡ에 vs ㅡ을(를)</li>
<li>ㅡ로의, ㅡ에게로</li>
<li>ㅡ에, ㅡ에게, ㅡ에게서</li>
<li>ㅡ로부터</li>
</ul>
<p>당하고 시키는 말로 뒤덮힌 문장</p>
<ul>
<li>설레임</li>
<li>두번 당하는 말</li>
<li>시키다</li>
<li>시켜주다</li>
<li>커피 나오셨습니다</li>
</ul>
<p>사랑을 할 때와 사랑할 때의 차이</p>
<ul>
<li>ㅡ을 하다 vs ㅡ하다</li>
</ul>
<p>될 수 있는지 없는지</p>
<ul>
<li>될 수 있는, 할 수 있는</li>
</ul>
<p>문장은 손가락이 아니다</p>
<ul>
<li>그, 이, 저, 그렇게, 이렇게, 저렇게</li>
<li>여기, 저기, 거기</li>
<li>그 어느, 그 어떤, 그 누구, 그 무엇</li>
</ul>
<p>과거형을 써야 하는지 안 써도 되는지</p>
<ul>
<li>ㅡ었던</li>
<li>ㅡ는가</li>
</ul>
<p>시작할 수 있는 것과 없는 것</p>
<p>문장 다듬기</p>
<ul>
<li>왼쪽에서 오른쪽</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/12/phttp-03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/12/phttp-03/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 03 - CGIStream class 둘러보기</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-12 19:20:37" itemprop="dateCreated datePublished" datetime="2017-10-12T19:20:37+09:00">2017-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/12/phttp-03/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/12/phttp-03/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<p>지난번에 이어 CGIStream class(<a target="_blank" rel="noopener" href="https://github.com/youngj/httpserver">HTTPServer</a> 참고)를 살펴보는 시간.</p>
<p>말했지만, 좀 옛스러운 코드니 결벽증이 있는 분은 다음 장으로…</p>
<p>왜 요즘 버전의 소스를 분석하지 않냐는 질문도 할 법 하다.</p>
<p>못 구했다.</p>
<p>일단 이건 정말 공부를 위한 뻘짓이기 때문에 굳이 구현하고 싶은 사람이 없었을 것으로 보인다.</p>
<p>게다가 PHP5.4부터 내장 서버를 지원하는데 뭐하러 굳이…</p>
<p>다시 집중!</p>
<h2 id="CGIStream-class"><a href="#CGIStream-class" class="headerlink" title="CGIStream class"></a>CGIStream class</h2><p>주석을 보면 CGIStream class는 CGI 프로세스가 완료될 때까지 버퍼 기능도 하고, 헤더를 조작하는 것도 가능하다고 한다.</p>
<p>외부에서 이 클래스를 어떻게 사용하는 지 찾아보면 눈에 익은 문법이 보일 것이다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stream_wrapper_register</span>(<span class="string">&quot;cgi&quot;</span>, <span class="string">&quot;CGIStream&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>HTTPServer class(httpserver.php)에서 서버를 띄우기 전에 등록하는 코드다.</p>
<p>코드에서 보듯이 CGIStream class는 Stream wrapper class라고 할 수 있고,</p>
<p>Stream wrapper class의 메소드 중 <code>stream_cast</code>, <code>stream_open</code>, <code>stream_read</code>, <code>stream_eof</code>, <code>stream_close</code>만 구현했다.</p>
<p>이 중에 이해하기 쉬운 애들은 빼고 두가지 메소드만 설명해보겠다.</p>
<h3 id="stream-read"><a href="#stream-read" class="headerlink" title="stream_read"></a>stream_read</h3><p><code>stream_read</code>는 BUFFERING&#x2F;BUFFERED&#x2F;EOF 상태에 따라 해야할 일을 구현해놓았다.</p>
<p>BUFFERING 단계에선 버퍼에 request 메시지를 담고, server 쪽 클래스를 통해 request 구문을 분석하고, response를 위한 문자열을 만들고, 이를 data type의 스트림에 쌓아둔다. 그리고 현재 상태를 BUFFERED로 업데이트 한다.</p>
<p>BUFFERED 단계에선 앞서 data 스트림에 쌓아두었던 값을 리턴한다. 그리고 현재 상태를 EOF로.</p>
<p>EOF 단계에선 <code>return false;</code>.</p>
<p>내가 상상했던 코드는 이 스트림쪽에선 버퍼링 정도만 처리하고 나머지는 server 쪽 코드에 위임하는 것이었는데,</p>
<p><code>\r\n\r\n</code>(HTTP 메시지의 header와 body 구분자)로 메시지를 검사한다거나 <code>HTTPServer::parse_headers</code> 결과를 분석한다거나 하는 일도 한다.</p>
<p>이런 부분은 역할 분리가 덜 된 것 같다는 생각이 든다.</p>
<h3 id="stream-open"><a href="#stream-open" class="headerlink" title="stream_open"></a>stream_open</h3><p><code>stream_open</code> 메소드가 호출되는 시점은 php.net에서 <a target="_blank" rel="noopener" href="http://php.net/manual/en/streamwrapper.stream-open.php">이렇게</a> 설명한다.</p>
<blockquote>
<p>This method is called immediately after the wrapper is initialized</p>
</blockquote>
<p>wrapper가 초기화 될 때, 그러니까</p>
<p><code>fopen(&quot;cgi://PHP파일&quot;...</code></p>
<p>이런 식이다.</p>
<p><code>stream_open</code>에서 cgi로 php파일을 열고, <code>stream_read</code>에서 그 실행한 결과를 스트림으로 받아 처리하는 것이다.</p>
<p>이 예제에선 stream_context_get_options로 현재 설정된 <code>stdin</code>, <code>env</code>, <code>server</code>, <code>response</code> 등의 context를 얻어오고</p>
<p>이를 활용해 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.proc-open.php">proc_open</a>으로 스트림을 연다.</p>
<h2 id="CGIStream는-여기서-마무리"><a href="#CGIStream는-여기서-마무리" class="headerlink" title="CGIStream는 여기서 마무리"></a>CGIStream는 여기서 마무리</h2><p>이제 실제 서버를 띄우는 HTTPServer class에서 이 Stream wrapper(CGIStream class)를 등록하고 활용하는 부분을 보면 이 동네는 대략 이해가 될 것이다.</p>
<p>여기까지 분석해보니 결국 CGI용 Stream wrapper는 PHP 스크립트를 실행하기 위한 것이었다.</p>
<p><code>http://app.dev/test.php</code> 같은 요청을 받는 일 말이다.</p>
<p>즉, (일단은) HTML과 이미지 정도의 static한 응답만 처리할 나에게는 php-cgi binary 같은 건 필요없다!! (오예)</p>
<h2 id="HTTPServer-class"><a href="#HTTPServer-class" class="headerlink" title="HTTPServer class"></a>HTTPServer class</h2><p>이왕 본 김에 이 CGI 스트림 wrapper를 어떻게 등록하는 지만 살펴보고 (쓸 데 없었던) 2, 3장을 마무리 해야겠다.</p>
<p>HTTPServer class는 PHP 요청과 이미지 같은 static 리소스를 별도로 라우팅한다.</p>
<p>우선 서버를 실행하면</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stream_wrapper_register</span>(<span class="string">&quot;cgi&quot;</span>, <span class="string">&quot;CGIStream&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//중략</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$sock</span> = @<span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://<span class="subst">$addr_port</span>&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>);</span><br></pre></td></tr></table></figure>

<p>CGI용 스트림 wrapper를 등록하고 tcp 소켓을 하나 열어둔다.</p>
<p>Client가 요청한 리소스가 PHP 스크립트일 경우, HTTPServer의 <code>get_php_response</code> 메소드로 라우팅된다.</p>
<p>앞서 CGIStream의 <code>stream_open</code>을 설명하면서 stream_context_get_options으로 컨텍스트 정보를 가져온다고 했는데,</p>
<p>바로 여기에서 컨텍스트 정보를 만들어 주는 것이다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$context</span> = <span class="title function_ invoke__">stream_context_create</span>(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;cgi&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;env&#x27;</span> =&gt; <span class="title function_ invoke__">array_merge</span>(<span class="variable">$_ENV</span>, <span class="variable">$this</span>-&gt;cgi_env, <span class="variable">$cgi_env</span>),</span><br><span class="line">        <span class="string">&#x27;stdin&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;content_stream,</span><br><span class="line">        <span class="string">&#x27;server&#x27;</span> =&gt; <span class="variable">$this</span>,</span><br><span class="line">        <span class="string">&#x27;response&#x27;</span> =&gt; <span class="variable">$response</span>,</span><br><span class="line">    )</span><br><span class="line">));</span><br><span class="line"><span class="variable">$cgi_stream</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;cgi://<span class="subst">&#123;$this-&gt;php_cgi&#125;</span>&quot;</span>, <span class="string">&#x27;rb&#x27;</span>, <span class="literal">false</span>, <span class="variable">$context</span>);</span><br></pre></td></tr></table></figure>

<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>예상대로(?) php-cgi binary 같은 건 필요없다는 결론을 얻기 위해 긴 시간을 허비했다.</p>
<p>이 시리즈의 다음 글부터는 최소한의 구성으로 서버를 띄우고, 기능을 하나씩 입혀 나갈 예정이다.</p>
<p>그러니까…</p>
<p>예정이다.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/06/phttp-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/06/phttp-02/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 02 - Stream wrapper</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-06 11:18:47" itemprop="dateCreated datePublished" datetime="2017-10-06T11:18:47+09:00">2017-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/06/phttp-02/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/06/phttp-02/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h1 id="Stream-wrapper-class"><a href="#Stream-wrapper-class" class="headerlink" title="Stream wrapper class"></a>Stream wrapper class</h1><p>시행착오를 최대한 줄이기 위해 앞에서 소개했던 <a target="_blank" rel="noopener" href="https://github.com/youngj/httpserver">HTTPServer</a>부터 분석을 해보기로 했다.</p>
<p>composer.json에 있는 php-cgi binary에 대한 의존성 때문인데(<code>HTTPServer requires the php-cgi binary</code>), 이 놈을 왜 넣었을까 궁금했다.</p>
<p>이 서버는 4개의 파일로 구성됐다.</p>
<ul>
<li>cgistream.php</li>
<li>httprequest.php</li>
<li>httpresponse.php</li>
<li>httpserver.php</li>
</ul>
<p>http가 prefix로 붙은 파일은 뭐하는 놈인지 이름만 봐도 알 것 같다. cgistream.php을 열어봤다.</p>
<p>오래전에 만든 클래스라서 좀 옛스러운 맛이 있다.</p>
<h2 id="CGIStream-class-주석"><a href="#CGIStream-class-주석" class="headerlink" title="CGIStream class 주석"></a>CGIStream class 주석</h2><p>주석부터 살펴볼까?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * CGIStream is a PHP stream wrapper (http://www.php.net/manual/en/class.streamwrapper.php)</span></span><br><span class="line"><span class="comment"> * that wraps the stdout pipe from a CGI process. It buffers the output until the CGI process is</span></span><br><span class="line"><span class="comment"> * complete, and then rewrites some HTTP headers (Content-Length, Status, Server) and sets the HTTP status code</span></span><br><span class="line"><span class="comment"> * before returning the output stream from fread().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This allows the server to be notified via stream_select() when the CGI output is ready, rather than waiting</span></span><br><span class="line"><span class="comment"> * until the CGI process completes.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>CGIStream is a <a target="_blank" rel="noopener" href="http://www.php.net/manual/en/class.streamwrapper.php">PHP stream wrapper</a> that wraps the stdout pipe from a CGI process.</p>
</blockquote>
<p>CGI process로부터 흘러나오는 stdout stream을 wrapping한다. - 이건 뭐 해석한 것도 아니고 안 한 것도 아니고…</p>
<p>참고로, 앞으로 스트림과 stream을 섞어서 쓸텐데(한글 혹은 영어로), 여기엔 큰 의미를 부여하지 말고 그냥 읽으시면 된다.</p>
<h2 id="Stream-wrapper-class-1"><a href="#Stream-wrapper-class-1" class="headerlink" title="Stream wrapper class"></a>Stream wrapper class</h2><p>php.net에 들어가보면,</p>
<blockquote>
<p>Allows you to implement your own protocol handlers and streams for use with all the other filesystem functions (such as fopen(), fread() etc.).</p>
</blockquote>
<p>나만의 프로토콜 핸들러와 fopen, fread같은 filesystem 함수를 사용할 수 있는 스트림을 구현할 수 있다고 한다.</p>
<p>php.net의 VariableStream을 만드는 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-wrapper-register.php">예제</a>부터 알아봐야겠다.</p>
<p>우선 커스텀 stream wrapper를 어떻게 사용하는지부터.</p>
<h2 id="Using-stream-wrapper"><a href="#Using-stream-wrapper" class="headerlink" title="Using stream wrapper"></a>Using stream wrapper</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$existed</span> = <span class="title function_ invoke__">in_array</span>(<span class="string">&quot;var&quot;</span>, <span class="title function_ invoke__">stream_get_wrappers</span>());</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$existed</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&quot;var&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_register</span>(<span class="string">&quot;var&quot;</span>, <span class="string">&quot;VariableStream&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>“var”로 이미 등록된 wrapper가 있다면 먼저 제거한다.</p>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-get-wrappers.php">stream_get_wrappers</a>는 등록된 stream wrapper 배열을 리턴하는데, 보통 이런 리스트가 나올 것이다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; https</span><br><span class="line">    [1] =&gt; ftps</span><br><span class="line">    [2] =&gt; compress.zlib</span><br><span class="line">    [3] =&gt; compress.bzip2</span><br><span class="line">    [4] =&gt; php</span><br><span class="line">    [5] =&gt; file</span><br><span class="line">    [6] =&gt; glob</span><br><span class="line">    [7] =&gt; data</span><br><span class="line">    [8] =&gt; http</span><br><span class="line">    [9] =&gt; ftp</span><br><span class="line">    [10] =&gt; phar</span><br><span class="line">    [11] =&gt; zip</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>이렇게 unregister하더라도 built-in wrapper일 경우는 나중에 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-wrapper-restore.php">stream_wrapper_restore</a>로 복원할 수 있다.</p>
<p><code>stream_wrapper_register</code>함수의 두번째 인자는 첫번째 인자(protocol)에 해당하는 스트림을 처리할 클래스명이다.</p>
<p>이런 클래스를 어떻게 구현할 것인지는 잠시 후에 다룬다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$myvar</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;var://myvar&quot;</span>, <span class="string">&quot;r+&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&quot;line1\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&quot;line2\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&quot;line3\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>위에서 언급한 대로 stream wrapper를 구현하면 fopen, fread같은 filesystem 함수를 사용할 수 있다.</p>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/kr/function.fopen.php">fopen</a> 함수로 스트림을 r+(초기화가 없는 read+write) 모드로 열고, 몇 줄 써준다.</p>
<p>URL에는 아까 <code>stream_wrapper_register</code>함수에 첫번째 인자로 등록한 protocol을 URL scheme으로 사용하고 입력받을 myvar라는 전역 변수를 사용한다.</p>
<p>물론 URL을 어떻게 쓰고 처리할 지는 wrapper 구현에 달려있다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">rewind</span>(<span class="variable">$fp</span>);</span><br><span class="line"><span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$myvar</span>);</span><br></pre></td></tr></table></figure>

<p>파일 포인터를 맨 앞으로 돌리고, 파일의 내용을 한줄 한줄 써준다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$existed</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">stream_wrapper_restore</span>(<span class="string">&quot;var&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>다 썼으면 초기화 한다. 만약,</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">stream_wrapper_register(&quot;var&quot;, &quot;VariableStream&quot;);</span><br><span class="line">stream_wrapper_unregister(&quot;var&quot;);</span><br><span class="line">stream_wrapper_restore(&quot;var&quot;);</span><br></pre></td></tr></table></figure>
<p>이러면 뭐 달라질까? 방금 등록한 <code>var</code> wrapper는 built-in이 아니기 때문에 restore해도 아무 의미 없다.</p>
<p>사용하는 방법은 특별할 게 없으므로, VariableStream이란 클래스를 어떻게 구현하면 될지 살펴보자.</p>
<h2 id="Stream-wrapper"><a href="#Stream-wrapper" class="headerlink" title="Stream wrapper"></a>Stream wrapper</h2><p><a target="_blank" rel="noopener" href="http://php.net/manual/en/class.streamwrapper.php">Stream wrapper class</a>는 넓은 의미의 인터페이스지만,</p>
<p>implements 할 수 있는 interface는 아니다. 실제 존재하는 클래스가 아니라 어떻게 동작하는 지를 보여주기 위한 prototype일 뿐이다.</p>
<blockquote>
<p>Note:<br>  This is NOT a real class, only a prototype of how a class defining its own protocol should be.</p>
</blockquote>
<p>php.net에 누가 댓글로 interface로 만들어 올렸지만, 그건 거 쓰지 말라는 댓글도 보인다(필요하지 않은 메소드도 무조건 구현해놔야 하기 때문에).</p>
<p>필요한 메소드만 구현하는 게 정석이라고 보면 되겠다.</p>
<p>댓글로 올라온 VariableStream 클래스를 참고해서 위 스크립트가 돌아갈 만한 간단한 커스텀 wrapper를 실행해봤다.</p>
<p>몇가지 문법 오류와 변수명을 좀 더 알기 쉽게 바꿨다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VariableStream</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$position</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$varname</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_open</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$mode</span>, <span class="variable">$options</span>, &amp;<span class="variable">$opened_path</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$path</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;varname = <span class="variable">$url</span>[<span class="string">&quot;host&quot;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;position = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_read</span>(<span class="params"><span class="variable">$count</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$position</span> =&amp; <span class="variable language_">$this</span>-&gt;position;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$this</span>-&gt;varname], <span class="variable">$position</span>, <span class="variable">$count</span>);</span><br><span class="line">        <span class="variable">$position</span> += <span class="title function_ invoke__">strlen</span>(<span class="variable">$ret</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_write</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$variable</span> =&amp; <span class="variable">$GLOBALS</span>[<span class="variable language_">$this</span>-&gt;varname];</span><br><span class="line">        <span class="variable">$len</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$position</span> =&amp; <span class="variable language_">$this</span>-&gt;position;</span><br><span class="line">        <span class="variable">$variable</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$variable</span>, <span class="number">0</span>, <span class="variable">$position</span>) . <span class="variable">$data</span> . <span class="title function_ invoke__">substr</span>(<span class="variable">$variable</span>, <span class="variable">$position</span> += <span class="variable">$len</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$len</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_tell</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_eof</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;position &gt;= <span class="title function_ invoke__">strlen</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$this</span>-&gt;varname]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_seek</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$whence</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$len</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$this</span>-&gt;varname]);</span><br><span class="line">        <span class="variable">$position</span> =&amp; <span class="variable language_">$this</span>-&gt;position;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$whence</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> SEEK_SET:</span><br><span class="line">                <span class="variable">$newPos</span> = <span class="variable">$offset</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SEEK_CUR:</span><br><span class="line">                <span class="variable">$newPos</span> = <span class="variable">$position</span> + <span class="variable">$offset</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SEEK_END:</span><br><span class="line">                <span class="variable">$newPos</span> = <span class="variable">$len</span> + <span class="variable">$offset</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ret</span> = (<span class="variable">$newPos</span> &gt;= <span class="number">0</span> &amp;&amp; <span class="variable">$newPos</span> &lt;= <span class="variable">$len</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$ret</span>) &#123;</span><br><span class="line">            <span class="variable">$position</span> = <span class="variable">$newPos</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>여기선 <code>stream_open</code>, <code>stream_read</code>, <code>stream_write</code>, <code>stream_tell</code>, <code>stream_eof</code>, <code>stream_seek</code> 만을 구현했는데,</p>
<p>그 (가상) 인터페이스의 많은 메소드 중에 뭘 구현해야 할 지 어떻게 알 수 있을까?</p>
<p>그건 사용처에서 어떤 filesystem 함수를 쓰는가에 따라 다르다.</p>
<p>이 예제에서 <code>stream_tell</code> 함수를 구현하지 않았다면, 아래와 같은 warning이 뜰 것이다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PHP Warning:  rewind(): VariableStream::stream_tell is not implemented! in .....</span><br></pre></td></tr></table></figure>

<p>공용 클래스라면 좀 더 충실히 구현해야겠지만, 이 예제는 이만하면 됐다.</p>
<p>많이 돌아왔는데, 맨 처음에 언급한 CGIStream 클래스로 돌아갈 차례다(이제 겨우 CGIStream 클래스의 주석 한줄 읽었을 뿐이다).</p>
<p>다음 글에 계속..</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/05/phttp-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/05/phttp-01/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 01 - 계획</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-05 01:12:15" itemprop="dateCreated datePublished" datetime="2017-10-05T01:12:15+09:00">2017-10-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/05/phttp-01/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/05/phttp-01/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<p>HTTP 완벽가이드 5장을 가볍게 읽다가, Perl로 만든 간단한 서버 구현을 보고 이걸 PHP로 구현해보면 좋겠다는 생각을 했다.</p>
<p>그 예제는 (대충 봤는데) HTTP 서버라기 보다 소켓 연결해서 응답해주는 수준의 간단한 구현이었던 것 같고, HTTP 서버가 되려면 뭘 해야하는지는 설명으로만 보여준다.</p>
<p>이응준님은 “<a target="_blank" rel="noopener" href="https://blog.npcode.com/2015/06/07/%EC%9B%B9-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%A8%B8%EB%A5%BC-%EC%9C%84%ED%95%9C-http-%EC%99%84%EB%B2%BD-%EA%B0%80%EC%9D%B4%EB%93%9C-%EC%9D%BD%EB%8A%94-%EB%B2%95/">웹 프로그래머를 위한 HTTP 완벽 가이드 읽는 법</a>“에서</p>
<blockquote>
<p>5장 “웹 서버”는 웹 서버가 어떻게 동작하는지 설명한다. 웹 프로그래머라면 반드시 이해해야 할 것이다.</p>
</blockquote>
<p>라고 하셨지만, 사실 책에는 뭐 그리 많은 내용이 있는 건 아니다.</p>
<p>HTTP 완벽가이드 5장의 내용을 더 알고 싶다면, <a target="_blank" rel="noopener" href="https://www.slideshare.net/cinari4/http-ch5-web-server">남이 정리한 HTTP 완벽가이드 5장</a> 자료를 찾아봐도 좋겠다.</p>
<h2 id="구현-목표"><a href="#구현-목표" class="headerlink" title="구현 목표"></a>구현 목표</h2><p>몇부작이 될 지는 모르겠으나 시간날 때마나 기능을 하나씩 추가해볼까 한다.</p>
<p>단일 쓰레드로 하나의 요청만 처리하는 것부터 시작하기 때문에,</p>
<p>나중에 ReactPHP나 <a target="_blank" rel="noopener" href="http://php.net/manual/en/intro.pthreads.php">멀티쓰레딩 처리</a>(PHP 7.2이상 + CLI 모드에선 가능한 듯) 혹은 멀티쓰레딩 흉내를 내는 것까지 갈 것 같다.</p>
<p>물론 올 해 안을 목표로 하는 프로젝트도 있기 때문에…한두번 하고 그만둘 수도 있다!<br>(중요&#x2F;강조&#x2F;미리죄송)</p>
<p>지금은 뭔가 신났지만…시작이나 하면 다행.</p>
<p>1차로 구현하고자 하는 기능은 ‘이미지가 하나 포함된 HTML 파일을 서비스한다’.</p>
<p>즉, HTML 파일 하나와 이미지 하나 정도 서비스 할 수 있는 능력이면 됐다.</p>
<p>예를 들어 이런 식.</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;ko&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>PHTTP<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://www.engadget.com/media/2006/02/beer_server.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;beer_server&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="가장-간단하게-시작하기"><a href="#가장-간단하게-시작하기" class="headerlink" title="가장 간단하게 시작하기"></a>가장 간단하게 시작하기</h2><p><a target="_blank" rel="noopener" href="http://php.net/manual/kr/sockets.examples.php">php.net의 예제</a></p>
<ul>
<li>클래식한 소켓 연결 예제 프로그램</li>
<li>5년 전 기억을 더듬어 보면 이런 식으로 짰던 것 같기도 하다</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.christophh.net/2012/07/24/php-socket-programming/">PHP Socket Programming, done the Right Way</a></p>
<ul>
<li>여기서는 PHP5.0 부터 사용할 수 있는 stream_socket_* 친구들을 소개한다</li>
<li>존 레식 닯은 청년이 아주 친절하게 설명해주기 때문에, 누구든 국경을 초월한 지식 습득이 가능하다</li>
<li>안 쓸 이유가 없다</li>
</ul>
<p>찾아보니 OOP 방식의 간단한 구현체도 보임</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/youngj/httpserver">A simple HTTP server</a></li>
<li>아마도 위의 저 간단한 서버로 운영을 하다보면 겪을 수많은 고민이 담겨 있다(간단하게 구현 했음에도!)</li>
<li>하지만 내 수준에서 보면 너무 많이 구현해놓았으니, 간간히 안 풀릴 때 참고만 해보자</li>
</ul>
<h2 id="기본-기능"><a href="#기본-기능" class="headerlink" title="기본 기능"></a>기본 기능</h2><p>socket create&#x2F;bind&#x2F;listen까지는 가장 간단하게 구현된 놈을 쓰자.</p>
<p>최신 스타일로 하자면 stream_socket_server&#x2F;stream_socket_accept.</p>
<p>이제 main 스크립트 하나 돌리면서, 들어오는 스트림을 앞으로 만들 클래스 인스턴스로 넘겨주는 작업부터 본격 개발 시작이다.</p>
<p>구현할 기능</p>
<ul>
<li>요청 메시지 읽어들이기</li>
<li>메시지 파싱</li>
<li>리소스 접근<ul>
<li>config파일 활용<ul>
<li>document root, virtual host</li>
</ul>
</li>
</ul>
</li>
<li>응답 만들기<ul>
<li>응답 코드 &#x2F; 헤더 &#x2F; 본문을 어떻게 구성할 지 정한다</li>
</ul>
</li>
<li>응답&#x2F;로그</li>
</ul>
<h2 id="예상되는-변화"><a href="#예상되는-변화" class="headerlink" title="예상되는 변화"></a>예상되는 변화</h2><p>앞에서 언급한 대로 다중커넥션 처리</p>
<p>400&#x2F;500번 대 일부 구현</p>
<ul>
<li>400, 404, 500 정도 구현할까 싶은데</li>
<li>에러 페이지는 사치</li>
</ul>
<p>경로 조회 공격 방어 [<a target="_blank" rel="noopener" href="https://www.ibm.com/support/knowledgecenter/ko/SSB2MG_4.6.2/com.ibm.ips.doc/concepts/wap_path_traversal.htm">?</a>]</p>
<p>directory index</p>
<h2 id="저장소"><a href="#저장소" class="headerlink" title="저장소"></a>저장소</h2><p>GitHub : <a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp">https://github.com/youngiggy/phttp</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/09/22/mac-filename-normalization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/22/mac-filename-normalization/" class="post-title-link" itemprop="url">Mac에서 올린 한글 파일명(NFD 정규화) 문제</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-22 12:09:48" itemprop="dateCreated datePublished" datetime="2017-09-22T12:09:48+09:00">2017-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/09/22/mac-filename-normalization/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/22/mac-filename-normalization/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>이전 <a href="/2017/08/23/alphabetic-letter-validation/">유니코드를 다뤘던 글</a>을 올렸을 때 모던 PHP 그룹에서 댓글로 잠시 언급되었던,</p>
<p>NFD 정규화 문제.</p>
<p>맥에서 올린 파일이 다운로드 안된다는 VOC(고객의 소리)가 들어와서 원인 파악 겸 정리해봤다.</p>
<p>맥에서 ‘한글.txt’ 파일을 올리고 윈도에서 다운로드 받으면 ‘ㅎㅏㄴㄱㅡㄹ.txt’로 보이게된다.</p>
<p>유니코드 상에서 한글을 표현하는 방법은 첫가끝(처음가운데끝)이라고도 하는 한글 자모를 조합하는 방식과 완성형으로 표시하는 방법 등이 있다. </p>
<p>맥에서는 파일명을 저장할 때 NFD 방식. 즉, 한글 자모를 따로따로 받아 조합하는 방식으로 정규화를 하는데,</p>
<p>이 현상에 관해선 다른 분들이 열심히 글을 써주셨으니 더이상 설명하진 않겠다.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.asamaru.net/2016/11/15/php-nfd-to-nfc/">PHP에서 NFD(Normalization Form D) &#x2F; NFC(Normalization Form C) 변환</a></li>
</ul>
<h2 id="Normalizer-Class-설치"><a href="#Normalizer-Class-설치" class="headerlink" title="Normalizer Class 설치"></a>Normalizer Class 설치</h2><p>PHP 5.3부터 <a target="_blank" rel="noopener" href="http://php.net/manual/en/class.normalizer.php">Normalizer Class</a>를 사용할 수 있는데,</p>
<p>Internationalization Functions에 포함되어 이 확장 모듈을 설치해야 한다.</p>
<ul>
<li><p>이건 ICU 라이브러리의 wrapper인 관계로 ICU를 먼저 설치해야할 수 있다(libicu-devel , libicu 등)</p>
</li>
<li><p>Windows 시스템에선 php_intl.dll을 구해야하고, XAMPP를 쓴다면 모듈은 이미 ext에 존재할 것이다. </p>
</li>
<li><p>Linux 기반 시스템이라면</p>
<ul>
<li>apt-get install php-intl (for ubuntu-based linux)</li>
<li>yum install php-intl (for CentOS)</li>
<li>php7.x-intl 등 php 버전에 따라 다를 수 있으니 알맞게 설치할 것</li>
</ul>
</li>
<li><p>Mac에서 brew를 사용한다면 brew install php71-intl</p>
</li>
</ul>
<p>이후 php.ini에서 extension&#x3D;php_intl.(dll|so)을 활성화 시켜야 한다. 즉, 맨 앞의; 제거하기.</p>
<h2 id="처리-방법"><a href="#처리-방법" class="headerlink" title="처리 방법"></a>처리 방법</h2><p>잘 설치됐는지 확인해보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testNormalizer</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;-------------------------&#x27;</span> . PHP_EOL;</span><br><span class="line">    <span class="variable">$urlencodedInitialStr</span> = <span class="title function_ invoke__">urlencode</span>(<span class="variable">$str</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$str</span> . PHP_EOL;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">echo</span> ( <span class="title class_">Normalizer</span>::<span class="title function_ invoke__">isNormalized</span>(<span class="variable">$str</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_C</span>) ) ? <span class="string">&quot;normalized : FORM_C&quot;</span> : <span class="string">&quot;not normalized : FORM_C&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> ( <span class="title class_">Normalizer</span>::<span class="title function_ invoke__">isNormalized</span>(<span class="variable">$str</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_D</span>) ) ? <span class="string">&quot;normalized : FORM_D&quot;</span> : <span class="string">&quot;not normalized : FORM_D&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">$str</span> = <span class="title class_">Normalizer</span>::<span class="title function_ invoke__">normalize</span>(<span class="variable">$str</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_C</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;normalize to FORM_C : &#x27;</span> . <span class="variable">$str</span> . PHP_EOL;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;urlencoded before: &#x27;</span> . <span class="variable">$urlencodedInitialStr</span> . PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;urlencoded after~: &#x27;</span> . <span class="title function_ invoke__">urlencode</span>(<span class="variable">$str</span>) . PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$name1</span>=<span class="string">&#x27;recruit/recruit/201709/21/owlupr_58qh-1meg1s6_recruit.pdf&#x27;</span>;<span class="comment">//일반 ASCII 문자열</span></span><br><span class="line"><span class="variable">$name2</span>=<span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%E1%84%86%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3_%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%8B%E1%85%B5%E1%84%82%E1%85%A6.pdf&#x27;</span>);<span class="comment">//NFD로 정규화된 파일명을 urlencode해서 받을 경우</span></span><br><span class="line"><span class="variable">$name3</span>=<span class="string">&#x27;테스트.pdf&#x27;</span>;<span class="comment">//일반 한글 문자열</span></span><br><span class="line"> </span><br><span class="line"><span class="title function_ invoke__">testNormalizer</span>(<span class="variable">$name1</span>);</span><br><span class="line"><span class="title function_ invoke__">testNormalizer</span>(<span class="variable">$name2</span>);</span><br><span class="line"><span class="title function_ invoke__">testNormalizer</span>(<span class="variable">$name3</span>);</span><br></pre></td></tr></table></figure>

<p>결과는</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-------------------------</span><br><span class="line">recruit/recruit/201709/21/owlupr_58qh-1meg1s6_recruit.pdf</span><br><span class="line">normalized : FORM_C</span><br><span class="line">normalized : FORM_D</span><br><span class="line">normalize to FORM_C : recruit/recruit/201709/21/owlupr_58qh-1meg1s6_recruit.pdf</span><br><span class="line">urlencoded before: recruit%2Frecruit%2F201709%2F21%2Fowlupr_58qh-1meg1s6_recruit.pdf</span><br><span class="line">urlencoded after~: recruit%2Frecruit%2F201709%2F21%2Fowlupr_58qh-1meg1s6_recruit.pdf</span><br><span class="line"></span><br><span class="line">-------------------------</span><br><span class="line">맥에서테스트_중이네.pdf</span><br><span class="line">not normalized : FORM_C</span><br><span class="line">normalized : FORM_D</span><br><span class="line">normalize to FORM_C : 맥에서테스트_중이네.pdf</span><br><span class="line">urlencoded before: %E1%84%86%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3_%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%8B%E1%85%B5%E1%84%82%E1%85%A6.pdf</span><br><span class="line">urlencoded after~: %EB%A7%A5%EC%97%90%EC%84%9C%ED%85%8C%EC%8A%A4%ED%8A%B8_%EC%A4%91%EC%9D%B4%EB%84%A4.pdf</span><br><span class="line"></span><br><span class="line">-------------------------</span><br><span class="line">테스트.pdf</span><br><span class="line">normalized : FORM_C</span><br><span class="line">not normalized : FORM_D</span><br><span class="line">normalize to FORM_C : 테스트.pdf</span><br><span class="line">urlencoded before: %ED%85%8C%EC%8A%A4%ED%8A%B8.pdf</span><br><span class="line">urlencoded after~: %ED%85%8C%EC%8A%A4%ED%8A%B8.pdf</span><br></pre></td></tr></table></figure>

<p>소스에는 아래와 같이 적용 해놓으면 된다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">class_exists</span>(<span class="string">&#x27;Normalizer&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Normalizer</span>::<span class="title function_ invoke__">isNormalized</span>(<span class="variable">$filename</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_D</span>)) &#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="title class_">Normalizer</span>::<span class="title function_ invoke__">normalize</span>(<span class="variable">$filename</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_C</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>파일명을 DB에 입력할 때 NFC로 넣는 것이 깔끔하겠지만,<br>이미 NFD 정규화된 파일명이 들어가있다면, 다운로드 시에도 파일명을 바꿔주면 된다.</p>
<h3 id="한숨"><a href="#한숨" class="headerlink" title="한숨"></a>한숨</h3><p>이 밖에 파일 다운로드 관련 코드를 보면 별별 예외처리가 많이 들어가 세월의 흔적을 느낄 수 있다.</p>
<p>IE라면 파일명을 또 MS949로 변경해줘야 해야만 한다.<br>OS 별로 <a target="_blank" rel="noopener" href="https://ko.wikipedia.org/wiki/%ED%8C%8C%EC%9D%BC_%EC%9D%B4%EB%A6%84">파일명에 들어갈 수 있는 특수문자</a>도 다르다.<br>기타 등등.</p>
<p>특정 OS는 점유율이 낮아서, 시스템이 낡아서, 인력이 부족해서, 개발자 역량이 부족해서, 지금은 더 급한 게 있어서…<br>cross-platform 대응은 항상 어렵다.</p>
<h3 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h3><ul>
<li><a target="_blank" rel="noopener" href="http://php.net/manual/en/class.normalizer.php">http://php.net/manual/en/class.normalizer.php</a></li>
<li><a target="_blank" rel="noopener" href="http://php.net/manual/en/intro.intl.php">http://php.net/manual/en/intro.intl.php</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.asamaru.net/2016/11/15/php-nfd-to-nfc/">https://blog.asamaru.net/2016/11/15/php-nfd-to-nfc/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dotkernel.com/php-troubleshooting/where-is-the-intl-php-extension-problem-solved/">https://www.dotkernel.com/php-troubleshooting/where-is-the-intl-php-extension-problem-solved/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/09/18/book-979-11-85890-85-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/18/book-979-11-85890-85-2/" class="post-title-link" itemprop="url">독후감 - 클린 소프트웨어</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-18 22:50:30" itemprop="dateCreated datePublished" datetime="2017-09-18T22:50:30+09:00">2017-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-03-04 23:01:26" itemprop="dateModified" datetime="2018-03-04T23:01:26+09:00">2018-03-04</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/09/18/book-979-11-85890-85-2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/18/book-979-11-85890-85-2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://image.kyobobook.co.kr/images/book/large/852/l9791185890852.jpg" alt="클린 소프트웨어"></p>
<p>이 책에 인쇄된 문자를 거의 다 읽긴 했으나,<br>내가 이 책을 읽었다고 할 수 있을까 생각이 드는 책이다.</p>
<p>목차</p>
<ul>
<li>PART 1 애자일 개발 </li>
<li>PART 2 애자일 설계</li>
<li>PART 3 급여 관리 사례 연구</li>
<li>PART 4 급여 관리 시스템 패키징</li>
<li>PART 5 기상 관측기 사례 연구</li>
<li>PART 6 ETS 사례 연구</li>
<li>APPENDIX A UML 표기법 I: CGI 예제</li>
<li>APPENDIX B UML 표기법 II: 스태트먹스</li>
<li>APPENDIX C 두 기업에 대한 풍자</li>
<li>APPENDIX D 소스 코드는 곧 설계다</li>
</ul>
<p>먼 나라 이야기라고 생각이 드는 PART 1에서 작은 고민을 얻어왔다면</p>
<p>PART 2에서는 SOLID 원칙을 제대로 이해하기 위한 색다른 관점이 좋았고(그런데 10여 년 전에 출간된 이 책을 두고 색다르다고 해도 실례가 안 되려나).</p>
<p>PART 3부터 익숙치 않은 C++ 문법과 더 익숙치 않은 UML 문법 때문에 눈이 뻑뻑해지기 시작했는데, 결국 부록의 UML 표기법을 먼저 보고올 수 밖에 없었다. 그런데 이 책을 읽는데 별로 도움 안되는 것 같고, 그냥 간단한 규칙 정도만 찾아보고 책을 한번 더 읽는 것이 좋겠다는 생각이 들었다. 아무래도 밥아저씨의 UML 책을 읽어야겠구나 싶을 정도로 UML로부터 설계를 해나가는 모습이 꽤 매력적으로 느껴졌다(현실은 시궁창일 걸 알면서 말이다). </p>
<p>PART 4는 방금 늪에서 빠져나온 여우마냥 숨 좀 고를 수 있는 챕터였지만, PHP&#x2F;JavaScript를 쓰는 상황에서 패키징에 대한 글을 읽자니 남일 같아서 마음이 편했다.</p>
<p>PART 5에선 PART 3의 급여 관리 사례와 비슷한 포맷이긴 한데, 일단 급여 관리에서 빠져나와 새 인생을 시작한 기분이었으므로 나름 재미있게 읽었던 것 같다.</p>
<p>PART 6도 완벽하게 이해는 못했지만 다시 읽으면 그럭저럭 이해는 될 것 같긴 하다.</p>
<p>APPENDIX B는 전혀 모르겠고..</p>
<p>APPENDIX C가 꽤 인상적이었다. 두 기업에 대한 풍자라고 하는데, 왼쪽엔 그지같은 기업, 오른쪽엔 이상적인 기업을 나란히 덧대어 놓았다. 그동안 왼쪽같은 문화에서만 살았고(그리고 아마 10월부터 또 겪어야 할텐데..), 오른쪽같은 문화를 꿈꾸지만 경험은 없는 상태. 이 책을 힘겹게 읽으면서 좀 지쳤는데, 이 부록을 읽으며 다시 전의가 불타올랐다(하지만 이제 곧 잘 시간). 조금이라도 시도해 보리라 다짐을 해봤다(현실은 시궁창일 걸 알면서 말이다).  </p>
<p>APPENDIX D도 너무 좋았다. 10년 전에 쓴 이 책에 10년 전에 썼다는 글을 소개한 내용인데, 공학에서의 최종 결과물은 문서가 되어야 하고, 소프트웨어 공학에서의 문서라 함은 코드 자체라는 주장이다. 그냥 자기계발서 같은 글인가 싶었는데, 이 양반은 진심이었고 다 읽고 나선 진심 공감이 됐다.   </p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>다시 읽어야 한다.</p>
<p>읽기 시작하면서부터 몇 번을 다시 읽어야 할까 생각이 들었던 책이다. 지금 바로 다시 읽어야 이 책을 읽기나 했다고 어디가서 얘기라도 할텐데…</p>
<p>내년에 다시 읽어보기로 했다. 누구 안 주고 책장에 잘 모셔두고 내년 초에 다시 읽어보겠다.</p>
<p>실무에서 좀 더 부딪혀보고, 실습해보고, 다시 보면 이해하는 폭이 더 넓어지리라 생각이 든다(현실은 시궁창일 걸 알면서 말이다).</p>
<h2 id="원몰띵"><a href="#원몰띵" class="headerlink" title="원몰띵"></a>원몰띵</h2><p>이런 책을 읽으면서 항상 느끼는 거지만…</p>
<p>테스트가 주도하지 않고도 제대로된 소프트웨어를 만드는 게 가능이나 한가…뭐 그런 생각이 든다.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/09/18/book-978-89-6262-115-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/18/book-978-89-6262-115-0/" class="post-title-link" itemprop="url">독후감 - 세상물정의 물리학</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-18 22:26:33" itemprop="dateCreated datePublished" datetime="2017-09-18T22:26:33+09:00">2017-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/09/18/book-978-89-6262-115-0/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/18/book-978-89-6262-115-0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://image.kyobobook.co.kr/images/book/large/150/l9788962621150.jpg" alt="세상물정의 물리학"></p>
<p>6월 말에 개발과 관련없는 책을 읽어보려고 집어왔던 책.<br>올해 8월 제천 영화제에 들고가서 조금 읽고 왔던 책.</p>
<p>그 당시 감상으로 ‘좌파 교수(좋은 의미로)가 쓴 책’ 정도로 이야기 했지만,<br>그건 정말 초반에 (의도는 좋지만 &#x3D; 선하지만) 재미가 없어서 했던 말이었다.</p>
<p>이번에 날씨가 너무 좋아 점심시간에 책보러 카페로, 작은 공원(?)으로 다니며 읽었는데, 이번엔 또 너무 재미있는 거다. </p>
<p>책은 세 챕터로 나뉘는데,</p>
<ol>
<li>‘지금 여기’를 말하는 사회물리학의 세계</li>
<li>복잡한 세상을 꿰뚫어 보는 통계물리학의 아름다움 </li>
<li>물리학자는 세상물정을 모른다고?</li>
</ol>
<p>두번째 챕터부터 신나게 읽었던 것 같다.</p>
<p>작은 호기심을 증명해내고야 마는 집념.<br>이전에 읽었던 책 ‘아이의 사생활’에 비해 근거로 충만하고 같이 실험했던 사람들의 이름도 꼬박꼬박 넣어주는 친절함.<br>은근 코드가 맞는 개그감.<br>최대한 이해하기 쉽게 설명하는 물리 개념.<br>그리고 과학자로서의 열정과 자부심을 드러내는 지점에선 일부 공감과 반성을 하곤 했었다. </p>
<p>글을 굉장히 잘 쓰신다.<br>요즘 나는 기술책만 너무 많이 보다 눈높이가 꽤 낮아진 관계로…<br>문학을 즐기는 분들이 보기엔 어떨지 모르겠다.<br>하지만 (과연 이게 칭찬이 될 지는 모르겠지만) 이공계 중에선 수준급이다! </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/09/08/ambiguous-ampersands/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/08/ambiguous-ampersands/" class="post-title-link" itemprop="url">모호한 앰퍼샌드(&, ampersand)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-08 00:46:22" itemprop="dateCreated datePublished" datetime="2017-09-08T00:46:22+09:00">2017-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/09/08/ambiguous-ampersands/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/08/ambiguous-ampersands/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Update: ‘<a target="_blank" rel="noopener" href="https://mathiasbynens.be/notes/ambiguous-ampersands">모호한 앰퍼샌드</a>‘ 원작자에게 허락을 구해 해당 글의 번역본을 추가함. </p>
<hr>
<p>개발하면서 누구나 한번쯤은 궁금해하지만, 아무도 정확히 알려주지 않는 모호한 앰퍼샌드에 대해 얕게 한번 파보았습니다.</p>
<h2 id="현상"><a href="#현상" class="headerlink" title="현상"></a>현상</h2><p>공고 관리자 페이지에서 reg_mem_type이라는 변수를 검색할 수 있는 옵션을 추가했더니, 페이징 영역을 클릭하면 계속 오류가 발생했다.</p>
<p>®이라는 특수문자가 전송되는 것을 보고 페이징쪽 소스를 보니</p>
<p>소스보기로는 이상이 없어보이나 개발자도구로는 ®가 찍히는 것을 확인.</p>
<h2 id="원인"><a href="#원인" class="headerlink" title="원인"></a>원인</h2><p>일부 html entity는 세미콜론이 없어도 전환이 가능하다는 것을 알게 됐다.</p>
<p>예를 들어, </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;a href=&quot;test?test=test&amp;reg=aa&amp;region=bb&amp;reg_ion=cc&quot;&gt;</span><br><span class="line">    test?test=test&amp;reg=aa&amp;region=bb&amp;reg_ion=cc</span><br><span class="line">&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>와 같은 태그는 화면에는</p>
<p><code>test?test=test®=aa®ion=bb®_ion=cc</code></p>
<p>처럼 보이고, 개발자 도구에서 보면</p>
<p><code>test?test=test&amp;reg=aa&amp;region=bb®_ion=cc</code></p>
<p>처럼 보인다.</p>
<p>이는 화면에 보여줄 때는 &amp;reg가 세미콜론이 없어도 마크로 변환해줄 수 있기 때문이며,</p>
<p>이게 attribute의 값으로 들어갈 때는 변환이 되지 않는다.</p>
<p>다만, &amp;reg_ion 처럼 &amp;reg 다음에 특수문자나 공백 등이 올 경우, 이는 ®마크로 변환이 된다.</p>
<h2 id="세미콜론-없어도-변환해주는-경우"><a href="#세미콜론-없어도-변환해주는-경우" class="headerlink" title="세미콜론 없어도 변환해주는 경우"></a>세미콜론 없어도 변환해주는 경우</h2><p>세미콜론이 없어도 마크로 변환해주는 경우가 어디에 정의되어 있는지를 잘 모르겠다.</p>
<p>이런 현상에 관한 질문을 좀 찾아봤다.</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15532252/why-is-reg-being-rendered-as-without-the-bounding-semicolon">https://stackoverflow.com/questions/15532252/why-is-reg-being-rendered-as-without-the-bounding-semicolon</a></p>
<p>여기서는 <a target="_blank" rel="noopener" href="https://html.spec.whatwg.org/multipage/named-characters.html#named-character-references">named-character-references</a>를 예로 들며, 세미콜론이 없어도 되는 문자 참조를 아래와 같이 정의한다.</p>
<blockquote>
<p>AElig, AMP, Aacute, Acirc, Agrave, Aring, Atilde, Auml, COPY, Ccedil, ETH, Eacute, Ecirc, Egrave, Euml, GT, Iacute, Icirc, Igrave, Iuml, LT, Ntilde, Oacute, Ocirc, Ograve, Oslash, Otilde, Ouml, QUOT, REG, THORN, Uacute, Ucirc, Ugrave, Uuml, Yacute, aacute, acirc, acute, aelig, agrave, amp, aring, atilde, auml, brvbar, ccedil, cedil, cent, copy, curren, deg, divide, eacute, ecirc, egrave, eth, euml, frac12, frac14, frac34, gt, iacute, icirc, iexcl, igrave, iquest, iuml, laquo, lt, macr, micro, middot, nbsp, not, ntilde, oacute, ocirc, ograve, ordf, ordm, oslash, otilde, ouml, para, plusmn, pound, quot, raquo, reg, sect, shy, sup1, sup2, sup3, szlig, thorn, times, uacute, ucirc, ugrave, uml, uuml, yacute, yen, yuml</p>
</blockquote>
<p>그런데 위에 언급한 named-character-references에서의 리스트와는 꽤 다르다.</p>
<p>예를 들어, 이 references에서 정의된 ycirc는 &amp;ycirc_라고 해도 attribute에서 변환되지 않는다.</p>
<p>아직 브라우저가 구현을 안 한 것인지, HTML4 버전 때 정의된 것 만 세미콜론으로 안 끝나도 되는지는 잘 모르겠다.</p>
<p>아직 정확한 근거를 못 찾았는데, 누가 좀 알려줬으면 좋겠다.</p>
<p>정 궁금하면 더 찾아봤을텐데, 정확한 리스트를 안다고 달라질 게 없기 때문에 해결책으로 넘어간다.</p>
<h2 id="해결-in-PHP"><a href="#해결-in-PHP" class="headerlink" title="해결 in PHP"></a>해결 in PHP</h2><p>페이징 링크에 들어가는 부분</p>
<p>$queryString &#x3D; ‘&amp;’ . http_build_query($params, ‘’, ‘&amp;’) ;</p>
<p>와 같은 소스를</p>
<p>$queryString &#x3D; ‘&amp;’ . http_build_query($params, ‘’, ‘&amp;amp;’) ;</p>
<p>이와 같이 &amp;만을 escape 처리함.</p>
<h1 id="모호한-앰퍼샌드"><a href="#모호한-앰퍼샌드" class="headerlink" title="모호한 앰퍼샌드"></a>모호한 앰퍼샌드</h1><p>아래는 이 현상을 제대로 이해하기 위해 모호한 앰퍼샌드에 관한 글을 번역한 것이다.</p>
<p>원문 : <a target="_blank" rel="noopener" href="https://mathiasbynens.be/notes/ambiguous-ampersands">https://mathiasbynens.be/notes/ambiguous-ampersands</a></p>
<p>각 용어는 아래와 같이 번역함(<a target="_blank" rel="noopener" href="http://www.clearboth.org/">clearboth</a>에서 번역한 문서 참고해서 맞춤)</p>
<ul>
<li>Ambiguous : 모호한<ul>
<li>모호한이라는 뜻으로 주로 쓰이는 것 같고, 여러 뜻으로 해석할 수 있는..이라는 의미도 될 수 있음</li>
</ul>
</li>
<li>named character : 명명된 문자</li>
</ul>
<h2 id="Character-references-in-HTML"><a href="#Character-references-in-HTML" class="headerlink" title="Character references in HTML"></a>Character references in HTML</h2><p>HTML안에서의 문자 참조</p>
<blockquote>
<p>Before explaining what ambiguous ampersands are, let’s talk about character references.</p>
</blockquote>
<p>모호한 앰퍼샌드가 뭔지 설명하기 전에 문자 참조에 대해 이야기 해보자</p>
<blockquote>
<p>There are different kinds of character references. The HTML 4.01 spec divides them in two groups, but really there are three:</p>
</blockquote>
<p>문자 참조에는 여러가지 종류가 있다. HTML4.01 스펙에는 두 개의 그룹으로 나누었지만, 사실 세가지가 있다.</p>
<ul>
<li>decimal numeric character references, e.g. &amp;#169;<ul>
<li>정수 문자 참조</li>
</ul>
</li>
<li>hexadecimal numeric character references, e.g. &amp;#xA9;<ul>
<li>16진수 문자 참조</li>
</ul>
</li>
<li>named character references, e.g. &amp;copy;<ul>
<li>명명된 문자 참조</li>
</ul>
</li>
</ul>
<blockquote>
<p>Character references should always start with a U+0026 AMPERSAND character (&amp;) and end with a U+003B SEMICOLON character (;).</p>
</blockquote>
<p>문자 참조는 &amp;로 시작하고 ;로 끝나야 한다.</p>
<blockquote>
<p>Fun fact: the list of named character references in the HTML spec includes &amp;amp; and &amp;AMP;, but also &amp;amp and &amp;AMP (without the trailing semicolon). The same goes for a few other entities. This is done for backwards-compatibility reasons. This way, the spec dictates that foo &amp;amp bar should be rendered as “foo &amp; bar”, even though it’s invalid markup (because of the missing trailing semicolon). More on this in a minute…</p>
</blockquote>
<p>재밌는 사실은: HTML 스펙에서 명명된 문자 참조는 &amp;amp;와 &amp;AMP;를 포함하는데, 세미콜론(;)이 뒤에 붙지 않은 &amp;amp와 &amp;AMP도 있다는 것이다. 다른 일부 엔티티도 마찬가지이다. 이건 하위 호환성을 때문에 이렇게 됐다. 이 방식으로, (세미콜론이 빠져있으면) 유효하지 않은 마크업임에도 불구하고, 스펙에선 “foo &amp;amp bar”를 “foo &amp; bar”로 랜더할 수 있게 지시하고 있다. 조금 이따가 다시 다루겠다.</p>
<blockquote>
<p>In this post, we’ll take a closer look at what happens if there’s an unencoded ampersand that’s not part of a character reference in your HTML code. Is it valid? Is it invalid? And what do “ambiguous ampersands” have to do with all this?</p>
</blockquote>
<p>이 포스트에선, HTML안에 지정된 문자 참조의 일부가 아니면서 인코드도 안 된 앰퍼샌드가 있을 때 어떤 일이 벌어지는 지 좀 더 자세히 살펴볼 것이다. 그게 유효한 문법인가? 아니면 유효하지 않은가? 모호한 앰퍼샌드는 이 모든 것과 어떤 관계가 있는가?</p>
<h2 id="Unencoded-ampersands-in-HTML4"><a href="#Unencoded-ampersands-in-HTML4" class="headerlink" title="Unencoded ampersands in HTML4"></a>Unencoded ampersands in HTML4</h2><p>인코딩되지 않은 앰퍼샌드</p>
<blockquote>
<p>The HTML 4.01 spec mentions this:</p>
</blockquote>
<p>HTML 4.01 스펙에서 이를 언급하기를:</p>
<blockquote>
<p>The URI that is constructed when a form is submitted may be used as an anchor-style link (e.g., the href attribute for the &lt;a&gt; element). Unfortunately, the use of the &amp; character to separate form fields interacts with its use in SGML attribute values to delimit character entity references. For example, to use the URI http&amp;colon;&#x2F;&#x2F;host&#x2F;?x&#x3D;1&amp;y&#x3D;2 as a linking URI, it must be written as &lt;a href&#x3D;”http&amp;colon;&#x2F;&#x2F;host&#x2F;?x&#x3D;1&amp;#38;y&#x3D;2”&gt; or &lt;a href&#x3D;”http&amp;colon;&#x2F;&#x2F;host&#x2F;?x&#x3D;1&amp;amp;y&#x3D;2”&gt;.</p>
</blockquote>
<p>Form 전송 시 만들어지는 URI는 anchor 스타일 링크(예를 들어 a 엘리먼트의 href attribute)를 사용하게 된다. 불행히도, 폼 필드를 구분지으려고 &amp;를 사용하는 것은, 문자 엔티티 참조를 위한 SGML(역주: HTML, XML등의 부모뻘 되는 언어) attribute 안에서 사용하는 것과 상호작용을 하게된다. 예를 들어, 링크를 위한 http&amp;colon;&#x2F;&#x2F;host&#x2F;?x&#x3D;1&amp;y&#x3D;2 이라는 URI는, 반드시 &lt;a href&#x3D;”http&amp;colon;&#x2F;&#x2F;host&#x2F;?x&#x3D;1&amp;#38;y&#x3D;2”&gt;  혹은 &lt;a href&#x3D;”http&amp;colon;&#x2F;&#x2F;host&#x2F;?x&#x3D;1&amp;amp;y&#x3D;2”&gt; 으로 쓰여야 한다.</p>
<blockquote>
<p>This means you can’t just copy-paste URLs into your HTML4 document if you want it to be valid — you’ll have to encode any ampersand characters first.</p>
</blockquote>
<p>이 말은 당신이 HTML4 문서에 URL을 단순히 복사-붙여넣기를 해서만은 유효하진 않을 거라는 의미이다 - 앰퍼샌드를 인코딩 해야할 거다.</p>
<h2 id="Ambiguous-ampersands-in-HTML5"><a href="#Ambiguous-ampersands-in-HTML5" class="headerlink" title="Ambiguous ampersands in HTML5"></a>Ambiguous ampersands in HTML5</h2><p>HTML5에서의 모호한 앰퍼샌드</p>
<blockquote>
<p>In HTML5, the first definition for ambiguous ampersands was added:</p>
</blockquote>
<p>HTML5에서 모호한 ampersand에 대한 정의가 처음으로 추가됐다.</p>
<blockquote>
<p>An ambiguous ampersand is a U+0026 AMPERSAND (&amp;) character that is not the last character in the file, that is not followed by a space character, that is not followed by a start tag that has not been omitted, and that is not followed by another U+0026 AMPERSAND (&amp;) character.</p>
</blockquote>
<p>모호한 앰퍼샌드는 파일의 마지막 문자가 아니며, 공백 문자가 뒤이어 나오지 않고, 생략되지 않은 시작 태그가 뒤에 오지 않고 다른 앰퍼샌드 문자가 뒤따르지 않는다.</p>
<blockquote>
<p>Ambiguous ampersands are non-conforming (invalid); unambiguous ampersands are generally conforming (valid). (As mentioned before: ampersands that are part of a named character reference that doesn’t end with a semicolon are unambiguous, but still invalid.)</p>
</blockquote>
<p>모호한 앰퍼샌드는 …(역주: 번역하기 어려워 생략)…(이전에 언급한 것처럼: 세미콜론으로 끝나지 않는 명명된 문자 참조의 일부로써 앰퍼샌드는 모호하진 않지만, 아직 유효하진 않다.</p>
<blockquote>
<p>In other words, if an unencoded ampersand is followed by EOF, a space character, &lt;, or &amp;, it’s perfectly valid.</p>
</blockquote>
<p>다시 말해, 인코드 안 된 앰퍼샌드 뒤로 EOF, 공백문자, &lt;, &amp;가 있다면 이건 완전히 유효하다.</p>
<blockquote>
<p>According to this definition, the ampersands in this example are all ambiguous, and thus invalid:</p>
</blockquote>
<p>이 정의에 의하면, 아래 예시에서 모든 앰퍼샌드는 모호하고, 그러므로 유효하지 않다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;a href=&quot;https://example.com/?x=1&amp;y=2&quot;;&gt;foo&lt;/a&gt;</span><br><span class="line">&amp;123</span><br><span class="line">&amp;abc</span><br><span class="line">foo &amp;0 bar</span><br><span class="line">foo &amp;lolwat bar</span><br></pre></td></tr></table></figure>

<blockquote>
<p>However, this is valid HTML:</p>
</blockquote>
<p>그러나, 이건 또 유효한 HTML이다</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">foo &amp; bar</span><br><span class="line">foo&amp;&lt;i&gt;bar&lt;/i&gt;</span><br><span class="line">foo&amp;&amp;&amp; bar</span><br></pre></td></tr></table></figure>


<blockquote>
<p>Later the spec was changed, and the HTML spec now defines ambiguous ampersands as follows:</p>
</blockquote>
<p>나중에 스펙은 수정되고 현재 HTML 스펙은 아래와 같이 정의되어 있다.</p>
<blockquote>
<p>An ambiguous ampersand is a U+0026 AMPERSAND character (&amp;) that is followed by one or more characters in the range U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9), U+0061 LATIN SMALL LETTER A to U+007A LATIN SMALL LETTER Z, and U+0041 LATIN CAPITAL LETTER A to U+005A LATIN CAPITAL LETTER Z, followed by a U+003B SEMICOLON character (;), where these characters do not match any of the names given in the named character references section.</p>
</blockquote>
<p>모호한 앰퍼샌드는 하나 이상의 0~9 숫자, 대&#x2F;소문자 라틴 문자와 세미콜론으로 이어지는 엠퍼샌드를 의미하고, 이 문자들은 명명된 문자 참조 영역에 있는 이름에 매칭되지 않는다.</p>
<blockquote>
<p>This definition is probably easier to grok as a regular expression: a string contains an ambiguous ampersand if it matches &#x2F;&amp;([0-9a-zA-Z]+;)&#x2F; and if the first back-reference ($1) is not a known character reference.</p>
</blockquote>
<p>이 정의는 아마 정규식으로 더 이해하기 쉬울 것 같다. 앰퍼샌드가 포함된 문자열이 &#x2F;&amp;([0-9a-zA-Z]+;)&#x2F; 에 매치되고, back-reference 된 값(역주: 정규식에서 괄호안에 매칭되는 값)이 알려진 문자 참조가 아니어야 한다.</p>
<blockquote>
<p>The ampersands in this example are all ambiguous, and thus invalid:</p>
</blockquote>
<p>아래 앰퍼샌드는 모두 모호하다. 따라서 유효한 문법이 아니다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp;123;</span><br><span class="line">&amp;abc;</span><br><span class="line">foo &amp;0; bar</span><br><span class="line">foo &amp;lolwat; bar</span><br></pre></td></tr></table></figure>

<blockquote>
<p>However, all these are unambiguous:</p>
</blockquote>
<p>그러나 아래는 모두 명확하다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">foo &amp; bar</span><br><span class="line">foo&amp;&lt;i&gt;bar&lt;/i&gt;</span><br><span class="line">foo&amp;&amp;&amp; bar</span><br></pre></td></tr></table></figure>
<blockquote>
<p>…even the ones that were invalid as per the old definition, are now valid:</p>
</blockquote>
<p>…예전의 정의로는 유효하진 않지만, 현재 유효한 것은:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;a href=&quot;http://example.com/?x=1&amp;y=2&quot;;&gt;foo&lt;/a&gt;</span><br><span class="line">&amp;123</span><br><span class="line">&amp;abc</span><br><span class="line">foo &amp;0 bar</span><br><span class="line">foo &amp;lolwat bar</span><br></pre></td></tr></table></figure>

<blockquote>
<p>With the new definition, this is perfectly valid HTML — even though no HTML validator I know of recognizes this yet.</p>
</blockquote>
<p>새로운 정의에 의해서는, 완벽하게 유효한 HTML이다 - HTML 유효성 검사기가 아직 이걸 모른다 하더라도 말이다.</p>
<blockquote>
<p>So we’ve established that not all ampersand characters require escaping in HTML. Semi-related fun fact: In most cases, there’s no need to escape the &gt; character either. It has no special meaning (and is thus unambiguous) unless it’s part of a tag or an unquoted attribute value. For example, &lt;p&gt;foo &gt; bar&lt;&#x2F;p&gt; is perfectly valid and reliable HTML.</p>
</blockquote>
<p>이제 우리는 HTML안에서 모든 앰퍼샌드가 escape 될 필요는 없다는 게 확실해졌다. 크게 관련은 없지만 재밌는 사실은: &gt; 문자도 escape할 필요가 없다는 사실이다. 따옴표 없는 attribute값이나 태그의 일부가 아닌 이상 특수한 의미가 있지는 않다(모호하지 않음). 예를 들어, &lt;p&gt;foo &gt; bar&lt;&#x2F;p&gt;는 완전히 유효하며 믿을만 한 HTML이다.</p>
<h2 id="The-pedantic-nitty-gritty"><a href="#The-pedantic-nitty-gritty" class="headerlink" title="The pedantic nitty-gritty"></a>The pedantic nitty-gritty</h2><p>학술적인 핵심</p>
<blockquote>
<p>As mentioned before, some named character references work without a trailing semicolon (e.g. &amp;amp) even though it’s invalid markup. What complicates things even more is that these entities are handled differently in attribute values.</p>
</blockquote>
<p>말했지만, 일부 명명된 문자 참조는 세미콜론이 뒤에 붙지 않아도(그게 유효하지 않은 마크업 문법이라도) 동작한다. 이걸 더 복잡하게 만드는 건, 이 엔티티들이 attribute 값에서는 다르게 작동한다는 사실이다.</p>
<blockquote>
<p>If the character reference is being consumed as part of an attribute, and the last character matched is not a U+003B SEMICOLON character (;), and the next character is either a U+003D EQUALS SIGN character (&#x3D;) or an alphanumeric ASCII character, then, for historical reasons, all the characters that were matched after the U+0026 AMPERSAND character (&amp;) must be unconsumed, and nothing is returned. However, if this next character is in fact a U+003D EQUALS SIGN character (&#x3D;), then this is a parse error, because some legacy user agents will misinterpret the markup in those cases.</p>
</blockquote>
<p>만약 문자 참조가 attribute안에서 사용되고 세미콜론으로 끝나지 않으며 다음 글자가 &#x3D;나 알파벳, 숫자일 경우, 관행적으로, &amp; 이후 매칭되는 모든 문자들은 처리되지 않고 아무것도 리턴되지 않는다. 그러나 이 ‘다음 문자’가 &#x3D;이라면, parse error가 발생하는데, 오래된 user agent가 오역할 수 있기 때문이다.</p>
<blockquote>
<p>Take this (obviously invalid) HTML, for example:</p>
</blockquote>
<p>예를 들어, 명백히 유효하지 않은 다음 HTML을 보라</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;p title=&quot;foo&amp;ampbar&quot;&gt;</span><br><span class="line">foo&amp;ampbar</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Try it out in your browser. You’ll see that the paragraph’s text content displays as “foo&amp;bar”, while the titleattribute value is displayed as “foo&amp;ampbar”.</p>
</blockquote>
<p>네 브라우저에서 시도해봐라. 내용은 “foo&amp;bar”라고 나오지만, title attribute 값은 foo&amp;ampbar로 나올 것이다.</p>
<h2 id="Mothereffing-ambiguous-ampersands"><a href="#Mothereffing-ambiguous-ampersands" class="headerlink" title="Mothereffing ambiguous ampersands"></a>Mothereffing ambiguous ampersands</h2><p>형편없는 모호한 앰퍼샌드</p>
<blockquote>
<p>To summarize: there’s a difference between unencoded ampersands (sometimes valid), ambiguous ampersands (always invalid) and encoded ampersands (always valid). An unencoded ampersand is not always an ambiguous ampersand. An unambiguous ampersand can still be invalid.</p>
</blockquote>
<p>요약하자면: 인코딩 안 된 앰퍼샌드(가끔 유효한), 모호한 앰퍼샌드(언제나 유효하지 않은), 그리고 인코딩된 앰퍼샌드(언제나 유효한) 사이에는 차이점이 있다. 인코딩이 안 된 앰퍼샌드가 항상 모호한 앰퍼샌드인 건 아니다. 모호하지 않은 앰퍼샌드도 여전히 유효하지 않을 수 있다.</p>
<blockquote>
<p>In my opinion, this is all a bit confusing. But it doesn’t have to be! When in doubt, just encode your effin’ ampersands.</p>
</blockquote>
<p>내 생각에, 이것들은 좀 헷갈린다. 하지만 그럴 필요는 없다! 의심스러우면, 망할 앰퍼샌드를 인코딩해라.</p>
<blockquote>
<p>That said, if you want to find out if an HTML snippet contains any ambiguous ampersands or character references that don’t end with a semicolon (both of which are invalid), feel free to use mothereff.in&#x2F;ampersands.</p>
</blockquote>
<p>즉, HTML 스니펫에 모호한 앰퍼샌드나 세미콜론 (세미콜론으로 끝나지 않는 문자 참조)이 모두 포함되어 있는지 알아 보려면 (둘 다 유효하지 않음) mothereff.in&#x2F;ampersands를 자유롭게 사용하기 바란다.</p>
<p><img src="https://mathiasbynens.be/_img/ambiguous-ampersands/tool@2x.png" alt="Ambiguous ampersand checker for HTML"></p>
<blockquote>
<p>Note that this is not a complete HTML validator; it will only look for ambiguous ampersands and semicolon-free character references. (Hopefully, bug #841 will be fixed soon, so we can just rely on validator.nu instead.)<br>Understanding what ambiguous ampersands are and how they work is especially important for library authors wishing to deal with HTML entities. Not accounting for these edge cases might result in XSS or other security vulnerabilities in your code.</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/09/04/kids-privacy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/04/kids-privacy/" class="post-title-link" itemprop="url">독후감 - 아이의 자존감</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-04 00:03:46" itemprop="dateCreated datePublished" datetime="2017-09-04T00:03:46+09:00">2017-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-08-29 04:46:11" itemprop="dateModified" datetime="2018-08-29T04:46:11+09:00">2018-08-29</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/09/04/kids-privacy/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/04/kids-privacy/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://image.kyobobook.co.kr/images/book/large/078/l9788952762078.jpg" alt="아이의 자존감"></p>
<p>책 자체가 잘 쓰였다고는 생각하지는 않다만,<br>부모로서 스스로 돌아보기에 괜찮은 기회일 수도 있다.</p>
<p>육아에 대해 큰 고민없이 살거나 고민은 많은데 부모 스스로 감정 조절이 안되거나 지금 내가 하는 게 맞나 싶은 사람이라면 도움이 될 수도 있겠다.</p>
<p>3장의 목차가 저 모양이라 마음엔 안 들지만<br>(오래 전 책이라 줄을 잘못 섰기도 섰거니와)</p>
<p>저 부분만 잘 넘어가면 이래저래 생각할 거리는 많다.<br>(3장은 낯 간지러워서 도저히 못 읽겠다!)</p>
<p>한문장 한문장 읽으면서 내 행동을 돌아보는 용도로 가볍게 읽고 넘어가면 좋을 것 같다.</p>
<p>읽다보면 이 자존감을 세우는 일은 아이에만 필요한 게 아니다. 내 주위 사람들, 지나간 동료들도 많이 생각이 났다.</p>
<p>저기 자존감이 높은 대표적인 인물로 꼽힌 안철수가 그…(?) 과정을 거치며 얼마나 자존감이 낮아졌는가, 그 아이가 얼마나 삐뚤어졌나 생각해보자.</p>
<p>아쉬운 건,<br>이런 저런 연구 결과나 박사 이름을 언급하지만,<br>행동 지침을 도출하게 된 직접적인 근거는 또 아니어서,<br>이렇게 해라 저렇게 해라 하는 게 진짜 근거가 있는지 아닌지 알게 뭐냐는…<br>시간 없는데 할 말이 많은 사람처럼 문장도 좀 산만한 것 같고.<br>잔소리 많은 아는 형님이 조금 취했다고 생각하자.</p>
<p>하지만 그 형님이 말하는 아이의 사생활도 한번 들어볼 생각.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/9/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/11/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">youngiggy</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  




  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"youngiggy-github-io","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
