<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon_package_v0.16/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_package_v0.16/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_package_v0.16/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon_package_v0.16/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/favicon_package_v0.16/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"haah.kr","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="blog">
<meta property="og:title" content="ha-ah">
<meta property="og:url" content="https://haah.kr/page/10/">
<meta property="og:site_name" content="ha-ah">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="youngiggy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://haah.kr/page/10/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/10/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ha-ah</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=354302543"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":354302543,"only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="ha-ah" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ha-ah</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">로그, 게으른 로그</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">youngiggy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:youngiggy@gmail.com" title="E-Mail → mailto:youngiggy@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/profile.php?id=100001259884599" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100001259884599" rel="noopener me" target="_blank"><i class="fab fa-facebook fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.instagram.com/jooyoungiggy" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;jooyoungiggy" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/25/phttp-06/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/25/phttp-06/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 06 - Request 분리, autoload, PHPUnit</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-25 07:27:32" itemprop="dateCreated datePublished" datetime="2017-10-25T07:27:32+09:00">2017-10-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/25/phttp-06/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/25/phttp-06/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h1 id="Request-분리"><a href="#Request-분리" class="headerlink" title="Request 분리"></a>Request 분리</h1><h2 id="autoload"><a href="#autoload" class="headerlink" title="autoload"></a>autoload</h2><p>우선 클라이언트로부터 받은 request 메시를 분석하는 클래스부터 만들기로 했다.</p>
<p>Project root에 <code>libs</code> 디렉토리를 만들어 놓고, 여기에 <code>Request</code>라는 클래스를 하나 만들어야겠다.</p>
<p>그럼 autoload도 적용해야 하니 composer를 이용해야겠다.</p>
<p>대충 <code>composer init</code>해서 파일을 만들고, <code>libs</code> 디렉토리를 psr-4 기반으로 autoload 하도록 설정해주자. </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;youngiggy/phttp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;project&quot;</span>,</span><br><span class="line">    <span class="string">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;authors&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;youngiggy&quot;</span>,</span><br><span class="line">            <span class="string">&quot;email&quot;</span>: <span class="string">&quot;youngiggy@gmail.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;require&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">&quot;autoload&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;psr-4&quot;</span>: &#123; <span class="string">&quot;&quot;</span>: <span class="string">&quot;libs/&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이제 <code>libs</code> 디렉토리 아래 <code>Request</code> 클래스를 하나 만들고</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/phttp-06/01_composer_init.png" alt="after composer init"></p>
<p><code>server.php</code> 상단에 autoload용 코드를 심고, Request를 로드해보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//todo 지울 것 s</span></span><br><span class="line"><span class="variable">$req</span> = <span class="keyword">new</span> <span class="title class_">Request</span>();</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$req</span> <span class="keyword">instanceof</span> Request);</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line"><span class="comment">//todo 지울 것 e</span></span><br><span class="line">  </span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// ...생략...</span></span><br></pre></td></tr></table></figure>

<p>일단 autoload는 잘 동작한다. OK.</p>
<h2 id="server-php"><a href="#server-php" class="headerlink" title="server.php"></a>server.php</h2><p>테스트용으로 넣었던 쓸데 없는 코드는 이제 지우고,</p>
<p><code>Request</code> 클래스에 사용자 입력을 분석하고 응답을 만들어내는 역할을 맡기려고 한다.</p>
<p>서버 소스는 아래와 같이 바뀌었다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line">    </span><br><span class="line"><span class="title function_ invoke__">defined</span>(<span class="string">&#x27;PROJECT_ROOT&#x27;</span>) <span class="keyword">or</span> <span class="title function_ invoke__">define</span>(<span class="string">&#x27;PROJECT_ROOT&#x27;</span>, <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span>);</span><br><span class="line">    </span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="variable">$clientSentData</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="number">1024</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$response</span> = (<span class="keyword">new</span> <span class="title class_">Request</span>(<span class="variable">$clientSentData</span>))-&gt;<span class="title function_ invoke__">getResponse</span>();</span><br><span class="line">    </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이전 소스에서 <code>index.html</code>을 읽기 위해 아래와 같이 상대 위치로 하드코딩해서 썼었다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...생략...</span></span><br><span class="line"><span class="variable">$filename</span> = <span class="string">&#x27;../public/index.html&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (!(<span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>))) &#123;</span><br><span class="line"><span class="comment">//...생략...</span></span><br></pre></td></tr></table></figure>

<p>처리 로직이 서버 소스를 떠나면 <code>index.html</code> 파일을 여는 fopen을 어디서 처리할 지 아직 확신이 없다. 계속 바뀔지 모른다.</p>
<p>그래서 프로젝트의 최상위 경로를 <code>PROJECT_ROOT</code>라는 상수로 지정했다.</p>
<p>그리고 주요 처리 로직을 들어내고 <code>Request</code> 클래스에 클라이언트가 보낸 문자열을 전달하고,</p>
<p><code>getResponse()</code> 메소드로 받은 문자열을 그대로 클라이언트에 전달한다.</p>
<p>이제 당분간 이쪽 소스를 건드릴 일은 없어 보인다.</p>
<h2 id="Request-php"><a href="#Request-php" class="headerlink" title="Request.php"></a>Request.php</h2><p>이 클래스를 사용하는 곳(server.php)을 보면 <code>Request</code> 클래스의 역할은 크게 두가지다.</p>
<ol>
<li>클라이언트가 보낸 문자열을 생성자로 받는 것</li>
<li><code>getResponse()</code> 메소드로 처리 결과를 리턴하는 것</li>
</ol>
<p><code>server.php</code>의 소스를 가능한 건드리지 않고 조심히 들고와보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$requestMessage</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$requestMessage</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//하지만 아직 쓰진 않지</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;requestMessage = <span class="variable">$requestMessage</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResponse</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = PROJECT_ROOT . <span class="string">&#x27;/public/index.html&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;HTTP/1.0 404 파일 없음&#x27;</span> . PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$responseBody</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>));</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;Content-Type: text/html&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="variable">$responseBody</span> . PHP_EOL;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>거의 동일하다.</p>
<p>어려울 게 없으니 서버 실행!</p>
<h2 id="테스트"><a href="#테스트" class="headerlink" title="테스트"></a>테스트</h2><p>이전의 파일 하나짜리 서버와 동일하게 동작한다.</p>
<p>잘 돌아는 가는데 어쩐지 마음이 헛헛하다.<br>(가을인가)</p>
<p>계속 이렇게 테스트를 해야하나?</p>
<p>매번 뭔가 수정하고 <code>php ./app/server.php</code>를 다시 실행해야 하나?</p>
<p>이제 개발 시작할 분석 로직은 그냥 스트링을 던져주고 결과만 잘 나오면 되는데.</p>
<p>소파에 반쯤 누워 맥주 한잔 들이키며 이 막장 드라마를 구경하는 중급 개발자라면 ‘유닛 테스트를 걸라고, 멍청아’라고 소리칠 것만 같다.</p>
<p>넣어주지 뭐.</p>
<h2 id="PHPUnit"><a href="#PHPUnit" class="headerlink" title="PHPUnit"></a>PHPUnit</h2><p>PHPUnit을 가져와야 할텐데, <code>composer.json</code>에 추가하기 보다는 <code>composer require</code>을 사용하기로 한다.</p>
<p>콘솔을 열고 </p>
<p><code>composer require --dev phpunit/phpunit ^6.4</code></p>
<ul>
<li>“개발에서 쓰려고 하는데 대충 6.4 정도면 될 것 같아요”</li>
</ul>
<p>최신 버전이 6.4라서 명시했고, 7.0 전까지는 써도 별 탈 없을 것이다.  </p>
<p>업데이트가 완료되면 PHPStorm에 실행 환경을 설정한다.</p>
<p>테스트 범위 설정이나 그룹화를 위해 XML로 설정하기로 한다.</p>
<p>프로젝트 root에 <code>phpunit.xml</code> 파일을 만들고 아래와 같이 입력.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">phpunit</span> <span class="attr">bootstrap</span>=<span class="string">&quot;vendor/autoload.php&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testsuites</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">testsuite</span> <span class="attr">name</span>=<span class="string">&quot;Request&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>tests<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">testsuite</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">testsuites</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">phpunit</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>테스트를 돌리기 전 특별히 bootstrap할 게 없으므로 <code>vendor/autoload.php</code>를 bootstrap에 명시했고,</p>
<p>testsuite 명은 나중에 바뀌겠지만 일단 대충 넣고,</p>
<p><code>tests</code>라는 디렉토리에 있는 Test.php로 끝나는 파일(예: parseTest.php)을 모두 검사하도록 했다.</p>
<h2 id="PHPUnit-with-PHPStorm"><a href="#PHPUnit-with-PHPStorm" class="headerlink" title="PHPUnit with PHPStorm"></a>PHPUnit with PHPStorm</h2><p>다른 에디터를 쓰는 분들은 다른 각자 알아서 찾아보면 될 것이고, 여기서는 간단히 PHPStorm에서 설정하는 법만 적어본다.</p>
<p><code>Run | Edit Configurations</code> 메뉴에서 <code>+</code> 버튼을 눌러 <code>PHPUnit</code> 선택.</p>
<p><img src="/images/phttp-06/run_edit_phpunit.png" alt="Run &gt; Edit Configurations"></p>
<p><code>Test Runner &gt; Test Scope</code>을 &#96;Definded in the configuration file’을 선택한다.</p>
<p>바로 아랫줄 제일 오른쪽에 보이는 설정 버튼을 누르면 <code>Test Frameworks</code> 설정 창이 나온다.<br>(만약 처음 설정&#x2F;실행한다면 창 아래쪽에서 configuration file에 문제가 있으니 수정하라고 <code>Fix</code> 버튼이 보일 수도 있다. 이걸 눌러도 같은 창이 나온다.)</p>
<p><img src="/images/phttp-06/run_edit_phpunit_tf.png" alt="Run &gt; Edit Configurations &gt; Test Frameworks"></p>
<p><code>+</code> 버튼을 눌러 Configuration type을 PHPUnit Local로 추가한 후,</p>
<p>PHPUnit library &gt; Use Composer autoloader 선택하고 Path to script는 <code>…</code> 버튼을 눌러 자신의 <code>vendor/autoload.php</code>을 선택하면 된다.</p>
<p>그 아래 Test Runner 옵션에서는 <code>Default configuration file</code>을 체크하고 앞서 만든 <code>phpunit.xml</code>을 선택한다.</p>
<p>그리고 실행!</p>
<p>테스트를 작성하지 않았으므로 <code>No tests executed!</code> 같은 메시지가 보이면 정상이다.</p>
<p>실행창에서 Toggle auto-test를 눌러 놓으면 뭔가 수정이 될 때마다 테스트가 실행된다.</p>
<p>하지만 개발하다보면, 주석을 넣는다거나 공백을 삽입하는데도 test가 실행되므로 종종 눈엣가시가 된다.</p>
<p>이럴 때는 AutoTest Delay값을 늘려주면 좀 낫다.</p>
<p><img src="/images/phttp-06/set_autotest_delay.png" alt="Run &gt; Set AutoTest Delay"></p>
<p>나중에 테스트가 엄청 많아지면 현재 개발하는 모듈 이외의 클래스도 단위테스트가 돌게 될텐데, 이 때는 <code>phpunit.xml</code>에서 테스트 단위를 나누면 된다. 하지만 예상컨대 이 프로젝트에선 그렇게까지 테스트가 많아질 것 같지 않다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>이제부터는 뭔가 추가&#x2F;수정할 때마다 미리 테스트를 만들고 실패하는 것을 확인하고 이를 만족하는 기능을 개발하게 될 것이다.</p>
<p>현재 추가&#x2F;수정하는 코드가 시스템을 망가뜨리지 않는다는 최소한의 보장을 받을 수 있다.</p>
<p>하지만 서버 코드의 많은 부분이 file이나 directory를 읽어야 하는데, 이런 부분은 unit test 만으로 해결 안될 수 있다.</p>
<p>뭐가 어려운지는 <a target="_blank" rel="noopener" href="http://jwchung.github.io/testing-oh-my">이런</a> 글을 보고 예습을 하는 것도 좋다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><p><a target="_blank" rel="noopener" href="http://www.php-fig.org/psr/psr-4/">http://www.php-fig.org/psr/psr-4/</a><br><a target="_blank" rel="noopener" href="https://getcomposer.org/doc/01-basic-usage.md">https://getcomposer.org/doc/01-basic-usage.md</a><br><a target="_blank" rel="noopener" href="http://xpressengine.github.io/Composer-korean-docs/">http://xpressengine.github.io/Composer-korean-docs/</a><br><a target="_blank" rel="noopener" href="https://getcomposer.org/doc/articles/versions.md#caret-version-range-">https://getcomposer.org/doc/articles/versions.md#caret-version-range-</a><br><a target="_blank" rel="noopener" href="https://phpunit.de/index.html">https://phpunit.de/index.html</a><br><a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/phpstorm/testing-with-phpunit.html">https://www.jetbrains.com/help/phpstorm/testing-with-phpunit.html</a><br><a target="_blank" rel="noopener" href="http://jwchung.github.io/testing-oh-my">http://jwchung.github.io/testing-oh-my</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/21/phttp-05/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/21/phttp-05/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 05 - 아주 간단한 HTTP 서버로 첫 요청과 응답</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-21 10:34:46" itemprop="dateCreated datePublished" datetime="2017-10-21T10:34:46+09:00">2017-10-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/21/phttp-05/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/21/phttp-05/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h2 id="과연-스트리밍이-필요한가"><a href="#과연-스트리밍이-필요한가" class="headerlink" title="과연 스트리밍이 필요한가?"></a>과연 스트리밍이 필요한가?</h2><p>스트리밍 처리를 위해 이리저리 알아보다가 괜찮은 글이 있어 소개한다.</p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/CMCDragonkai/6bfade6431e9ffb7fe88">https://gist.github.com/CMCDragonkai/6bfade6431e9ffb7fe88</a></p>
<ul>
<li>스트리밍을 구현할 때 chunk 데이터를 어떻게 보내고, 이를 어떻게 처리해야 하는지</li>
<li>HTTP 트랜잭션 안의 각 요소(component) 간 buffer는 어떻게 처리되는지</li>
<li>등등</li>
</ul>
<p>잘 나와있다.</p>
<p>예전에 댓글로 <a target="_blank" rel="noopener" href="https://www.sitepoint.com/php-streaming-output-buffering-explained/">아웃 버퍼링에 관한 글</a>도 소개했었는데,</p>
<p>같은 맥락으로 읽어보면 좋다.</p>
<p>내가 만들 서버는 아주 가벼운 HTML 파일과 이미지 정도를 보내주기 때문에 굳이 (chunk로 나눠 보내주는) 스트리밍은 필요없다.</p>
<p>마찬가지로 클라이언트에서도 multi-part chunk 데이터가 들어올 것을 고려할 필요가 없다.</p>
<p>그럼 이제 HTTP 요청을 받아서 HTTP 응답을 반환해주는 최소한의 구성으로 서버를 하나 만들어보겠다.</p>
<h2 id="아주-간단한-HTTP-서버"><a href="#아주-간단한-HTTP-서버" class="headerlink" title="아주 간단한 HTTP 서버"></a>아주 간단한 HTTP 서버</h2><p>이전 시간에 만들었던 서버 소스를 조금 수정해서, 클라이언트가 보낸 내용을 읽고 HTTP 응답 메시지로 리턴한다.</p>
<p>아래는 전체 소스다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="variable">$request</span>= <span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="number">1024</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;Content-Type: text/html&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;you sent :&#x27;</span> . PHP_EOL . <span class="variable">$request</span> . PHP_EOL;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>클라이언트와 연결되면 해당 스트림에서 1024 바이트만큼 읽어온다.</p>
<p>더 많이 보낼 수 있지 않냐고? 물론이다. 그 문제는 그 때 생각하자.</p>
<p>그 다음 HTTP 메시지를 만들어 준다.</p>
<ul>
<li>말했지만, HTTP 메시지는 시작줄, 헤더, 공백, 본문(message body)으로 이뤄졌다.</li>
</ul>
<p>요청할 때는 시작줄에 <code>GET / HTTP/1.1</code>와 같이 메소드, URL, HTTP 버전 순으로 보냈지만 </p>
<p>응답할 때의 시작줄에는 <code>HTTP/1.0 200 OK</code>와 같이 HTTP 버전과 상태 코드 그리고 상태 텍스트를 넣어준다.</p>
<p>여기에 헤더를 추가해줘야 하니 Content-Type을 text&#x2F;html으로 우선 하나 넣어주고</p>
<p>메시지 본문과의 구분을 위해 CRLF를 두 개 추가한다. </p>
<h2 id="첫-HTTP-요청과-응답"><a href="#첫-HTTP-요청과-응답" class="headerlink" title="첫 HTTP 요청과 응답"></a>첫 HTTP 요청과 응답</h2><p>테스트 용으로 만들었던 클라이언트 코드는 이제 버리고,</p>
<p>진짜 HTTP 클라이언트를 사용해보자.</p>
<p>브라우저에서 접속해도 괜찮지만 아직은 HTML 파일을 내려보낼 것이 아니므로</p>
<p><a target="_blank" rel="noopener" href="https://www.getpostman.com/">Postman</a>같은 클라이언트가 테스트하기 편할 것이다.</p>
<p><code>GET</code> 메소드로 <code>127.0.0.1:1337</code>에 접근해보자.</p>
<p><img src="/images/phttp-05/postman01.png" alt="Postman으로 실행한 화면"></p>
<p>(만약 서버에서 적절한 시작줄을 안 보내주면 Postman은 <code>Could not get any response</code>라며 응답이 오지 않은 것으로 간주한다.) </p>
<p>Postman에서 받은 응답 메시지 본문은 아래와 같다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">you sent :</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:1337</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</span><br><span class="line">Postman-Token: df3ef030-2b6f-76c3-30d9-304ebb426a41</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: ko-KR,ko;q=0.8,en-US;q=0.6,en;q=0.4</span><br></pre></td></tr></table></figure>

<p>서버에서 응답 본문 앞에 붙여둔 <code>you sent :</code> 한 주를 제외하면 나머지는 HTTP 클라이언트(여기서는 Postman)가 요청 시 붙여 보낸 것이다.</p>
<p>크롬에서 보내면?</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">you sent :</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:1337</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: ko-KR,ko;q=0.8,en-US;q=0.6,en;q=0.4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>다시 서버 소스를 돌아보자.</p>
<p>지금은 무조건 <code>HTTP/1.0 200 OK</code>라고 응답하게 되어있다.</p>
<p>클라이언트는 HTTP&#x2F;1.1을 지원하기 때문에 이 프로토콜 버전을 기준으로 헤더를 붙여 요청했지만</p>
<p>우리 서버는 ‘난 HTTP&#x2F;1.0까지만 지원하는 서버라서 1.0 기준의 헤더를 보낼 거야’라는 의미로 응답에 <code>HTTP/1.0 200 OK</code>를 리턴한다.</p>
<h2 id="브라우저에서-index-html-확인하기"><a href="#브라우저에서-index-html-확인하기" class="headerlink" title="브라우저에서 index.html 확인하기"></a>브라우저에서 index.html 확인하기</h2><p>저기 저 아주 간단한 서버 소스에선 메시지 본문을 클라이언트가 보낸 데이터를 그대로 돌려줬는데,</p>
<p><code>$response .= &#39;you sent :&#39; . PHP_EOL . $request . PHP_EOL;</code></p>
<p>이제 예시로 만들어 두었던 index.html 파일을 읽어 클라이언트로 보내기로 한다.</p>
<p>드디어 브라우저에서 확인해볼 차례다.</p>
<p>Request를 그대로 돌려주는 서버에서 무조건 index.html을 떨궈주는 서버로 진화해보자. </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 생략</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="comment">//todo 요청(request) 처리 모듈로 분리하기</span></span><br><span class="line">        <span class="variable">$request</span>= <span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="number">1024</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&#x27;../public/index.html&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&#x27;r&#x27;</span>))) &#123;</span><br><span class="line">            <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 404 파일 없음&#x27;</span> . PHP_EOL;</span><br><span class="line">            <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">            <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$responseBody</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>));</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//todo 응답(response) 처리 모듈로 분리하기</span></span><br><span class="line">        <span class="variable">$response</span> = <span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="string">&#x27;Content-Type: text/html&#x27;</span> . PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= PHP_EOL;</span><br><span class="line">        <span class="variable">$response</span> .= <span class="variable">$responseBody</span> . PHP_EOL;</span><br><span class="line">    </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$response</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>));</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>todo가 먼저 눈에 띌 것 같은데,</p>
<p>우리의 아주 간단한 서버가 조금씩 복잡해지기 시작했다(냄새가 난다, 냄새가).</p>
<p>크게 보면 응답을 받아서 뭔가 하는 역할과 응답을 만들어주는 역할이다.</p>
<p>리팩토링은 나중에 하기로 하고, 맥주를 한잔 따르고, 성공을 축하하자.</p>
<p>크롬으로 접속!</p>
<p><img src="/images/phttp-05/index_html.png" alt="index.html 성공"></p>
<p>만약 없는 경로의 파일을 찾으려고 하면 404로 응답해주면 된다.</p>
<p>그 유명한 <code>404 not found</code>다.</p>
<p>그런데 소스를 보면 <code>HTTP/1.0 404 파일 없음</code>이라고 되어있는데 잘못 쓴 게 아니다.</p>
<p>클라이언트에게는 404라는 응답코드가 중요하지 메시지는 중요하지 않다.</p>
<p><code>200 OK</code>나 <code>200 NOT OK</code>나 모두 성공을 의미한다.</p>
<p>(물론 서비스 운영 시에는 이런 짓은 하지 않는다)</p>
<p><img src="/images/phttp-05/index_html_404.png" alt="404 not found"></p>
<p>404 처리도 완벽하게(!?) 됐다.</p>
<h2 id="이미지-서빙"><a href="#이미지-서빙" class="headerlink" title="이미지 서빙"></a>이미지 서빙</h2><p>첫 요청으로 index.html을 서빙하는 것 까지는 성공했는데, 중간에 이미지가 빠져있는 게 보일 것이다.</p>
<p>이미지를 노출하려면 몇 가지 더 수정을 해야한다.</p>
<h3 id="첫째-두-가지의-요청을-처리할-수-있어야-한다"><a href="#첫째-두-가지의-요청을-처리할-수-있어야-한다" class="headerlink" title="첫째, 두 가지의 요청을 처리할 수 있어야 한다."></a>첫째, 두 가지의 요청을 처리할 수 있어야 한다.</h3><p>즉, HTML을 요청하는 것과 이미지를 요청하는 것.</p>
<p>첫 요청으로 브라우저는 index.html이라는 HTML을 얻었다.</p>
<p>이 HTML 문서를 파싱하다가 img 태그를 만났고 src가 beer_server.jpg라는 상대 링크이기 때문에 우리의 서버에 다시 요청을 보낸다.</p>
<p>첫 요청이 <code>GET / HTTP/1.1</code>라면 이어서 <code>GET /beer_server.jpg HTTP/1.1</code>라는 요청이 이어질 것이다.</p>
<p><code>개발자 도구 &gt; 네트워크</code>를 열어 확인해보자.</p>
<p><img src="/images/phttp-05/index_html_network.png" alt="index.html의 네트워크"></p>
<p>(contents_min.css 저 놈은 크롬 확장 프로그램 때문에 날아간 것이니 신경 쓰지 말자 😭)</p>
<p>favicon.ico는 브라우저 탭에 표시해주는 작은 이미지인데, 최신 브라우저에서는 favicon이 등록되어 있지 않은 사이트일 경우 서버에 &#x2F;favicon.ico가 있는지 한번 찔러본다.<br>(사실 계속 찔러보기는 하는데..)</p>
<p>따라서 예상치 못하게 이미지 하나를 더 서비스 해야할 상황이다.</p>
<ul>
<li>index.html</li>
<li>beer_server.png </li>
<li>favicon.ico</li>
</ul>
<p>이제 클라이언트가 보낸 요청을 분석해서 뭘 원하는 지 알아내야 할 판이다.</p>
<h3 id="둘째-이미지를-읽고-써야한다"><a href="#둘째-이미지를-읽고-써야한다" class="headerlink" title="둘째, 이미지를 읽고 써야한다."></a>둘째, 이미지를 읽고 써야한다.</h3><p>위 소스에서 index.html을 어떻게 찾았는지 살펴보자.</p>
<p>server.php가 실행된 위치에서 <code>..</code>로 상위 디렉토리로 올리가 <code>public</code>이라는 디렉토리에 있는 파일을 서빙했다.</p>
<p>이러다 서버 프로그램 위치가 이동한달지 webroot를 변경하면 서버 코드를 수정할 판이다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>냄새가 난다, 냄새가.</p>
<p>index.html 하나 서비스했을 뿐인데 많은 구조적인 문제가 폭발했다.</p>
<p>클라이언트 요청(request)를 분석하고 html을 줄지 이미지를 줄지 결정해야하고,</p>
<p>DOCUMENT_ROOT, WEB_ROOT 등 config 설정도 해야할 것 같다.</p>
<p>200과 404 응답을 만들어주는 코드 모두에 fwrite&#x2F;fclose 로직이 중복되어 있기도 하다.</p>
<p>이 모든 걸 담기에는 이미 서버 프로그램이 너무 복잡하다.</p>
<p>다음 시간부터 이를 하나씩 분리해서 HTTP 완벽가이드 5장에 소개된 ‘진짜 웹 서버가 하는 일’을 구현해볼 생각이다.</p>
<ol>
<li>커넥션을 맺는다</li>
<li>요청을 받는다</li>
<li>요청을 처리한다</li>
<li>리소스에 접근한다</li>
<li>응답을 만든다</li>
<li>응답을 보낸다</li>
<li>트랜잭션을 로그로 남긴다</li>
</ol>
<p>(1번, 2번 정도는 PHP 함수로 대충 때웠으니 했다고 치자) </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/16/phttp-04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/16/phttp-04/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 04 - 가장 간단한 서버</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-16 21:37:43" itemprop="dateCreated datePublished" datetime="2017-10-16T21:37:43+09:00">2017-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/16/phttp-04/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/16/phttp-04/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h3 id="Updated-2017-10-18"><a href="#Updated-2017-10-18" class="headerlink" title="Updated (2017.10.18)"></a>Updated (2017.10.18)</h3><p>이번 글과 관련된 내용이라 조금 더 추가해봤습니다.</p>
<p>하단 <a href="#Updated">Updated</a> 참고.</p>
<h2 id="가장-간단한-서버"><a href="#가장-간단한-서버" class="headerlink" title="가장 간단한 서버"></a>가장 간단한 서버</h2><p>이제부터 하나씩 기능을 붙여가며 commit &amp; push를 할 예정이다.</p>
<p>PHP7.1&#x2F;mac 환경에서 공부한 결과를 적는 거라서, 윈도 머신에선 안 통하는 설명도 있으리라.</p>
<p>소스 위치는 <a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp">https://github.com/youngiggy/phttp</a></p>
<p><a href="/2017/10/06/phttp-02">PHP로 HTTP 서버 구현하기 - 01</a>에서 언급한 가장 간단한 서버부터 시작해볼까?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">stream_copy_to_stream</span>(<span class="variable">$client</span>, <span class="variable">$client</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>딱 봐도 어려울 것 없는 코드다.</p>
<p>127.0.0.1이란 IP에 1337 포트를 열었다. </p>
<p>왜 하필 1337이냐고? 그냥! 저 블로그 쓴 사람이 그렇게 써서 따라했다. </p>
<p>사용하는 프로그램에 따라 이미 포트가 선점되었을 수도 있다.</p>
<ul>
<li>기본으로 이 포트를 쓰는 프로그램이 있는지 <a target="_blank" rel="noopener" href="https://www.speedguide.net/port.php?port=1337">이런 곳</a>에서 찾아봐도 좋고</li>
<li>쉘에서 <code>lsof -PiTCP -sTCP:LISTEN</code> 포트가 열려있는지 확인해봐도 좋다</li>
</ul>
<p>그 다음 while 루프로 뱅글뱅글 돌면서 연결이 들어오는 지 확인한다.</p>
<p><code>stream_socket_accept</code> 함수가 말을 못하게 @로 입을 막자.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=u5CVsCnxyXg">&amp;#9834;</a> No alarms and no surprises </li>
<li>하지만 안 막는다고 뭐 대단한 걸 볼 일은 없을 것이다</li>
</ul>
<p>연결이 된 클라이언트가 있다면, <code>stream_copy_to_stream</code>를 통해 클라이언트가 보낸 스트림을 고스란히 돌려주자.</p>
<p>고스란히…</p>
<p><img src="https://media.tenor.com/images/5746acedc3829ed1e2e569c8d525c6f9/tenor.gif" alt="주고 받기"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tenor.com/view/kdrama-korean-slap-anger-angry-gif-9330050">https://tenor.com/view/kdrama-korean-slap-anger-angry-gif-9330050</a></li>
</ul>
<h2 id="가장-간단한-클라이언트"><a href="#가장-간단한-클라이언트" class="headerlink" title="가장 간단한 클라이언트"></a>가장 간단한 클라이언트</h2><p>가장 간단한 서버가 완성됐으니 터미널을 열어 <code>php ./app/server.php</code>로 일을 시키고 돌아오자.</p>
<p>새로운 터미널을 열어 <code>echo &quot;hello hello&quot; | nc 127.0.0.1 1337</code>를 입력하면 <code>hello hello</code>라고 반갑게 인사하는 것이 보일 것이다.</p>
<p>너무 시시하니까 가장 간단한 클라이언트를 만들어 잘 돌아가는 지 구경해보자.</p>
<p>아직 브라우저에서 HTTP 프로토콜로 붙을 상황은 아니므로 간단한 TCP 연결 클라이언트로 테스트 한다.</p>
<p>역시 <a target="_blank" rel="noopener" href="https://www.christophh.net/2012/07/24/php-socket-programming/">PHP Socket Programming, done the Right Way</a>에서 예시로 보여준 것을 기본으로 시작한다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$client</span> = <span class="title function_ invoke__">stream_socket_client</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$client</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Failed to connect: <span class="subst">$errno</span> - <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * generate a message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$startLine</span> = <span class="string">&#x27;GET / HTTP/1.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$headers</span> = [</span><br><span class="line">    <span class="string">&#x27;Host: localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept: */*&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"><span class="variable">$header</span> = <span class="title function_ invoke__">implode</span>(PHP_EOL, <span class="variable">$headers</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$emptyLine</span> = PHP_EOL;</span><br><span class="line"></span><br><span class="line"><span class="variable">$body</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * request</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$message</span> = <span class="title function_ invoke__">implode</span>(PHP_EOL, [</span><br><span class="line">    <span class="variable">$startLine</span>,</span><br><span class="line">    <span class="variable">$header</span>,</span><br><span class="line">    <span class="variable">$emptyLine</span>,</span><br><span class="line">    <span class="variable">$body</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$client</span>, <span class="variable">$message</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * bye bye</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br></pre></td></tr></table></figure>

<p>역시 별 거 없는 코드다.</p>
<p><code>stream_socket_client</code>으로 연결을 시도하고,</p>
<p>HTTP 메시지를 만들어 준다.</p>
<ul>
<li>HTTP 메시지는 시작줄, 헤더, 공백, 바디로 이뤄졌다. <a href="/2017/08/23/http-the-definitive-guide-chapter-3">참고</a></li>
</ul>
<p>이 메시지를 fwrite를 통해 스트림에 써 준다.</p>
<p><a href="/2017/10/06/phttp-02">02편</a>에서 얘기한 것처럼, <code>stream_socket_client</code>이 리턴하는 stream resource에는 fopen, fread같은 filesystem 함수를 사용할 수 있다.</p>
<h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p>터미널을 하나 열고 <code>php ./app/client.php</code>로 클라이언트를 실행해보자.</p>
<p>아무 반응이 없을 것이다.</p>
<p>하지만 조금만 더 기다려보면, 1분 후 timeout으로 client가 종료되고 자신이 서버에 전송한 값이 화면에 찍한다.</p>
<p>왜 그럴까?</p>
<p>다르게 재현해보자.</p>
<p>서버를 다시 실행하고 클라이언트를 다시 실행한 후, 이번엔 서버를 죽여보자.</p>
<p>이때도 클라이언트와 연결이 바로 끊어지고 서버에 전송한 값이 되돌아와 화면에 찍힌다.</p>
<p>우선 timeout 1분은 환경마다 다를 수 있는데, php.ini에 default_socket_timeout에 정의되어 있다.</p>
<p>client 소스의 response 부분을 아래와 같이 바꿔보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">4</span>))) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span> . <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그럼 아래와 같이 나오던 것이</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET / HTTP/1.0</span><br><span class="line">Host: localhost</span><br><span class="line">Accept: *</span><br></pre></td></tr></table></figure>

<p>아래와 같이 바로 찍힌다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET |/ HT|TP/1|.0</span><br><span class="line">H|ost:| loc|alho|st</span><br><span class="line">A|ccep|t: *|/*</span><br></pre></td></tr></table></figure>

<p><code>stream_get_contents</code>의 두번째 인자는 maxlength라서 지정한 만큼만 스트림에서 읽어온다.</p>
<p>그래서 읽어온 만큼 바로바로 화면에 echo 하는 것이다. </p>
<ul>
<li>보기 좋으라고(?)뒤에 |를 붙여봤다.</li>
</ul>
<p>하지만 이렇게 해도 클라이언트는 종료되지 않는다.</p>
<p><code>stream_get_contents</code>가 계속 스트림에 뭔가 들어오는지 지켜보고 있어서 while loop가 끝나지 않는다.</p>
<p>이 악순환의 고리를 끊으려면 서버에서 연결을 끊어버리면 간단한데, 우리 코드에선 클라이언트로 들어오는 스트림을 바로 돌려주기 때문에 쉽지 않다.</p>
<p>클라이언트에서 loop를 종료하려면 어디가 끝인지를 확인해야만 한다.</p>
<p>서버가 Content-Length를 돌려주게끔 해주면 좋겠지만 우리 서버는 아직 바보니까 클라이언트가 좀 더 고생을 하자. </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$messageLenth</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$message</span>);</span><br><span class="line"><span class="variable">$totalLenth</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$totalLenth</span> += <span class="title function_ invoke__">strlen</span>(<span class="variable">$response</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$messageLenth</span> &lt;= <span class="variable">$totalLenth</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Updated"><a href="#Updated" class="headerlink" title="Updated"></a>Updated</h2><p>이 글 이후로 좀 더 진행해보다가 meta 정보를 이용하는 방법까지는 여기에 묻어두는 것이 좋을 것 같아서 내용을 추가한다.</p>
<p><code>stream_get_contents</code>으로 데이터를 가져온 다음 현재 스트림의 상태를 보려면 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-get-meta-data.php">stream_get_meta_data</a>를 통해 확인할 수 있다.</p>
<p>여기에는 다음과 같은 정보가 리턴된다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [timed_out] =&gt; </span><br><span class="line">    [blocked] =&gt; 1</span><br><span class="line">    [eof] =&gt; </span><br><span class="line">    [stream_type] =&gt; tcp_socket/ssl</span><br><span class="line">    [mode] =&gt; r+</span><br><span class="line">    [unread_bytes] =&gt; 1</span><br><span class="line">    [seekable] =&gt; </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>어쩐지 eof나 unread_bytes를 쓰면 될 것 같다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$client</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$info</span>[<span class="string">&#x27;eof&#x27;</span>] || <span class="variable">$info</span>[<span class="string">&#x27;unread_bytes&#x27;</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>이렇게 하니 소중한 고객님의 연결이 끊겼습니다.</p>
<p>그러나,</p>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-get-meta-data.php">문서</a>를 보면 unread_bytes가 의미하는 것은,</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">unread_bytes (int) - the number of bytes currently contained in the PHP&#x27;s own internal buffer.</span><br></pre></td></tr></table></figure>

<p>즉, PHP 자체의 내부 버퍼의 내용을 보여주는 것이라서 스크립트에서 활용하지 않을 것을 추천하고 있다. </p>
<blockquote>
<p>Note: You shouldn’t use this value in a script.</p>
</blockquote>
<p>그럼 포기하고 다른 방법을 찾아보자.</p>
<p>우선 client 쪽 소스에서 unread_bytes를 검사하는 부분만 제거한 다음,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$client</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">stream_get_meta_data</span>(<span class="variable">$client</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$info</span>[<span class="string">&#x27;eof&#x27;</span>] || <span class="variable">$info</span>[<span class="string">&#x27;unread_bytes&#x27;</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>연결이 안 끊어지는 것을 반드시 확인하자.</p>
<p>그 다음,</p>
<p>서버쪽 소스에서 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-set-blocking.php">stream_set_blocking</a>으로 non-blocking 모드로 바꿔보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$client</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>즉, 서버의 전체 소스는 아래와 같이 변할 것이다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$server</span> = <span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://127.0.0.1:1337&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errorMessage</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$server</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">UnexpectedValueException</span>(<span class="string">&quot;Could not bind to socket: <span class="subst">$errorMessage</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="variable">$client</span> = @<span class="title function_ invoke__">stream_socket_accept</span>(<span class="variable">$server</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">stream_set_blocking</span>(<span class="variable">$client</span>, <span class="literal">false</span>);<span class="comment">// &lt;-- 여기요 여기</span></span><br><span class="line">        <span class="title function_ invoke__">stream_copy_to_stream</span>(<span class="variable">$client</span>, <span class="variable">$client</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>클라이언트를 실행하면 바로 연결이 끊긴다.</p>
<p><code>stream_set_blocking</code> 함수의 두번째 인자 mode가 false로 들어가면 non-blocking 모드로 진입하며,</p>
<p>클라이언트 쪽에서는 스트림으로 더이상의 데이터가 들어오는 것을 기다리지 않는다.</p>
<p>이렇게 하면 굳이 스트림을 쓸 이유가 없기 때문에 이 역시도 좋은 방법은 아닐 것이다.</p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>아주 간단한 서버와 아주 간단한 클라이언트를 아주 간단히 살펴봤다.</p>
<p>도저히 못 써먹겠으니 다음 글에서는 이를 좀 더 개선해보자.<br>(뭘 어떻게 바꿀 지는 아직 계획없음)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/14/book-979-11-85152-65-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/14/book-979-11-85152-65-3/" class="post-title-link" itemprop="url">독후감 - 내 문장이 그렇게 이상한가요?</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-14 11:09:26" itemprop="dateCreated datePublished" datetime="2017-10-14T11:09:26+09:00">2017-10-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/14/book-979-11-85152-65-3/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/14/book-979-11-85152-65-3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://image.kyobobook.co.kr/images/book/large/431/l9791185152431.jpg" alt="내 문장이 그렇게 이상한가요?"></p>
<p>개발자들 사이에서 꽤 화제가 된 책이라 한번 가볍게 읽어봤다.</p>
<p>가볍게 읽을 수 있고 책 무게도 매우 가벼우나, 내용은 가볍지만은 않다.</p>
<p>읽고 난 후에는 계속 내 글을 돌아보게 하기도 하고,</p>
<p>남이 쓴 글이 거슬리기도 하고.</p>
<p>우리가 평소에 많이 쓰는 표현이 왜 이상한지에 집중한 책이다.</p>
<p>왜 이상한지 들었지만 계속 그대로 쓸 것 같은 문장도 있긴 하다. 직장 생활에서는 어울리는 그런 말.</p>
<p>이 책은 얼마 전에 읽은 ‘<a target="_blank" rel="noopener" href="http://www.kyobobook.co.kr/product/detailViewKor.laf?barcode=9788998791643">이와 손톱</a>‘처럼 두 개의 이야기를 교차해 보여준다.</p>
<p>이상한 문장 표현을 건조하게 알려주는 하나의 트랙이 있고, 교정에 관한 감성적인 소설이 또 하나의 트랙을 맡고 있다.</p>
<p>이 책을 선뜻 마초 성향의 뭇 남성들에게 추천하기 어려운 이유기도 하다.</p>
<p>문장 다듬는 것에만 관심이 있는 자라면 필요한 부분만 훑어봐도 좋을 것이다.</p>
<p>여러분도 하나 장만하시라.</p>
<p>종종 돌아보고 잊지 않기 위해 (나만 알 수 있게) 요약해둔다.</p>
<h2 id="요약"><a href="#요약" class="headerlink" title="요약"></a>요약</h2><p>적·의를 보이는 것·들</p>
<p>굳이 있다고 쓰지 않아도 어차피 있는</p>
<ul>
<li>있는</li>
<li>ㅡ관계에 있는</li>
<li>ㅡ에게 있어</li>
<li>ㅡ하는 데 있어</li>
<li>ㅡ함에 있어</li>
<li>ㅡ있음에 틀림없다</li>
</ul>
<p>지적으로 게을러 보이게 만드는 표현</p>
<ul>
<li>ㅡ에 대한</li>
<li>ㅡ들 중 하나&#x2F;한 사람&#x2F;무엇</li>
<li>ㅡ같은 경우</li>
<li>ㅡ에 의한, ㅡ으로 인한</li>
</ul>
<p>ㅡ에 vs ㅡ에는</p>
<p>내 문장은 대체 어디에서 와서 어디로 가는 걸까</p>
<ul>
<li>ㅡ에 vs ㅡ으로</li>
<li>ㅡ에 vs ㅡ을(를)</li>
<li>ㅡ로의, ㅡ에게로</li>
<li>ㅡ에, ㅡ에게, ㅡ에게서</li>
<li>ㅡ로부터</li>
</ul>
<p>당하고 시키는 말로 뒤덮힌 문장</p>
<ul>
<li>설레임</li>
<li>두번 당하는 말</li>
<li>시키다</li>
<li>시켜주다</li>
<li>커피 나오셨습니다</li>
</ul>
<p>사랑을 할 때와 사랑할 때의 차이</p>
<ul>
<li>ㅡ을 하다 vs ㅡ하다</li>
</ul>
<p>될 수 있는지 없는지</p>
<ul>
<li>될 수 있는, 할 수 있는</li>
</ul>
<p>문장은 손가락이 아니다</p>
<ul>
<li>그, 이, 저, 그렇게, 이렇게, 저렇게</li>
<li>여기, 저기, 거기</li>
<li>그 어느, 그 어떤, 그 누구, 그 무엇</li>
</ul>
<p>과거형을 써야 하는지 안 써도 되는지</p>
<ul>
<li>ㅡ었던</li>
<li>ㅡ는가</li>
</ul>
<p>시작할 수 있는 것과 없는 것</p>
<p>문장 다듬기</p>
<ul>
<li>왼쪽에서 오른쪽</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/12/phttp-03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/12/phttp-03/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 03 - CGIStream class 둘러보기</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-12 19:20:37" itemprop="dateCreated datePublished" datetime="2017-10-12T19:20:37+09:00">2017-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/12/phttp-03/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/12/phttp-03/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<p>지난번에 이어 CGIStream class(<a target="_blank" rel="noopener" href="https://github.com/youngj/httpserver">HTTPServer</a> 참고)를 살펴보는 시간.</p>
<p>말했지만, 좀 옛스러운 코드니 결벽증이 있는 분은 다음 장으로…</p>
<p>왜 요즘 버전의 소스를 분석하지 않냐는 질문도 할 법 하다.</p>
<p>못 구했다.</p>
<p>일단 이건 정말 공부를 위한 뻘짓이기 때문에 굳이 구현하고 싶은 사람이 없었을 것으로 보인다.</p>
<p>게다가 PHP5.4부터 내장 서버를 지원하는데 뭐하러 굳이…</p>
<p>다시 집중!</p>
<h2 id="CGIStream-class"><a href="#CGIStream-class" class="headerlink" title="CGIStream class"></a>CGIStream class</h2><p>주석을 보면 CGIStream class는 CGI 프로세스가 완료될 때까지 버퍼 기능도 하고, 헤더를 조작하는 것도 가능하다고 한다.</p>
<p>외부에서 이 클래스를 어떻게 사용하는 지 찾아보면 눈에 익은 문법이 보일 것이다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stream_wrapper_register</span>(<span class="string">&quot;cgi&quot;</span>, <span class="string">&quot;CGIStream&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>HTTPServer class(httpserver.php)에서 서버를 띄우기 전에 등록하는 코드다.</p>
<p>코드에서 보듯이 CGIStream class는 Stream wrapper class라고 할 수 있고,</p>
<p>Stream wrapper class의 메소드 중 <code>stream_cast</code>, <code>stream_open</code>, <code>stream_read</code>, <code>stream_eof</code>, <code>stream_close</code>만 구현했다.</p>
<p>이 중에 이해하기 쉬운 애들은 빼고 두가지 메소드만 설명해보겠다.</p>
<h3 id="stream-read"><a href="#stream-read" class="headerlink" title="stream_read"></a>stream_read</h3><p><code>stream_read</code>는 BUFFERING&#x2F;BUFFERED&#x2F;EOF 상태에 따라 해야할 일을 구현해놓았다.</p>
<p>BUFFERING 단계에선 버퍼에 request 메시지를 담고, server 쪽 클래스를 통해 request 구문을 분석하고, response를 위한 문자열을 만들고, 이를 data type의 스트림에 쌓아둔다. 그리고 현재 상태를 BUFFERED로 업데이트 한다.</p>
<p>BUFFERED 단계에선 앞서 data 스트림에 쌓아두었던 값을 리턴한다. 그리고 현재 상태를 EOF로.</p>
<p>EOF 단계에선 <code>return false;</code>.</p>
<p>내가 상상했던 코드는 이 스트림쪽에선 버퍼링 정도만 처리하고 나머지는 server 쪽 코드에 위임하는 것이었는데,</p>
<p><code>\r\n\r\n</code>(HTTP 메시지의 header와 body 구분자)로 메시지를 검사한다거나 <code>HTTPServer::parse_headers</code> 결과를 분석한다거나 하는 일도 한다.</p>
<p>이런 부분은 역할 분리가 덜 된 것 같다는 생각이 든다.</p>
<h3 id="stream-open"><a href="#stream-open" class="headerlink" title="stream_open"></a>stream_open</h3><p><code>stream_open</code> 메소드가 호출되는 시점은 php.net에서 <a target="_blank" rel="noopener" href="http://php.net/manual/en/streamwrapper.stream-open.php">이렇게</a> 설명한다.</p>
<blockquote>
<p>This method is called immediately after the wrapper is initialized</p>
</blockquote>
<p>wrapper가 초기화 될 때, 그러니까</p>
<p><code>fopen(&quot;cgi://PHP파일&quot;...</code></p>
<p>이런 식이다.</p>
<p><code>stream_open</code>에서 cgi로 php파일을 열고, <code>stream_read</code>에서 그 실행한 결과를 스트림으로 받아 처리하는 것이다.</p>
<p>이 예제에선 stream_context_get_options로 현재 설정된 <code>stdin</code>, <code>env</code>, <code>server</code>, <code>response</code> 등의 context를 얻어오고</p>
<p>이를 활용해 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.proc-open.php">proc_open</a>으로 스트림을 연다.</p>
<h2 id="CGIStream는-여기서-마무리"><a href="#CGIStream는-여기서-마무리" class="headerlink" title="CGIStream는 여기서 마무리"></a>CGIStream는 여기서 마무리</h2><p>이제 실제 서버를 띄우는 HTTPServer class에서 이 Stream wrapper(CGIStream class)를 등록하고 활용하는 부분을 보면 이 동네는 대략 이해가 될 것이다.</p>
<p>여기까지 분석해보니 결국 CGI용 Stream wrapper는 PHP 스크립트를 실행하기 위한 것이었다.</p>
<p><code>http://app.dev/test.php</code> 같은 요청을 받는 일 말이다.</p>
<p>즉, (일단은) HTML과 이미지 정도의 static한 응답만 처리할 나에게는 php-cgi binary 같은 건 필요없다!! (오예)</p>
<h2 id="HTTPServer-class"><a href="#HTTPServer-class" class="headerlink" title="HTTPServer class"></a>HTTPServer class</h2><p>이왕 본 김에 이 CGI 스트림 wrapper를 어떻게 등록하는 지만 살펴보고 (쓸 데 없었던) 2, 3장을 마무리 해야겠다.</p>
<p>HTTPServer class는 PHP 요청과 이미지 같은 static 리소스를 별도로 라우팅한다.</p>
<p>우선 서버를 실행하면</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stream_wrapper_register</span>(<span class="string">&quot;cgi&quot;</span>, <span class="string">&quot;CGIStream&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//중략</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$sock</span> = @<span class="title function_ invoke__">stream_socket_server</span>(<span class="string">&quot;tcp://<span class="subst">$addr_port</span>&quot;</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>);</span><br></pre></td></tr></table></figure>

<p>CGI용 스트림 wrapper를 등록하고 tcp 소켓을 하나 열어둔다.</p>
<p>Client가 요청한 리소스가 PHP 스크립트일 경우, HTTPServer의 <code>get_php_response</code> 메소드로 라우팅된다.</p>
<p>앞서 CGIStream의 <code>stream_open</code>을 설명하면서 stream_context_get_options으로 컨텍스트 정보를 가져온다고 했는데,</p>
<p>바로 여기에서 컨텍스트 정보를 만들어 주는 것이다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$context</span> = <span class="title function_ invoke__">stream_context_create</span>(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;cgi&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;env&#x27;</span> =&gt; <span class="title function_ invoke__">array_merge</span>(<span class="variable">$_ENV</span>, <span class="variable">$this</span>-&gt;cgi_env, <span class="variable">$cgi_env</span>),</span><br><span class="line">        <span class="string">&#x27;stdin&#x27;</span> =&gt; <span class="variable">$request</span>-&gt;content_stream,</span><br><span class="line">        <span class="string">&#x27;server&#x27;</span> =&gt; <span class="variable">$this</span>,</span><br><span class="line">        <span class="string">&#x27;response&#x27;</span> =&gt; <span class="variable">$response</span>,</span><br><span class="line">    )</span><br><span class="line">));</span><br><span class="line"><span class="variable">$cgi_stream</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;cgi://<span class="subst">&#123;$this-&gt;php_cgi&#125;</span>&quot;</span>, <span class="string">&#x27;rb&#x27;</span>, <span class="literal">false</span>, <span class="variable">$context</span>);</span><br></pre></td></tr></table></figure>

<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>예상대로(?) php-cgi binary 같은 건 필요없다는 결론을 얻기 위해 긴 시간을 허비했다.</p>
<p>이 시리즈의 다음 글부터는 최소한의 구성으로 서버를 띄우고, 기능을 하나씩 입혀 나갈 예정이다.</p>
<p>그러니까…</p>
<p>예정이다.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/06/phttp-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/06/phttp-02/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 02 - Stream wrapper</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-06 11:18:47" itemprop="dateCreated datePublished" datetime="2017-10-06T11:18:47+09:00">2017-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/06/phttp-02/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/06/phttp-02/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<h1 id="Stream-wrapper-class"><a href="#Stream-wrapper-class" class="headerlink" title="Stream wrapper class"></a>Stream wrapper class</h1><p>시행착오를 최대한 줄이기 위해 앞에서 소개했던 <a target="_blank" rel="noopener" href="https://github.com/youngj/httpserver">HTTPServer</a>부터 분석을 해보기로 했다.</p>
<p>composer.json에 있는 php-cgi binary에 대한 의존성 때문인데(<code>HTTPServer requires the php-cgi binary</code>), 이 놈을 왜 넣었을까 궁금했다.</p>
<p>이 서버는 4개의 파일로 구성됐다.</p>
<ul>
<li>cgistream.php</li>
<li>httprequest.php</li>
<li>httpresponse.php</li>
<li>httpserver.php</li>
</ul>
<p>http가 prefix로 붙은 파일은 뭐하는 놈인지 이름만 봐도 알 것 같다. cgistream.php을 열어봤다.</p>
<p>오래전에 만든 클래스라서 좀 옛스러운 맛이 있다.</p>
<h2 id="CGIStream-class-주석"><a href="#CGIStream-class-주석" class="headerlink" title="CGIStream class 주석"></a>CGIStream class 주석</h2><p>주석부터 살펴볼까?</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * CGIStream is a PHP stream wrapper (http://www.php.net/manual/en/class.streamwrapper.php)</span></span><br><span class="line"><span class="comment"> * that wraps the stdout pipe from a CGI process. It buffers the output until the CGI process is</span></span><br><span class="line"><span class="comment"> * complete, and then rewrites some HTTP headers (Content-Length, Status, Server) and sets the HTTP status code</span></span><br><span class="line"><span class="comment"> * before returning the output stream from fread().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This allows the server to be notified via stream_select() when the CGI output is ready, rather than waiting</span></span><br><span class="line"><span class="comment"> * until the CGI process completes.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>CGIStream is a <a target="_blank" rel="noopener" href="http://www.php.net/manual/en/class.streamwrapper.php">PHP stream wrapper</a> that wraps the stdout pipe from a CGI process.</p>
</blockquote>
<p>CGI process로부터 흘러나오는 stdout stream을 wrapping한다. - 이건 뭐 해석한 것도 아니고 안 한 것도 아니고…</p>
<p>참고로, 앞으로 스트림과 stream을 섞어서 쓸텐데(한글 혹은 영어로), 여기엔 큰 의미를 부여하지 말고 그냥 읽으시면 된다.</p>
<h2 id="Stream-wrapper-class-1"><a href="#Stream-wrapper-class-1" class="headerlink" title="Stream wrapper class"></a>Stream wrapper class</h2><p>php.net에 들어가보면,</p>
<blockquote>
<p>Allows you to implement your own protocol handlers and streams for use with all the other filesystem functions (such as fopen(), fread() etc.).</p>
</blockquote>
<p>나만의 프로토콜 핸들러와 fopen, fread같은 filesystem 함수를 사용할 수 있는 스트림을 구현할 수 있다고 한다.</p>
<p>php.net의 VariableStream을 만드는 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-wrapper-register.php">예제</a>부터 알아봐야겠다.</p>
<p>우선 커스텀 stream wrapper를 어떻게 사용하는지부터.</p>
<h2 id="Using-stream-wrapper"><a href="#Using-stream-wrapper" class="headerlink" title="Using stream wrapper"></a>Using stream wrapper</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$existed</span> = <span class="title function_ invoke__">in_array</span>(<span class="string">&quot;var&quot;</span>, <span class="title function_ invoke__">stream_get_wrappers</span>());</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$existed</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">stream_wrapper_unregister</span>(<span class="string">&quot;var&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">stream_wrapper_register</span>(<span class="string">&quot;var&quot;</span>, <span class="string">&quot;VariableStream&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>“var”로 이미 등록된 wrapper가 있다면 먼저 제거한다.</p>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-get-wrappers.php">stream_get_wrappers</a>는 등록된 stream wrapper 배열을 리턴하는데, 보통 이런 리스트가 나올 것이다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; https</span><br><span class="line">    [1] =&gt; ftps</span><br><span class="line">    [2] =&gt; compress.zlib</span><br><span class="line">    [3] =&gt; compress.bzip2</span><br><span class="line">    [4] =&gt; php</span><br><span class="line">    [5] =&gt; file</span><br><span class="line">    [6] =&gt; glob</span><br><span class="line">    [7] =&gt; data</span><br><span class="line">    [8] =&gt; http</span><br><span class="line">    [9] =&gt; ftp</span><br><span class="line">    [10] =&gt; phar</span><br><span class="line">    [11] =&gt; zip</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>이렇게 unregister하더라도 built-in wrapper일 경우는 나중에 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.stream-wrapper-restore.php">stream_wrapper_restore</a>로 복원할 수 있다.</p>
<p><code>stream_wrapper_register</code>함수의 두번째 인자는 첫번째 인자(protocol)에 해당하는 스트림을 처리할 클래스명이다.</p>
<p>이런 클래스를 어떻게 구현할 것인지는 잠시 후에 다룬다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$myvar</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;var://myvar&quot;</span>, <span class="string">&quot;r+&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&quot;line1\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&quot;line2\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="string">&quot;line3\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>위에서 언급한 대로 stream wrapper를 구현하면 fopen, fread같은 filesystem 함수를 사용할 수 있다.</p>
<p><a target="_blank" rel="noopener" href="http://php.net/manual/kr/function.fopen.php">fopen</a> 함수로 스트림을 r+(초기화가 없는 read+write) 모드로 열고, 몇 줄 써준다.</p>
<p>URL에는 아까 <code>stream_wrapper_register</code>함수에 첫번째 인자로 등록한 protocol을 URL scheme으로 사용하고 입력받을 myvar라는 전역 변수를 사용한다.</p>
<p>물론 URL을 어떻게 쓰고 처리할 지는 wrapper 구현에 달려있다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">rewind</span>(<span class="variable">$fp</span>);</span><br><span class="line"><span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$fp</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$myvar</span>);</span><br></pre></td></tr></table></figure>

<p>파일 포인터를 맨 앞으로 돌리고, 파일의 내용을 한줄 한줄 써준다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$existed</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">stream_wrapper_restore</span>(<span class="string">&quot;var&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>다 썼으면 초기화 한다. 만약,</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">stream_wrapper_register(&quot;var&quot;, &quot;VariableStream&quot;);</span><br><span class="line">stream_wrapper_unregister(&quot;var&quot;);</span><br><span class="line">stream_wrapper_restore(&quot;var&quot;);</span><br></pre></td></tr></table></figure>
<p>이러면 뭐 달라질까? 방금 등록한 <code>var</code> wrapper는 built-in이 아니기 때문에 restore해도 아무 의미 없다.</p>
<p>사용하는 방법은 특별할 게 없으므로, VariableStream이란 클래스를 어떻게 구현하면 될지 살펴보자.</p>
<h2 id="Stream-wrapper"><a href="#Stream-wrapper" class="headerlink" title="Stream wrapper"></a>Stream wrapper</h2><p><a target="_blank" rel="noopener" href="http://php.net/manual/en/class.streamwrapper.php">Stream wrapper class</a>는 넓은 의미의 인터페이스지만,</p>
<p>implements 할 수 있는 interface는 아니다. 실제 존재하는 클래스가 아니라 어떻게 동작하는 지를 보여주기 위한 prototype일 뿐이다.</p>
<blockquote>
<p>Note:<br>  This is NOT a real class, only a prototype of how a class defining its own protocol should be.</p>
</blockquote>
<p>php.net에 누가 댓글로 interface로 만들어 올렸지만, 그건 거 쓰지 말라는 댓글도 보인다(필요하지 않은 메소드도 무조건 구현해놔야 하기 때문에).</p>
<p>필요한 메소드만 구현하는 게 정석이라고 보면 되겠다.</p>
<p>댓글로 올라온 VariableStream 클래스를 참고해서 위 스크립트가 돌아갈 만한 간단한 커스텀 wrapper를 실행해봤다.</p>
<p>몇가지 문법 오류와 변수명을 좀 더 알기 쉽게 바꿨다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VariableStream</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$position</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$varname</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_open</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$mode</span>, <span class="variable">$options</span>, &amp;<span class="variable">$opened_path</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$path</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;varname = <span class="variable">$url</span>[<span class="string">&quot;host&quot;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;position = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_read</span>(<span class="params"><span class="variable">$count</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$position</span> =&amp; <span class="variable language_">$this</span>-&gt;position;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$this</span>-&gt;varname], <span class="variable">$position</span>, <span class="variable">$count</span>);</span><br><span class="line">        <span class="variable">$position</span> += <span class="title function_ invoke__">strlen</span>(<span class="variable">$ret</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_write</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$variable</span> =&amp; <span class="variable">$GLOBALS</span>[<span class="variable language_">$this</span>-&gt;varname];</span><br><span class="line">        <span class="variable">$len</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$position</span> =&amp; <span class="variable language_">$this</span>-&gt;position;</span><br><span class="line">        <span class="variable">$variable</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$variable</span>, <span class="number">0</span>, <span class="variable">$position</span>) . <span class="variable">$data</span> . <span class="title function_ invoke__">substr</span>(<span class="variable">$variable</span>, <span class="variable">$position</span> += <span class="variable">$len</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$len</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_tell</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_eof</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;position &gt;= <span class="title function_ invoke__">strlen</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$this</span>-&gt;varname]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_seek</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$whence</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$len</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$this</span>-&gt;varname]);</span><br><span class="line">        <span class="variable">$position</span> =&amp; <span class="variable language_">$this</span>-&gt;position;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$whence</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> SEEK_SET:</span><br><span class="line">                <span class="variable">$newPos</span> = <span class="variable">$offset</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SEEK_CUR:</span><br><span class="line">                <span class="variable">$newPos</span> = <span class="variable">$position</span> + <span class="variable">$offset</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SEEK_END:</span><br><span class="line">                <span class="variable">$newPos</span> = <span class="variable">$len</span> + <span class="variable">$offset</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ret</span> = (<span class="variable">$newPos</span> &gt;= <span class="number">0</span> &amp;&amp; <span class="variable">$newPos</span> &lt;= <span class="variable">$len</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$ret</span>) &#123;</span><br><span class="line">            <span class="variable">$position</span> = <span class="variable">$newPos</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>여기선 <code>stream_open</code>, <code>stream_read</code>, <code>stream_write</code>, <code>stream_tell</code>, <code>stream_eof</code>, <code>stream_seek</code> 만을 구현했는데,</p>
<p>그 (가상) 인터페이스의 많은 메소드 중에 뭘 구현해야 할 지 어떻게 알 수 있을까?</p>
<p>그건 사용처에서 어떤 filesystem 함수를 쓰는가에 따라 다르다.</p>
<p>이 예제에서 <code>stream_tell</code> 함수를 구현하지 않았다면, 아래와 같은 warning이 뜰 것이다.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PHP Warning:  rewind(): VariableStream::stream_tell is not implemented! in .....</span><br></pre></td></tr></table></figure>

<p>공용 클래스라면 좀 더 충실히 구현해야겠지만, 이 예제는 이만하면 됐다.</p>
<p>많이 돌아왔는데, 맨 처음에 언급한 CGIStream 클래스로 돌아갈 차례다(이제 겨우 CGIStream 클래스의 주석 한줄 읽었을 뿐이다).</p>
<p>다음 글에 계속..</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/10/05/phttp-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/05/phttp-01/" class="post-title-link" itemprop="url">PHP로 HTTP 서버 구현하기 - 01 - 계획</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-05 01:12:15" itemprop="dateCreated datePublished" datetime="2017-10-05T01:12:15+09:00">2017-10-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/10/05/phttp-01/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/05/phttp-01/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/tags/phttp/">연재글 전체 보기</a></p>
<hr>
<p>HTTP 완벽가이드 5장을 가볍게 읽다가, Perl로 만든 간단한 서버 구현을 보고 이걸 PHP로 구현해보면 좋겠다는 생각을 했다.</p>
<p>그 예제는 (대충 봤는데) HTTP 서버라기 보다 소켓 연결해서 응답해주는 수준의 간단한 구현이었던 것 같고, HTTP 서버가 되려면 뭘 해야하는지는 설명으로만 보여준다.</p>
<p>이응준님은 “<a target="_blank" rel="noopener" href="https://blog.npcode.com/2015/06/07/%EC%9B%B9-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%A8%B8%EB%A5%BC-%EC%9C%84%ED%95%9C-http-%EC%99%84%EB%B2%BD-%EA%B0%80%EC%9D%B4%EB%93%9C-%EC%9D%BD%EB%8A%94-%EB%B2%95/">웹 프로그래머를 위한 HTTP 완벽 가이드 읽는 법</a>“에서</p>
<blockquote>
<p>5장 “웹 서버”는 웹 서버가 어떻게 동작하는지 설명한다. 웹 프로그래머라면 반드시 이해해야 할 것이다.</p>
</blockquote>
<p>라고 하셨지만, 사실 책에는 뭐 그리 많은 내용이 있는 건 아니다.</p>
<p>HTTP 완벽가이드 5장의 내용을 더 알고 싶다면, <a target="_blank" rel="noopener" href="https://www.slideshare.net/cinari4/http-ch5-web-server">남이 정리한 HTTP 완벽가이드 5장</a> 자료를 찾아봐도 좋겠다.</p>
<h2 id="구현-목표"><a href="#구현-목표" class="headerlink" title="구현 목표"></a>구현 목표</h2><p>몇부작이 될 지는 모르겠으나 시간날 때마나 기능을 하나씩 추가해볼까 한다.</p>
<p>단일 쓰레드로 하나의 요청만 처리하는 것부터 시작하기 때문에,</p>
<p>나중에 ReactPHP나 <a target="_blank" rel="noopener" href="http://php.net/manual/en/intro.pthreads.php">멀티쓰레딩 처리</a>(PHP 7.2이상 + CLI 모드에선 가능한 듯) 혹은 멀티쓰레딩 흉내를 내는 것까지 갈 것 같다.</p>
<p>물론 올 해 안을 목표로 하는 프로젝트도 있기 때문에…한두번 하고 그만둘 수도 있다!<br>(중요&#x2F;강조&#x2F;미리죄송)</p>
<p>지금은 뭔가 신났지만…시작이나 하면 다행.</p>
<p>1차로 구현하고자 하는 기능은 ‘이미지가 하나 포함된 HTML 파일을 서비스한다’.</p>
<p>즉, HTML 파일 하나와 이미지 하나 정도 서비스 할 수 있는 능력이면 됐다.</p>
<p>예를 들어 이런 식.</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;ko&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>PHTTP<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://www.engadget.com/media/2006/02/beer_server.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;beer_server&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="가장-간단하게-시작하기"><a href="#가장-간단하게-시작하기" class="headerlink" title="가장 간단하게 시작하기"></a>가장 간단하게 시작하기</h2><p><a target="_blank" rel="noopener" href="http://php.net/manual/kr/sockets.examples.php">php.net의 예제</a></p>
<ul>
<li>클래식한 소켓 연결 예제 프로그램</li>
<li>5년 전 기억을 더듬어 보면 이런 식으로 짰던 것 같기도 하다</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.christophh.net/2012/07/24/php-socket-programming/">PHP Socket Programming, done the Right Way</a></p>
<ul>
<li>여기서는 PHP5.0 부터 사용할 수 있는 stream_socket_* 친구들을 소개한다</li>
<li>존 레식 닯은 청년이 아주 친절하게 설명해주기 때문에, 누구든 국경을 초월한 지식 습득이 가능하다</li>
<li>안 쓸 이유가 없다</li>
</ul>
<p>찾아보니 OOP 방식의 간단한 구현체도 보임</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/youngj/httpserver">A simple HTTP server</a></li>
<li>아마도 위의 저 간단한 서버로 운영을 하다보면 겪을 수많은 고민이 담겨 있다(간단하게 구현 했음에도!)</li>
<li>하지만 내 수준에서 보면 너무 많이 구현해놓았으니, 간간히 안 풀릴 때 참고만 해보자</li>
</ul>
<h2 id="기본-기능"><a href="#기본-기능" class="headerlink" title="기본 기능"></a>기본 기능</h2><p>socket create&#x2F;bind&#x2F;listen까지는 가장 간단하게 구현된 놈을 쓰자.</p>
<p>최신 스타일로 하자면 stream_socket_server&#x2F;stream_socket_accept.</p>
<p>이제 main 스크립트 하나 돌리면서, 들어오는 스트림을 앞으로 만들 클래스 인스턴스로 넘겨주는 작업부터 본격 개발 시작이다.</p>
<p>구현할 기능</p>
<ul>
<li>요청 메시지 읽어들이기</li>
<li>메시지 파싱</li>
<li>리소스 접근<ul>
<li>config파일 활용<ul>
<li>document root, virtual host</li>
</ul>
</li>
</ul>
</li>
<li>응답 만들기<ul>
<li>응답 코드 &#x2F; 헤더 &#x2F; 본문을 어떻게 구성할 지 정한다</li>
</ul>
</li>
<li>응답&#x2F;로그</li>
</ul>
<h2 id="예상되는-변화"><a href="#예상되는-변화" class="headerlink" title="예상되는 변화"></a>예상되는 변화</h2><p>앞에서 언급한 대로 다중커넥션 처리</p>
<p>400&#x2F;500번 대 일부 구현</p>
<ul>
<li>400, 404, 500 정도 구현할까 싶은데</li>
<li>에러 페이지는 사치</li>
</ul>
<p>경로 조회 공격 방어 [<a target="_blank" rel="noopener" href="https://www.ibm.com/support/knowledgecenter/ko/SSB2MG_4.6.2/com.ibm.ips.doc/concepts/wap_path_traversal.htm">?</a>]</p>
<p>directory index</p>
<h2 id="저장소"><a href="#저장소" class="headerlink" title="저장소"></a>저장소</h2><p>GitHub : <a target="_blank" rel="noopener" href="https://github.com/youngiggy/phttp">https://github.com/youngiggy/phttp</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/09/22/mac-filename-normalization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/22/mac-filename-normalization/" class="post-title-link" itemprop="url">Mac에서 올린 한글 파일명(NFD 정규화) 문제</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-22 12:09:48" itemprop="dateCreated datePublished" datetime="2017-09-22T12:09:48+09:00">2017-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/09/22/mac-filename-normalization/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/22/mac-filename-normalization/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>이전 <a href="/2017/08/23/alphabetic-letter-validation/">유니코드를 다뤘던 글</a>을 올렸을 때 모던 PHP 그룹에서 댓글로 잠시 언급되었던,</p>
<p>NFD 정규화 문제.</p>
<p>맥에서 올린 파일이 다운로드 안된다는 VOC(고객의 소리)가 들어와서 원인 파악 겸 정리해봤다.</p>
<p>맥에서 ‘한글.txt’ 파일을 올리고 윈도에서 다운로드 받으면 ‘ㅎㅏㄴㄱㅡㄹ.txt’로 보이게된다.</p>
<p>유니코드 상에서 한글을 표현하는 방법은 첫가끝(처음가운데끝)이라고도 하는 한글 자모를 조합하는 방식과 완성형으로 표시하는 방법 등이 있다. </p>
<p>맥에서는 파일명을 저장할 때 NFD 방식. 즉, 한글 자모를 따로따로 받아 조합하는 방식으로 정규화를 하는데,</p>
<p>이 현상에 관해선 다른 분들이 열심히 글을 써주셨으니 더이상 설명하진 않겠다.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.asamaru.net/2016/11/15/php-nfd-to-nfc/">PHP에서 NFD(Normalization Form D) &#x2F; NFC(Normalization Form C) 변환</a></li>
</ul>
<h2 id="Normalizer-Class-설치"><a href="#Normalizer-Class-설치" class="headerlink" title="Normalizer Class 설치"></a>Normalizer Class 설치</h2><p>PHP 5.3부터 <a target="_blank" rel="noopener" href="http://php.net/manual/en/class.normalizer.php">Normalizer Class</a>를 사용할 수 있는데,</p>
<p>Internationalization Functions에 포함되어 이 확장 모듈을 설치해야 한다.</p>
<ul>
<li><p>이건 ICU 라이브러리의 wrapper인 관계로 ICU를 먼저 설치해야할 수 있다(libicu-devel , libicu 등)</p>
</li>
<li><p>Windows 시스템에선 php_intl.dll을 구해야하고, XAMPP를 쓴다면 모듈은 이미 ext에 존재할 것이다. </p>
</li>
<li><p>Linux 기반 시스템이라면</p>
<ul>
<li>apt-get install php-intl (for ubuntu-based linux)</li>
<li>yum install php-intl (for CentOS)</li>
<li>php7.x-intl 등 php 버전에 따라 다를 수 있으니 알맞게 설치할 것</li>
</ul>
</li>
<li><p>Mac에서 brew를 사용한다면 brew install php71-intl</p>
</li>
</ul>
<p>이후 php.ini에서 extension&#x3D;php_intl.(dll|so)을 활성화 시켜야 한다. 즉, 맨 앞의; 제거하기.</p>
<h2 id="처리-방법"><a href="#처리-방법" class="headerlink" title="처리 방법"></a>처리 방법</h2><p>잘 설치됐는지 확인해보자.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testNormalizer</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;-------------------------&#x27;</span> . PHP_EOL;</span><br><span class="line">    <span class="variable">$urlencodedInitialStr</span> = <span class="title function_ invoke__">urlencode</span>(<span class="variable">$str</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$str</span> . PHP_EOL;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">echo</span> ( <span class="title class_">Normalizer</span>::<span class="title function_ invoke__">isNormalized</span>(<span class="variable">$str</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_C</span>) ) ? <span class="string">&quot;normalized : FORM_C&quot;</span> : <span class="string">&quot;not normalized : FORM_C&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> ( <span class="title class_">Normalizer</span>::<span class="title function_ invoke__">isNormalized</span>(<span class="variable">$str</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_D</span>) ) ? <span class="string">&quot;normalized : FORM_D&quot;</span> : <span class="string">&quot;not normalized : FORM_D&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">$str</span> = <span class="title class_">Normalizer</span>::<span class="title function_ invoke__">normalize</span>(<span class="variable">$str</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_C</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;normalize to FORM_C : &#x27;</span> . <span class="variable">$str</span> . PHP_EOL;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;urlencoded before: &#x27;</span> . <span class="variable">$urlencodedInitialStr</span> . PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;urlencoded after~: &#x27;</span> . <span class="title function_ invoke__">urlencode</span>(<span class="variable">$str</span>) . PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$name1</span>=<span class="string">&#x27;recruit/recruit/201709/21/owlupr_58qh-1meg1s6_recruit.pdf&#x27;</span>;<span class="comment">//일반 ASCII 문자열</span></span><br><span class="line"><span class="variable">$name2</span>=<span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%E1%84%86%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3_%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%8B%E1%85%B5%E1%84%82%E1%85%A6.pdf&#x27;</span>);<span class="comment">//NFD로 정규화된 파일명을 urlencode해서 받을 경우</span></span><br><span class="line"><span class="variable">$name3</span>=<span class="string">&#x27;테스트.pdf&#x27;</span>;<span class="comment">//일반 한글 문자열</span></span><br><span class="line"> </span><br><span class="line"><span class="title function_ invoke__">testNormalizer</span>(<span class="variable">$name1</span>);</span><br><span class="line"><span class="title function_ invoke__">testNormalizer</span>(<span class="variable">$name2</span>);</span><br><span class="line"><span class="title function_ invoke__">testNormalizer</span>(<span class="variable">$name3</span>);</span><br></pre></td></tr></table></figure>

<p>결과는</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-------------------------</span><br><span class="line">recruit/recruit/201709/21/owlupr_58qh-1meg1s6_recruit.pdf</span><br><span class="line">normalized : FORM_C</span><br><span class="line">normalized : FORM_D</span><br><span class="line">normalize to FORM_C : recruit/recruit/201709/21/owlupr_58qh-1meg1s6_recruit.pdf</span><br><span class="line">urlencoded before: recruit%2Frecruit%2F201709%2F21%2Fowlupr_58qh-1meg1s6_recruit.pdf</span><br><span class="line">urlencoded after~: recruit%2Frecruit%2F201709%2F21%2Fowlupr_58qh-1meg1s6_recruit.pdf</span><br><span class="line"></span><br><span class="line">-------------------------</span><br><span class="line">맥에서테스트_중이네.pdf</span><br><span class="line">not normalized : FORM_C</span><br><span class="line">normalized : FORM_D</span><br><span class="line">normalize to FORM_C : 맥에서테스트_중이네.pdf</span><br><span class="line">urlencoded before: %E1%84%86%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A6%E1%84%89%E1%85%A5%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3_%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%8B%E1%85%B5%E1%84%82%E1%85%A6.pdf</span><br><span class="line">urlencoded after~: %EB%A7%A5%EC%97%90%EC%84%9C%ED%85%8C%EC%8A%A4%ED%8A%B8_%EC%A4%91%EC%9D%B4%EB%84%A4.pdf</span><br><span class="line"></span><br><span class="line">-------------------------</span><br><span class="line">테스트.pdf</span><br><span class="line">normalized : FORM_C</span><br><span class="line">not normalized : FORM_D</span><br><span class="line">normalize to FORM_C : 테스트.pdf</span><br><span class="line">urlencoded before: %ED%85%8C%EC%8A%A4%ED%8A%B8.pdf</span><br><span class="line">urlencoded after~: %ED%85%8C%EC%8A%A4%ED%8A%B8.pdf</span><br></pre></td></tr></table></figure>

<p>소스에는 아래와 같이 적용 해놓으면 된다.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">class_exists</span>(<span class="string">&#x27;Normalizer&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Normalizer</span>::<span class="title function_ invoke__">isNormalized</span>(<span class="variable">$filename</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_D</span>)) &#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="title class_">Normalizer</span>::<span class="title function_ invoke__">normalize</span>(<span class="variable">$filename</span>, <span class="title class_">Normalizer</span>::<span class="variable constant_">FORM_C</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>파일명을 DB에 입력할 때 NFC로 넣는 것이 깔끔하겠지만,<br>이미 NFD 정규화된 파일명이 들어가있다면, 다운로드 시에도 파일명을 바꿔주면 된다.</p>
<h3 id="한숨"><a href="#한숨" class="headerlink" title="한숨"></a>한숨</h3><p>이 밖에 파일 다운로드 관련 코드를 보면 별별 예외처리가 많이 들어가 세월의 흔적을 느낄 수 있다.</p>
<p>IE라면 파일명을 또 MS949로 변경해줘야 해야만 한다.<br>OS 별로 <a target="_blank" rel="noopener" href="https://ko.wikipedia.org/wiki/%ED%8C%8C%EC%9D%BC_%EC%9D%B4%EB%A6%84">파일명에 들어갈 수 있는 특수문자</a>도 다르다.<br>기타 등등.</p>
<p>특정 OS는 점유율이 낮아서, 시스템이 낡아서, 인력이 부족해서, 개발자 역량이 부족해서, 지금은 더 급한 게 있어서…<br>cross-platform 대응은 항상 어렵다.</p>
<h3 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h3><ul>
<li><a target="_blank" rel="noopener" href="http://php.net/manual/en/class.normalizer.php">http://php.net/manual/en/class.normalizer.php</a></li>
<li><a target="_blank" rel="noopener" href="http://php.net/manual/en/intro.intl.php">http://php.net/manual/en/intro.intl.php</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.asamaru.net/2016/11/15/php-nfd-to-nfc/">https://blog.asamaru.net/2016/11/15/php-nfd-to-nfc/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dotkernel.com/php-troubleshooting/where-is-the-intl-php-extension-problem-solved/">https://www.dotkernel.com/php-troubleshooting/where-is-the-intl-php-extension-problem-solved/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/09/18/book-979-11-85890-85-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/18/book-979-11-85890-85-2/" class="post-title-link" itemprop="url">독후감 - 클린 소프트웨어</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-18 22:50:30" itemprop="dateCreated datePublished" datetime="2017-09-18T22:50:30+09:00">2017-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-03-04 23:01:26" itemprop="dateModified" datetime="2018-03-04T23:01:26+09:00">2018-03-04</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/09/18/book-979-11-85890-85-2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/18/book-979-11-85890-85-2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://image.kyobobook.co.kr/images/book/large/852/l9791185890852.jpg" alt="클린 소프트웨어"></p>
<p>이 책에 인쇄된 문자를 거의 다 읽긴 했으나,<br>내가 이 책을 읽었다고 할 수 있을까 생각이 드는 책이다.</p>
<p>목차</p>
<ul>
<li>PART 1 애자일 개발 </li>
<li>PART 2 애자일 설계</li>
<li>PART 3 급여 관리 사례 연구</li>
<li>PART 4 급여 관리 시스템 패키징</li>
<li>PART 5 기상 관측기 사례 연구</li>
<li>PART 6 ETS 사례 연구</li>
<li>APPENDIX A UML 표기법 I: CGI 예제</li>
<li>APPENDIX B UML 표기법 II: 스태트먹스</li>
<li>APPENDIX C 두 기업에 대한 풍자</li>
<li>APPENDIX D 소스 코드는 곧 설계다</li>
</ul>
<p>먼 나라 이야기라고 생각이 드는 PART 1에서 작은 고민을 얻어왔다면</p>
<p>PART 2에서는 SOLID 원칙을 제대로 이해하기 위한 색다른 관점이 좋았고(그런데 10여 년 전에 출간된 이 책을 두고 색다르다고 해도 실례가 안 되려나).</p>
<p>PART 3부터 익숙치 않은 C++ 문법과 더 익숙치 않은 UML 문법 때문에 눈이 뻑뻑해지기 시작했는데, 결국 부록의 UML 표기법을 먼저 보고올 수 밖에 없었다. 그런데 이 책을 읽는데 별로 도움 안되는 것 같고, 그냥 간단한 규칙 정도만 찾아보고 책을 한번 더 읽는 것이 좋겠다는 생각이 들었다. 아무래도 밥아저씨의 UML 책을 읽어야겠구나 싶을 정도로 UML로부터 설계를 해나가는 모습이 꽤 매력적으로 느껴졌다(현실은 시궁창일 걸 알면서 말이다). </p>
<p>PART 4는 방금 늪에서 빠져나온 여우마냥 숨 좀 고를 수 있는 챕터였지만, PHP&#x2F;JavaScript를 쓰는 상황에서 패키징에 대한 글을 읽자니 남일 같아서 마음이 편했다.</p>
<p>PART 5에선 PART 3의 급여 관리 사례와 비슷한 포맷이긴 한데, 일단 급여 관리에서 빠져나와 새 인생을 시작한 기분이었으므로 나름 재미있게 읽었던 것 같다.</p>
<p>PART 6도 완벽하게 이해는 못했지만 다시 읽으면 그럭저럭 이해는 될 것 같긴 하다.</p>
<p>APPENDIX B는 전혀 모르겠고..</p>
<p>APPENDIX C가 꽤 인상적이었다. 두 기업에 대한 풍자라고 하는데, 왼쪽엔 그지같은 기업, 오른쪽엔 이상적인 기업을 나란히 덧대어 놓았다. 그동안 왼쪽같은 문화에서만 살았고(그리고 아마 10월부터 또 겪어야 할텐데..), 오른쪽같은 문화를 꿈꾸지만 경험은 없는 상태. 이 책을 힘겹게 읽으면서 좀 지쳤는데, 이 부록을 읽으며 다시 전의가 불타올랐다(하지만 이제 곧 잘 시간). 조금이라도 시도해 보리라 다짐을 해봤다(현실은 시궁창일 걸 알면서 말이다).  </p>
<p>APPENDIX D도 너무 좋았다. 10년 전에 쓴 이 책에 10년 전에 썼다는 글을 소개한 내용인데, 공학에서의 최종 결과물은 문서가 되어야 하고, 소프트웨어 공학에서의 문서라 함은 코드 자체라는 주장이다. 그냥 자기계발서 같은 글인가 싶었는데, 이 양반은 진심이었고 다 읽고 나선 진심 공감이 됐다.   </p>
<h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>다시 읽어야 한다.</p>
<p>읽기 시작하면서부터 몇 번을 다시 읽어야 할까 생각이 들었던 책이다. 지금 바로 다시 읽어야 이 책을 읽기나 했다고 어디가서 얘기라도 할텐데…</p>
<p>내년에 다시 읽어보기로 했다. 누구 안 주고 책장에 잘 모셔두고 내년 초에 다시 읽어보겠다.</p>
<p>실무에서 좀 더 부딪혀보고, 실습해보고, 다시 보면 이해하는 폭이 더 넓어지리라 생각이 든다(현실은 시궁창일 걸 알면서 말이다).</p>
<h2 id="원몰띵"><a href="#원몰띵" class="headerlink" title="원몰띵"></a>원몰띵</h2><p>이런 책을 읽으면서 항상 느끼는 거지만…</p>
<p>테스트가 주도하지 않고도 제대로된 소프트웨어를 만드는 게 가능이나 한가…뭐 그런 생각이 든다.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://haah.kr/2017/09/18/book-978-89-6262-115-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngiggy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha-ah">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ha-ah">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/18/book-978-89-6262-115-0/" class="post-title-link" itemprop="url">독후감 - 세상물정의 물리학</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-18 22:26:33" itemprop="dateCreated datePublished" datetime="2017-09-18T22:26:33+09:00">2017-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2018-02-13 15:27:02" itemprop="dateModified" datetime="2018-02-13T15:27:02+09:00">2018-02-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2017/09/18/book-978-89-6262-115-0/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/09/18/book-978-89-6262-115-0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://image.kyobobook.co.kr/images/book/large/150/l9788962621150.jpg" alt="세상물정의 물리학"></p>
<p>6월 말에 개발과 관련없는 책을 읽어보려고 집어왔던 책.<br>올해 8월 제천 영화제에 들고가서 조금 읽고 왔던 책.</p>
<p>그 당시 감상으로 ‘좌파 교수(좋은 의미로)가 쓴 책’ 정도로 이야기 했지만,<br>그건 정말 초반에 (의도는 좋지만 &#x3D; 선하지만) 재미가 없어서 했던 말이었다.</p>
<p>이번에 날씨가 너무 좋아 점심시간에 책보러 카페로, 작은 공원(?)으로 다니며 읽었는데, 이번엔 또 너무 재미있는 거다. </p>
<p>책은 세 챕터로 나뉘는데,</p>
<ol>
<li>‘지금 여기’를 말하는 사회물리학의 세계</li>
<li>복잡한 세상을 꿰뚫어 보는 통계물리학의 아름다움 </li>
<li>물리학자는 세상물정을 모른다고?</li>
</ol>
<p>두번째 챕터부터 신나게 읽었던 것 같다.</p>
<p>작은 호기심을 증명해내고야 마는 집념.<br>이전에 읽었던 책 ‘아이의 사생활’에 비해 근거로 충만하고 같이 실험했던 사람들의 이름도 꼬박꼬박 넣어주는 친절함.<br>은근 코드가 맞는 개그감.<br>최대한 이해하기 쉽게 설명하는 물리 개념.<br>그리고 과학자로서의 열정과 자부심을 드러내는 지점에선 일부 공감과 반성을 하곤 했었다. </p>
<p>글을 굉장히 잘 쓰신다.<br>요즘 나는 기술책만 너무 많이 보다 눈높이가 꽤 낮아진 관계로…<br>문학을 즐기는 분들이 보기엔 어떨지 모르겠다.<br>하지만 (과연 이게 칭찬이 될 지는 모르겠지만) 이공계 중에선 수준급이다! </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/9/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/11/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">youngiggy</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  




  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"youngiggy-github-io","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
